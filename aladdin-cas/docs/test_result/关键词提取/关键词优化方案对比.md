# 需求

目前pandora服务的各个子模块的性能：

| 模块名           | wps(words per second) |
| ---------------- | --------------------- |
| 自定义敏感词识别 | 1.3M                  |
| 非法文本分类     | 700K                  |
| 关键词提取       | 13K                   |

可见关键词提取功能的性能相较于其它两个模块是十分缓慢的，成为了pandora服务的一大短板，因此必须要对关键词提取模块进行优化。

# 优化方案

## 方案1：

​	经分析关键词提取功能的速度慢主要是因为调用了结巴分词的posseg.dt.cut接口。该接口接受一个文本型参数，返回组成文本的每一个词与词的词性(动词，名词，形容词...)。但该接口速度十分缓慢，是结巴分词的另一个接口jieba.cut精确分词模式速度的十分之一都不到，因此可以考虑用jieba.cut精确分词替换掉posseg.dt.cut。

对比jieba.cut与posseg.dt.cut接口：

| 接口          | 参数                 | 返回值         |
| ------------- | -------------------- | -------------- |
| posseg.dt.cut | 文本字符串           | (词、词性)列表 |
| jieba.cut     | 文本字符串，分词模式 | 词列表         |
|               |                      |                |

关键词提取一般只提取名词、动词、动名词而忽略形容词、副词等，因此使用jieba.cut精确分词后还必须要查询每一个词的词性。结巴分词库中有一个含有35万词的词典，词典中标识了每一个词的词性，因此使用jieba.cut + 词性查询的方案完全可行。

​	缺陷：无法提取出词典中不存在词，尤其是地名、人名等。

## 方案二：

​	比方案一更快的办法就是使用结巴分词的全模式分词，该分词速度是精确分词模式速度的2倍以上，因此速度。方案一包含了方案一的所有缺点，同时精确度也不如方案一。

## 方案三：

​	更快的方案就是使用AC自动机，把结巴分词的默认词库中的所有动词、名词、动名词构建成一个搜索树，用该搜索树来直接查找文本中的动词、名词、动名词。该方案的速度理论上应该能达到其它两个模块的速度，缺陷同方案二。

# 方案测试

使用1.3M的文本对所有方案进行测试，测试环境使用k8s部署的但副本pandora容器服务。

| 方案     | 耗时(s) | wps(words per second) | top10关键词                                       |
| -------- | ------- | --------------------- | ------------------------------------------------- |
| 方案一   | 11.7    | 120k字/s              | 父亲,做工,沙地,鸟雀,东西,胯下,厨房,西瓜,项圈,短棒 |
| 方案二   | 3.96    | 330k字/s              | 父亲,不知,做工,沙地,东西,西瓜,鸟雀,胯下,祭器,厨房 |
| 方案三   | 2.1     | 650k字/s              | 父亲,沙地,不知,东西,西瓜,厨房,胯下,短棒,大竹,五色 |
| 原始方案 | 174     | 7.5k字/s              | 父亲,做工,沙地,西瓜,东西,鸟雀,厨房,胯下,支起,项圈 |
| 结巴     | 156     | 8.3k字/s              | 父亲,知道,时候,做工,胯下,刺猬,看见,短棒,头戴,紫色 |

任意两个方案间的相同关键词数：

| 方案\相同关键词个数\方案 | 方案一 | 方案二 | 方案三 | 原始方案 | 结巴 |
| ------------------------ | ------ | ------ | ------ | -------- | ---- |
| 方案一                   | 10     | 8      | 7      | 9        | 3    |
| 方案二                   | \      | 10     | 7      | 8        | 3    |
| 方案三                   | \      | \      | 10     | 6        | 3    |
| 原始方案                 | \      | \      | \      | 10       | 3    |
| 结巴                     | \      | \      | \      | \        | 10   |



# 总结

- 三个优化方案相比于原始方案，速度分别提高了15、40、80倍。
- 三个优化方案提取的前10个关键词与原始方案相比都有一半以上是相同的。
- 三个优化方案与结巴自带内置方法的效果差异较大，前10个关键词都只有3个相同的。
- 测试的文章是鲁迅的《少年闰土》，但所有的方案都没有提取到最重要的关键词“闰土”，原因是结巴的词库中没有这个词。