(最佳实践)(最佳实践)	AnyBackup5.0.2.0最佳实践LotusDominoServer定时备份目　录目　录	2第一章概览	41.1简介	41.1.1DominoServer备份	41.1.2DominoServer恢复	51.1.3任务管理	51.1.4重复数据删除	5第二章系统要求	62.1应用	62.2操作系统	62.3硬盘驱动器	72.4处理器	72.5其他	7第三章支持的功能	8第四章入门	94.1安装部署	94.1.1安装位置	94.1.2开始之前	94.1.3安装	94.2配置	164.2.1介质服务器配置	164.2.2客户端配置	164.3备份	174.3.1DominoServer定时备份最佳实践	174.4恢复	214.4.1恢复注意事项	214.4.2恢复步骤	23第五章FAQs	27第六章备份故障排除	29备份成功但有警告信息	29备份失败	30第七章恢复故障排除	32恢复成功但有警告信息	32恢复失败	34第一章概览1.1简介本文档是爱数备份容灾家族LotusDominoServer一体化备份恢复最佳实践文档，主要描述了如何正确地使用爱数备份容灾家族产品成员进行LotusDominoServer数据备份的方法，包括部署前后的注意事项和典型部署方案。IBM的DominoServer产品是业界实际上的群件标准，在协作平台市场上占据了绝对优势。多年来，我们国内利用LotusDominoServer软件平台开发的企事业单位办公自动化系统遍布各个行业，呈现一片“莲花盛开”的盛景，使得Lotus软件名声远播。LotusDominoServer包括DominoServer服务器和Notes客户端。爱数产品属于c/s架构，运用了DominoServer的在线备份方式。其中，在线备份包括两种备份类型：完全备份、增量备份。1.1.1DominoServer备份1.1.2DominoServer恢复1.1.3任务管理1.1.4重复数据删除1.1.1DominoServer备份完全备份将选定的数据源完全备份到指定目的地的备份集中。每次执行时，它不会根据最新的变动比较后进行备份，而是直接将所有的数据备份到OFS介质中，并产生一个时间点，用于记录备份的类容。DominoServer完全备份时不备份归档日志文件，但是会对其进行归档。增量备份是基于上一次完全备份，把数据源备份到OFS介质中，只备份文件内容有变动以及新增的文件，从而避免完全相同的文件重复的备份，同时产生一个时间点，以便恢复使用。在尚未进行完全备份的情况下，进行增量备份时会自动转会为完全备份。出现以下情况之一的文件增量备份时会进行备份·对比上次的备份记录，普通文件的大小或最后修改时间发生了变化，将进行备份·对比上次的备份记录，数据库文件的内容大小或最后修改时间发生了变化，将进行备份·对比上次的备份记录，数据库文件的DBIID发生了变化，将进行备份·新增的归档日志文件将进行备份,并在备份完之后，将已备份的日志进行归档1.1.2DominoServer恢复通过浏览恢复，恢复备份时间点。1.1.3任务管理1.【命名规则】:用户名、任务组、任务等对象命名规则满足：不允许为空，且名称长度必须为3~50个字符；2.【邮件命名规则】:Email地址只能由字母A~Za~z、数字0~9及特殊字符@.-_组成，类似于yourname@domain.com的形式，且最长不能超过50个字符；3.【备注信息规范】：备注信息最大不超过255字符；1.1.4重复数据删除本版本支持重复数据删除第二章系统要求2.1应用支持的DominoServer版本：·DominoServer8.5·DominoServer7·DominoServer6.52.2操作系统支持的操作系统：·WindowsServer2008MicrosoftWindowsServer2008版本·WindowsServer2003MicrosoftWindowsServer2008版本·WindowsServer2012MicrosoftWindowsServer2008版本·Redhat6Redhat6-2.6.32-32bit版本·Redhat5Redhat6-2.6.17-32bit版本·SUSELinuxLinux-2.6.65-32bit版本2.3硬盘驱动器安装软件需要最小265MB的磁盘空间。2.4处理器支持所有Windows、Linux兼容的处理器。2.5其他第三章支持的功能下表列出了DominoServer定时备份模块所支持的功能。	功能	子功能	支持	备注	备份类型	完全备份	√			增量备份	√		循环备份		√	完全备份、增量备份相结合的循环	客户端自动搜索实例		√		浏览恢复		√		异机恢复		√		恢复粒度		√	整个实例、部分文件	恢复位置		√	原位置或其它相同配置的LotusDominoServer	灾难恢复		√	限制性列表如下：·不支持DominoServer数据库跨版本进行恢复。·不支持对同一数据源同时创建多个备份任务。·不支持DominoServer分区服务器、DominoServer双机、集群的备份和恢复。·目前只支持相同操作系统下的异机恢复。异机恢复时候，建议使用同样的环境（同样的DominoServer安装目录与数据目录，同样的日志存放路径）。·不支持DominoServer离线情况下的备份操作。·不支持DominoServer在线情况下的恢复操作。第四章入门4.1安装部署4.1.1安装位置当您成功完成客户端的安装后，装有DominoServer的机器即可作为客户端连接至Anybackup控制台。您可通过控制台页面中【运营管理】->【客户端管理】查看客户端连接情况。4.1.2开始之前1、客户端包括32-bit和64-bit两种类型，如果您使用的数据库为32-bit版本，则您应该使用32-bit的客户端；如果您使用64-bit的数据库，您应该使用64－bit的客户端。2、linux环境下，安装客户端时，建议用root登录系统并安装。根据具体linux的内核的版本，选择对应的客户端。4.1.3安装Windows客户端安装方法确定客户端安装包，需要确定用户环境中操作系统的位数以及数据库的位数，同时对于少数用户出现在64bit的操作系统上安装32bit的数据库的情况，需要安装和数据库位数相同的包，即需要安装32bit的客户端安装包：1.Windows环境确认在cmd下使用systeminfo命令查看系统位数、版本2.DominoServer环境确定1.在服务器的控制台上，键入shstatserver，有一项参数为"Server.Version.Architecture"，表明了DominoServer是否为64位。，如图所示：以上说明是32bit的DominoServer服务器3.Windows客户端安装1.双击windows客户端安装程序，进入安装向导界面2.点击下一步，指定安装路径3.点击下一步，输入服务器端IP4.点击下一步，选择是否安装iSCSIInitator工具和卷CDP驱动注意：当前系统非2000、2003或xp系统，iSCSI选项不可选，若是在2000,2003或者XP系统安装客户端，备份恢复DominoServer可以默认不勾选。定时备份恢复不需要安装卷CDP驱动。5.点击下一步进行安装，直至完成注意：windows下客户端卸载后，会提示重启，不重启对应用无影响，但下次再次安装会造成一定影响，如安装失败，尤其是当安装cdp驱动时Linux下客户端安装方法1.Linux环境确定位数判断：在shell环境下输入：arch命令或者getconfLONG_BIT如图所示：版本确定：使用cat/etc/issue即可如图所示：2.DominoServer环境判断同windows判断方法3.Linux安装方法1.登录到客户端所在的机器，将客户端安装包拷贝到指定位置2.解压安装文件，例如tarzxvfAnyBackupClient_Redhat_5_i386-5.0.1.0-20140725-release-2373.tar.gz3.进入解压后的目录，执行安装步骤，如下图所示请注意：1.DominoServerDatabaseInstallPath和DominoServerDatabaseDataPath两个路径必须正确2.两个路径最后不能以/结尾3.安装路径最后的目录名为lotus4.数据路径最后的目录名为notesdata5.6和7中的路径，都以DominoServer安装时的默认路径为例，如DominoServer安装时指定了别的路径，视情况变动6.目前版本linux客户端已屏蔽掉卷CDP驱动安装选项4.2配置4.2.1介质服务器配置为保证备份任务可正常执行，在创建DominoServer备份任务前，请检查介质服务器是否正常。进入【介质服务器配置】-【磁盘管理】查看卷是否正常。4.2.2客户端配置暂无4.3备份	哪些内容会进行备份？	哪些内容不会进行备份？	初始化配置文件，标志文件，高速缓存文件，邮箱配置文件，.nsf格式的数据库文件，.ntf格式的模版文件，.txn格式的归档事务日志文件，DAOS文件	4.3.1DominoServer定时备份最佳实践备注：windows和Linux只有恢复端的操作系统不一致，控制台的操作步骤一样。故具体的备份流程均可参考下述恢复步骤。1、登录管理控制台，点击标签栏【数据保护】【备份管理】选项卡，在操作界面，选择【定时备份】，点击【新建】，在弹出的【新建任务向导】中填写任务基本信息，点击【下一步】。2、根据需要选择任务策略，默认备份策略均为未选中状态，点击【下一步】。选择数据源注：(1)当DominoServer服务器启用了DAOS功能，则数据源中会多出一个选项“合并的附件与对象”，如下图所示；如服务器未启动DAOS功能则不显示此选项。（2）无论归档日志模式启动与否，归档事务日志文件均不在数据源中显示。5.计划的推荐配置。在爱数产品中，有多种任务计划可以进行选择，比如每天、每周、每月，或者是当客户端开机、关机、联网时。设置方法如下：进入任务设置计划向导，选择备份类型、备份计划、开始时间。继续添加计划或者修改、删除计划计划设置特别推荐：为了更好的保护您的DominoServer，我们提供最佳备份策略，建议实施人员根据实际情况设置。策略如下：1.对于生产数据库，每周做一次完全备份，每天做一次增量备份，备份开始时间尽量在服务器空闲时间段。2.若数据库数据不多或空间允许，可以每周做两次完全备份，视用户的环境而定。3.可保留一个月的数据库，即保留4个完全备份副本。6.计划设置完毕，如果资源足够，请立即开始一次完全备份。选中任务，点击【启动】按钮，选择需要的执行类型，点击【备份】按钮，即可开始备份操作4.4恢复4.4.1恢复注意事项如果原DominoServer环境已损环（硬件损坏或系统损坏等），需要先搭建DominoServer服务环境。按照原来的目录结构安装好DominoServer服务，不要启动服务。若要恢复正在被使用的DominoServer数据库，请先停止DominoServer服务，然后再进行恢复。Linux下恢复正在被使用的DominoServer数据库暂无提示，恢复前请务必注意停止DominoServer服务。若恢复后任务完成后发现未停止DominoServer服务，请关闭DominoServer服务后再次重新进行恢复。请按照以下类型进行数据恢复：1.备份数据中包含归档事务日志文件的恢复1.关闭DominoServer服务2.清空事务日志目录下的所有旧文件，或者将其转移3.打开控制台网页，浏览并选择需要恢复的数据·选择恢复事务日志时，要么全选，要么一个都不要选·可以将数据恢复至原位置或新位置·恢复至新位置，会导致数据库的DbIID改变，它对DominoServer来说，已经与原来的数据库不是同一个数据库了，只是含有一些相同的数据·恢复数据库类型的文件时（单个，多个或全部），需要同时选择恢复事务日志，这样才能将它们恢复到最接近的状态4.执行恢复。5.启动DominoServer服务。6.恢复完成之后，启动一次服务，建议马上再执行一次新的全备。2其他情况下的恢复未开启事务日志的DominoServer服务，或者线性、循环事务日志模式下，只需要关闭服务，然后执行数据恢复即可。恢复完成之后，即可启动服务。建议恢复完后执行一次新的全备。3异机恢复备注：1.Linux下做异机恢复，请先新建目录，并将此目录用户变为notes，再将数据恢复至此目录下2.若归档事务日志文件目录、DAOS文件目录在非数据文件路径下，请新建归档事务日志文件目录、DAOS文件目录（与A机器目录保持一致），并将用户变为notes3.若本机有链接目录，请参照原机在异机建立好相同的链接目录。4.恢复到异机指定位置后的数据将按照下述格式进行存放：·数据目录下的数据，恢复至指定目录之下，并按原来在数据目录之下的方式一样组织目录·若归档事务日志路径为默认路径，则恢复后，日志目录不变，即位于logdir目录下；若事务日志路径为自定义目录，则恢复至指定目录之下的__TRANS_LOG__目录之下·若DAOS路径为默认路径，则恢复后，DAOS目录不变，即位于DAOS目录下；若DAOS路径为自定义目录，DAOS恢复至指定目录之下的__DAOS__目录之下，并按原样组织目录·链接目录恢复至指定目录之下的__LINKS_DIR__目录之下，也同样按原相组织目录5.linux下异机恢复完成后，拷贝文件至异机DominoServer目录下，请注意拷贝后的文件的属主，尤其是相对于异机中新增的文件。否则可能会导致配置完成后某些数据库打开失败的情况。·异机恢复步骤：（未带事务日志）1.在B机器上安装好anybackup客户端2.在B机器上安装好DominoServer，不要进行配置，也不要启动服务3.对A机上的DominoServer数据进行备份4.浏览恢复，指定异机，恢复至B机器上的一个指定目录（不要为DominoServer数据目录）5.复制B机器上指定目录中的全部数据，至DominoServer数据目录中对应位置6.启动DominoServer服务7.安装notes客户端，并进行配置，连接至B机器上的DominoServer恢复完成之后，B与A机器上的数据库会拥有相同的数据异机恢复步骤：（带事务日志）1.在B机器上安装好anybackup客户端2.在B机器上安装好DominoServer，设置成归档日志模式，然后重启服务，使设置生效（注意：要与原机事务日志记录位置保持一致），关闭机器，清空B机器上的日志文件3.对A机上的DominoServer数据进行备份4.浏览恢复，指定异机，恢复notes.ini文件至B机器上的相同位置5.恢复所有文件至B机器上的指定目录（不要为DominoServer数据目录）6.复制B机器上指定目录中的全部数据，至DominoServer数据目录中对应位置7.启动B机器上的DominoServer服务8.重装notes客户端，并进行配置，连接至B机器上的DominoServer恢复完成之后，B与A机器上的数据库会拥有相同的数据4.4.2恢复步骤备注：windows和Linux只有恢复端的操作系统不一致，控制台的操作步骤一样。故具体的恢复流程均可参考下述恢复步骤。1.点击【任务管理】中的【发起】，在恢复页面中选择要恢复数据源。2.点击【恢复】按钮，选择要恢复的时间点及数据注意：如果是要恢复到最新状态，推荐选择最新时间点。因为在多次恢复过程中，其他时间点恢复到最新状态的日志被截断，恢复成功的数据实际上是当时备份的数据，并不是最新的。3.选择恢复位置，默认为恢复至原客户端原位置此处，可以选择恢复至其他位置可以浏览选择指定客户端下的恢复路径4.选择好恢复位置后，点击完成按钮即可开始恢复。第5章FAQs1、客户端包括32-bit和64-bit两种类型，如果您使用的数据库为32-bit，则您只能使用32-bit的客户端；如果您使用64-bit的数据库,您只能使用64－bit的客户端。2、LotusDominoServer数据恢复时，请关闭DominoServer服务。3、如果notes.ini文件损坏或丢失，请先将此文件恢复，然后再恢复其他文件或整个实例。4、LotusDominoServer数据库开启事务日志且设置为归档模式情况下，才能对归档日志进行备份。且只备份那些已经满足归档要求的日志文件，不对活动日志进行备份。非归档模式下，事务日志不进行备份。处于活动日志中的数据不能被恢复。5、DAOS相关文件，也只有DominoServer服务开启了DAOS功能，才会显示。DAOS相关文件，也是整体性的，不能展开。6、选择了备份整个DominoServer服务器，默认也选择了备份事务日志与DAOS相关文件。但在具体备份时，只有满足备份条件，它们才会进行备份。7、备份过程中，如果DominoServer服务器本身更改了事务日志或DAOS的设置，则以备份时的状态为准。不建议在备份时更改这些设置。8、不支持对同一数据源同时创建多个备份任务。9、每次定时备份成功执行，都会生成一个新的时间点。即使没有备份任何文件，备份的总大小为0kb,时间点也会产生。10、目前只支持DominoServer单机单个服务器的备份恢复，不支持DominoServer分区服务器、DominoServer双机、集群的备份和恢复。11、目前只支持相同操作系统下的异机恢复。异机恢复时候，建议使用同样的环境（同样的DominoServer安装目录与数据目录，同样的日志存放路径）。12、恢复完成之后，特别是带归档日志的恢复，必须在恢复完成之后，启动一次服务，才能继续下次的备份，因为刚恢复完成，有些数据的状态还是不对的，必须启动一次服务，让DominoServer自动调整回来。否则，可能会造成数据的状态不正确，甚至备份数据恢复失败，此时间点不可用。13、目前只支持DominoServer数据库在线情况下的备份，离线情况下备份DominoServer数据库可能会导致执行进程崩溃等问题。14、Linux下DominoServer的恢复，恢复策略仅支持“总是替换已经存在的文件”，当恢复时选择“仅替换变化的文件”，恢复中会给出提示信息并自动转化为替换已经存在的文件。15、DominoServer7版本的32位，只能支持以系统服务方式启动的情况下进行备份。第六章备份故障排除备份成功但有警告信息·Q：在任务备份过程中提示文件信息获取失败，文件将不会备份，见图:错误原因：当有数据库中有部分文件损坏的情况下备份中会给出提示信息并将跳过此文件进行备份。解决方法：请检查该文件是否正常可用。Q:windows下DominoServer定时备份过程中，杀死eefprocess进程后再次执行备份部分文件备份失败问题原因：杀掉eefprocess进程时，对数据库文件备份只完成了加锁，没有解锁，再次备份，发现文件锁上了，就会报错，该文件备份失败，但是在任务退出前会对文件执行解锁，相当于进行了自动修复。解决方法：再次进行备份。备份失败Q：提示执行出错，加载DominoServer组建失败，请检查是否正确安装DominoServer软件、配置正确环境变量、或客户端位数与DominoServer位数不一致错误原因：客户端版本与DominoServer版本不一致解决方法：请检查DominoServer数据库的位数与客户端位数是否一致，如果您安装的是32位的DominoServer，您只能安装32位的客户端，如果您安装的是64位的DominoServer，您只能安装64位的客户端。Q:灾难恢复后，用户数据库未恢复回来，且有一个mail目录和一个mail链接目录。问题原因：备份数据中，mail作为链接目录处于其他位置。灾难恢复前，新部署好的环境中mail目录仍然存在。Q:linux下DominoServer定时备份过程中，杀死eefprocess进程后再次执行备份，备份失败问题原因：杀掉eefprocess进程时，对数据库文件备份只完成了加锁，没有解锁，再次备份，发现文件锁上了，就会报错，任务失败，但是在任务退出前会对文件执行解锁，相当于进行了自动修复。解决方法：再次进行备份。注意：再次备份时，会对文件是否加锁做检查，如果加上锁，会导致任务失败，但是会在任务失败退出前做解锁操作。当再次执行任务时，任务可以正常执行。第七章恢复故障排除恢复成功但有警告信息Q：某次恢复有事务日志文件的数据，用户邮箱中个别邮件出现相同的两封问题原因：（1）发邮件的时候，邮件进入了mail.box，然后这个事件被放到了一个快满的日志文件001中；（2）邮件发完了，需要删除掉mail.box中的这个邮件。这个事件放到了一个新的日志文件002中（3）备份的时候，由于001达到了备份要求，日志进行了备份，002因为没有达到要求而没有备份（4）恢复的时候，最后日志回滚001，将已发送的邮件又放入到了mail.box中重执行一次。但是由于002日志已丢失，将邮件从mail.box中发送出去然后从mail.box中删除的操作没有重做，所以邮件留在了mail.box中（5）恢复完成，启动DominoServer服务，发现mail.box中还有未发出去的邮件，就把它发出去了，造成了邮件被发送了两次解决方法：此问题出现的条件比较苛刻，即使此问题出现，恢复后不会造成有大量重复邮件的现象，建议用户将此重复邮件删除。Q：DominoServer定时备份恢复-DominoServer恢复之后，DominoServerServer服务重启提示错误1053。错误描述：恢复后，启动DominoServer服务提示服务没有及时响应启动或控制请求。解决办法：恢复时必须先关闭DominoServer服务在进行恢复，可避免恢复时，造成DominoServer服务无法启动。如果出现此种情况，可对任务管理器或在终端中手动中止DominoServer相关的所有进程，DominoServer服务即可正常启动。Q：DominoServer定时备份恢复-DominoServer恢复之后，notes、Admin客户端启动提示打开窗口时出错。错误描述：notes客户端未正常关闭（win7或2008下弹出对话框，该程序无响应，是否关闭，点击关闭），而系统中残留notes的相关进程造成的。解决办法：任务管理器中结束nlnotes.exe与ntaskldr.exe两个进程，再启动客户端，可正常打开notes、admin客户端，并正常使用。Q:灾难恢复后，用户数据库未恢复回来，且有一个mail目录和一个mail链接目录。问题原因：备份数据中，mail作为链接目录处于其他位置。灾难恢复前，新部署好的环境中mail目录仍然存在。解决方法：关闭server服务，删除data下的mail目录，重新进行恢复。恢复失败Q：恢复错误，提示另一个程序正在使用此文件，进程无法访问。错误原因：恢复时未关闭DominoServer服务解决方法：关闭DominoServer服务后，重新进行恢复Q:当环境出现备份或恢复速度较慢，怎样解决?首先查看存储柜的cached值，如果cached值小于6GB时，可以使用以下方法进行性能调优。1.打开/etc/sysctl.conf文件。#vi/etc/sysctl.conf2.修改如下参数的值为下方参数对应的值，如参数名不存在则新增。vm.min_free_kbytes=0vm.swappiness=0vm.vfs_cache_pressure=0vm.dirty_background_ratio=50vm.dirty_ratio=80vm.dirty_writeback_centisecs=100003.保存/etc/sysctl.conf文件，并执行sysctl-p命令。(WWW.EISOO.COM)(5/30)