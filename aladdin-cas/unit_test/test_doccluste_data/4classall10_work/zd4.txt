mahaoyu信息级别：秘密级版权声明版权所有©2003—2014爱数软件有限公司未经本公司许可，任何单位或个人不得以任何形式，复制、传播、摘抄本文档内容的部分或全部。本文档内容上可能会有增删和修改，爱数软件有限公司会定期将修订后的内容纳入新版本中，如有更改恕不另行通知。关于爱数爱数是中国领先的数据管理解决方案提供商，整体数据管理业务已经遍及全球市场。爱数的数据管理解决方案着眼于企业最核心的资产：数据，并从业务连续性、数据存储、数据保护、非结构化数据管理及数据长期保存五个维度出发，帮助客户解决云化数据中心基础设施层的数据管理需求。在云计算、虚拟化以及BYOD和移动互联四大趋势下，随着IT即服务的目标明朗化，客户的整体建设需求也在顺势而为变的更加关注数据管理服务：高性能可弹性扩展且池化管理的存储多重高效的数据保护方式足够开放和安全的非结构化数据管理我们立足于趋势前沿，紧贴行业市场需求，针对不同的客户定位，基于专业沉淀的技术，通过持续创新产品，提供专业的数据管理解决方案和服务，致力于通过高效的数据管理来帮助用户提升运营效率，并加固业务连续性，其中爱数专业的存储产品AnyStorage助客户解决数据高效存储、数据可用性、数据长期保存的难题；爱数卓越的备份一体机，从超易备到AnyBackup再到TxCloud，提供前端到后端的全面强大的数据安全保障服务，采用多种保护模式从多个维度满足客户数据保护的需求；爱数创新的非结构化数据管理产品AnyShare和易享云，助力客户在新趋势下提升和优化非结构化数据管理效率；爱数增值型云产品基于Tx统一运营管理平台，可助力客户轻松实现共享灾备云和共享文档云，即以SaaS模式提供备份即服务和文档即服务。借助爱数的方案和产品，我们的客户可以从容布局云端，赋予IT战略价值，实现从数据资产到信息资产的跨越，有效提升业务效率。作为备份一体机的首创者和引领者，在IDC2013年关于中国备份一体机市场的研究报告中，爱数以18.5%的市场份额位居中国品牌第一。同年，爱数凭借完整的数据管理解决方案入选GartnerCoolVendor名单。源于优秀的企业运营理念和价值观，包括客户为先、平等尊重、兑现承诺、持续变革、追求卓越，我们一直专注于全球智能数据管理典范企业的愿景践行，致力于为全球各地的客户实现无法想象的IT商业价值。如今，爱数的产品和解决方案已经成功服务于全球上万客户，遍及党政、医卫、涉密、教育、企业以及云服务领域等行业，我们将持续用推动业务转型的革命性创新来成就客户发展，帮助客户迎合行业趋势，驾驭数据未来。目录3关于爱数6一．写作目的6二．目标读者6三．实施版本6四．步骤61.开机及网络配置72.初始化配置93.创建RAID104.创建卷115.修改接收数据IP126.校正系统时间137.设置自备份计划138.配置告警规则139.创建用户1310.安装客户端1511.配置客户端1612.许可证授权1613.网卡绑定1714.重启服务17五．附录171.端口和服务进程一览表212.万兆网卡查看和注意事项213.网卡配置方法234.网卡绑定方法245.指纹库所需空间的计算方法256.查看操作系统版本位数277.内存使用指导278.机房搬迁后（控制台IP发生变化）数据恢复一．写作目的指导AnyBackup5.0.2.0的实施工作，介绍从存储柜通电开机到配置使用过程中的注意事项，定义实施标准流程，明确可实施的质量边界。二．目标读者售后实施人员。三．实施版本控制台：爱数备份存储柜5.0.2(Version:5.0.2.0.2668)客户端：5.0.2.0.2668四．步骤1.开机及网络配置开机前断开网线再执行开机操作。开机后检查机器是否存在异响，指示灯是否显示正常。使用笔记本和网线直连节点的1号网口，使用ssh远程登录，IP：192.168.0.253，用户名：root，密码：1xPNKlu.7D1tHR2M560I50，ssh连接上后检查服务是否启动正常。查看服务和进程如果用户使用万兆网络进行数据备份，则须检查存储柜万兆网卡是否正常。万兆网卡查看和注意事项使用笔记本和网线直连节点的1号网口,在浏览器中访问http://IP:9800，检查机器是否已经做了初始化配置，如不需要进行初始化配置，直接进入第3步开始创建RAID。如果需要进行初始化配置，则进入下一步开始初始化配置。初始化配置完成后，注销、登录控制台，修改控制台管理ip。查看网卡配置方法如果是机房搬迁，造成控制台IP发生变动，恢复数据前，需要修改设置，具体请参照机房搬迁后（控制台IP发生变化）数据恢复2.初始化配置1）网络接通后，在浏览器中访问http://IP:9800（图中IP以192.168.240.222为例），选择设置的IP，点击下一步。2）设置用户密码、邮箱。默认密码均为123456，默认audit用户未启用，此处可设置新密码以及启用用户，也可不修改使用默认设置（根据用户需要设置，建议此处设置新的密码），设置完成后，直接点击下一步。3）创建RAID（具体创建方法参考第3步）4）创建卷(具体创建方法见第4步)。5）创建卷完成后，初始化向导完成；6）登陆存储柜控制台（默认用户：admin，默认密码：123456），直接进入第5步。3.创建RAID操作路径:登录->存储管理->介质服务器管理->选中主管理控制台->配置设备->磁盘设置；检查下磁盘列表是否正常显示,进入RAID设置页面，根据需要选择RAID类型以及合适的磁盘个数创建RAID，创建RAID时建议开启读写缓冲，以增加磁盘读写速度。购买重删加速选件的用户，使用两块SSD的所有空间创建1个RAID1.注意：24盘位设备支持RAID0/RAID1/RAID10/RAID5/RAID50/RAID6/RAID6012盘位设备支持RAID0/RAID1/RAID10/RAID5/RAID50RAID0至少需要2块磁盘，最多无限制。RAID1至少需要2块磁盘，且磁盘个数必须为偶数个。RAID10至少需要4块磁盘，且磁盘个数必须为2的次方。RAID5至少需要3块磁盘，最多无限制。RAID50至少需要6块磁盘，且磁盘个数必须为偶数个。RAID6至少需要4块磁盘，最多无限制。RAID60至少需要8块磁盘，且磁盘个数必须为偶数个。可以在RAID管理中给除RAID0以外的其他RAID设置热备盘，热备盘可设置多个，且容量必须大于该RAID中最小磁盘容量。可以在磁盘设置中设置RAID的全局热备盘，全局热备盘容量大小无限制。存在热备盘（全局热备盘或RAID热备盘）时，RAID若降级则会自动选择热备盘进行重建。RAID降级状态时，若未设置热备盘，则可在RAID管理界面手动选择可用磁盘进行重建。4.创建卷操作路径:登录->存储管理->介质服务器管理->选中主管理控制台->配置设备->磁盘设置；进入卷管理页，如果已有自备卷，则不需要创建，如果没有自备卷，则需要创建自备份数据卷，建议创建50G。如果有重删模块，则需要创建DDCache卷，否则不需要创建DDCache卷。DDCache卷的作用是提高重删率，DDCache卷只能创建一个，所以卷大小建议为RAID所有可使用大小。DDCache卷一旦创建不建议删除，删除后不会对以前数据造成影响，但是会影响后续备份的重删率。DDCache卷的大小约为每1T重删后的数据（无重复块），需要17GB-23GBDDCache空间存放指纹。查看指纹库空间计算方法注意：建议SSD磁盘创建的RAID专用于重删DDCache卷，便于提高重删效率。创建挂载卷。如果用户环境中有虚拟化环境需要使用高级备份方式进行备份，且需要使用挂载卷，否则不需要创建此卷。挂载卷的大小根据用户数据的实际大小判定,一般来说，需要备份多大数据量可创建稍微大于该数据量的挂载卷。挂载建只能创建一个。创建OFS卷，根据用户需要备份的数据大小及需要保留的副本数大致估算需要的卷空间并建对应大小的OFS卷。注意：设置保留副本数时，实际需要预留的空间为副本数+1的数据容量大小。例如，一个副本数大小为10G，设置保留2个副本数，那至少需要预留空间为（2+1）*10G=30G。5.修改接收数据IP操作路径：登录->存储管理->介质服务器管理->网络管理->接收数据IP；接收数据IP是指当介质服务器存在多张网卡时，在进行备份时可选择通过指定网卡进行数据传输，默认为127.0.0.1，此ip必须修改才可正常备份。一般需手动输入添加ip地址，ip地址的可选项为介质服务器所有可用网卡ip。（目的不支持多介质服务器，所以此处ip即控制台网卡ip）6.校正系统时间操作路径：登录->存储管理->介质服务器管理->系统状态->系统管理；在系统管理中可通过手动设置、NTP服务器设置两种方式设置系统时间，使用NTP服务器（可上网查询NTP地址）设置时间时需要当前控制台网络跟NTP服务器网络相通才可同步；手动设置时间则可设置为任意时间，建议任务部署之前统一对服务器、客户端时间进行校验，确保时间跟当前实际时间一致。7.设置自备份计划操作路径：登录->运营管理->自备份管理->自备份属性；此处默认策略（推荐设置）为每天备份一次，默认保存7个副本数，建议保留3个，计划备份时间为每天00:00:00。可根据用户的实际需求修改计划配置。8.配置告警规则操作路径：登录->日志和告警->告警管理；此处需要根据用户的实际需求进行配置，点击“告警规则”tab，进入告警配置页，可根据需要勾选并启用告警规则。启用的告警规则并不会生效，需要点“配置”按钮添加检查对象以及邮件抄送人，也可点击告警跟规则列表中的级别、告警方式修改告警规则的级别跟告警方式。9.创建用户操作路径：登录->运营管理->用户管理；此处根据用户的实际需要进行配置。暂不支持导入域用户。新创建的用户，默认密码为123456。用户登录后可在右上角的个人信息中修改密码。10.安装客户端安装过程不再累述，注意事项如下：客户端安装包的位数需要和数据库位数保持一致，如64bit操作系统上安装32位的数据库，则需安装32位的客户端。查看常见数据库/操作系统位数的方法在需要备份Gbase、Sybase、Exchange、Domino、MySQL、DB2的环境里安装客户端的时候，检查下客户端上是否有其他备份软件或者是用户自己设置的备份脚本，如果有，最好能停掉，否则可能会有交叉备份导致恢复的不是预期的数据。支持客户端安装的操作系统环境见下表。	操作系统	CPU架构	操作系统位数	Windows2003SP1	X86	32	Windows2003SP1	X86	64	Windows2003SP2	X86	32	Windows2003SP2	X86	64	Windows2003R2	X86	32	Windows2003R2	X86	64	Windows2008	X86	32	Windows2008	X86	64	Windows2008SP2	X86	32	Windows2008SP2	X86	64	Windows2008R2	X86	64	Windows2012	X86	32	Windows2012	X86	64	Windows7	X86	32	Windows7	X86	64	Windows8	X86	64	RedHatEnterpriseLinux6	X86	32	RedHatEnterpriseLinux6	X86	64	RedHatEnterpriseLinux5	X86	32	RedHatEnterpriseLinux5	X86	64	CentOS5	X86	32	CentOS5	X86	64	CentOS6	X86	32	CentOS6	X86	64	SUSELinuxEnterpriseServer11	X86	32	SUSELinuxEnterpriseServer11	X86	64	RedFlagLinux6	X86	3211.配置客户端操作路径：登录->备份容灾->客户端；用鼠标选中对应的客户端，然后用户可以通过点击齿轮状的按钮进行以下操作：配置客户端及客户端组：购买重删模块的用户，需要根据客户端机器的实际可用内存配置客户端进程使用的内存上限，默认值为200MB，此处配置越高效率越高，但是要控制大小，不能超过实际可用内存大小（配置后此客户端上的每个任务都将占用这么多内存）。推荐使用默认配置。推荐使用默认配置。指纹缓存路径使用本地卷，指纹缓存路径所在卷需要的可用空间按【任务数*客户端缓存空间配置大小】预留相应空间硬盘空间。请根据用户的数据量大小设定指纹缓存路径。新建虚拟客户端：在此选项中，用户若需要备份双机、集群、Hyper-v和VMware的数据，则需要创建虚拟客户端。否则不需要。12.许可证授权操作路径：登录->运营管理->许可证管理；直接添加即可，不再累述。注意在线激活的时候，需要存储柜可以连通外网，且已设置可用的DNS。如不能连外网，则使用激活工具激活。13.网卡绑定根据用户需要进行网卡绑定。查看网卡绑定方法14.重启服务操作路径：登录->介质服务器管理->系统信息若控制台出现服务异常，则可在系统信息页选择【重启服务】按钮，进行重启，此功能是重启所有控制台服务。（重启服务前确保AnyBackupWebForDataengine、AnyBackupWebForLocal、AnyBackupPHPServer、AnyBackupWebServer这4个服务正常）也可进入后台/etc/init.d目录进行手动重启。命令：/etc/init.d/AnyBackupXXXXXServer{start|stop|restart|status}五．附录1.端口和服务进程一览表Q：客户端服务器需要确保哪些端口开放？A：9902、9952。Q：存储柜需要确保哪些端口开放？A：9800、3345、8500、8510、8520、9952、9902。Q:访问web管理界面的PC机器需要确保哪些端口开放？A：9800、3345、8500、8510、8520、9952。(1)Web服务器a.Nginx服务Web服务器，提供Web门户，RESTful接口转发等进程名称:/sysvol/apphome/app/3rdlibs/nginx/sbin/nginx服务名称:AnyBackupWebServer占用端口:9800b.php服务提供PHP脚本解析进程名称:/sysvol/apphome/app/3rdlibs/php/sbin/php-fpm服务名称:AnyBackupPHPServer占用端口:3345(2)TornadoWebServer命名规则:8代表web，5代表5r，十位起命名，个位留着用来做nginx的负载均衡a.Serverforlocal通过本地python脚本提供服务的RESTfulAPI进程名称:/sysvol/apphome/app/mgmserver/anybackup/bin/webforlocal服务名称:AnyBackupWebForLocal占用端口:8500b.Serverforthrift通过调用后端thrift接口提供服务的RESTfulAPI进程名称:/sysvol/apphome/app/mgmserver/anybackup/bin/webforthrift服务名称:AnyBackupWebForThrift占用端口:8510c.ServerforDataEngine调用DataEngine的接口提供服务的RESTfulAPI进程名称/sysvol/apphome/app/mgmserver/anybackup/bin/webfordataengine服务名称:AnyBackupWebForDataengine占用端口:8520(3)Python管理服务（内部使用）为C++服务提供数据库访问等管理功能的Thrift接口进程名称:/sysvol/apphome/app/mgmserver/anybackup/bin/thriftpysvc服务名称:AnyBackupThriftPySvc占用端口:9950(4)管理控制台提供客户端管理、更新管理等Thrift接口，维护客户端长连接进程名称:/sysvol/apphome/app/bin/esfdaemonn-fconsoled.config服务名称:AnyBackupBackupServer占用端口1:9951(thrift接口，内部使用)占用端口2:9952(维护长连接)(5)介质服务器提供介质管理thrift接口，同时接收和发送备份数据进程名称:/sysvol/apphome/app/bin/esfdaemon-fmediasvrd.config服务名称:AnyBackupMediaServer占用端口1:9955(thrift接口，内部使用)占用端口2:9902(接收备份数据)(6)mysql数据库服务提供数据库服务，将持久信息保存到数据库里，以便web前端直接从数据库里读取，提高执行效率进程名称:/AnyBackupServer/app/3rdlibs/mysql/bin/mysqld服务名称:AnyBackupDBServer占用端口1:99062.万兆网卡查看和注意事项开机后，进入后台，使用ethtool-iem1~2查看em1、em2网口是否万兆网口，如图所示：上图中ixgbe为intelx520的万兆网卡驱动上图中igb为千兆网卡的驱动万兆网络环境备份问题现象：万兆网络环境下，启动备份任务，备份少许数据后即报错：发送数据时发生错误，连接将断开。（错误提供者：WindowsSystem，错误值：10054，错误位置：ncNetIOHandler.cpp:291）解决方法：将系统ssd盘拔出再插回原处，重新备份即可3.网卡配置方法(1)配置前，请先检查主网卡是否为em1，可采用以下命令检查：mii-toolem1，检测是否正常，正常情况下为：如果没有插上网线，则为：需要检查网线与网口是否正确对应。(2)进入【介质服务器配置】-【网络设置】，点击选中网卡配置注意：此处配置需要检测局域网内是否存在IP冲突，可以在该局域网的任意一台机器上使用ping命令进行检测；此处修改完毕后会出现“服务器没有响应”，属于正常情况，需要用新的IP登录控制台；修改后到【介质服务器配置】-【系统状态】-【系统管理】，看管理IP是否为修改后的IP，如果不是，请在【系统管理】里进行修改保存配置路由规则时，如果所有的网卡均配置IP且在同一网段，则必须在添加路由前，在每块网卡上配置网关地址。默认情况下使用em1作为默认网关的网卡，检查是否正常：4.网卡绑定方法进入【介质服务器配置】-【网络设置】，点击网络绑定注意：(1)此处IP地址为主控制台管理IP，需要跟用户沟通，获取；被绑定的网卡数量至少为2张，可选择多张；绑定模式支持两种：故障冗余和负载均衡，其中故障冗余用于网络不稳定的环境，负载均衡用于提高网络流量，设置后可一定程度提高网络流量，也具有故障冗余的功能。建议使用负载均衡模式.(2)网卡绑定与被绑定的网卡是否有IP没有关系，绑定后，之前网卡的IP将失效，即无法ping通，即使在同一网段(3)绑定时，若绑定网卡bondX的IP地址跟em1-4的任意一张IP一样，则绑定后不会出现“服务器没有响应”，若不一样，则需要用新的绑定IP登录控制台；(4)绑定后需要查看使用默认网关的网卡，是否为bondX（X为0、1、2.......),如下图所示：(5)勾选默认网关的网卡设置时，需要检查所选网卡是否配置网关地址5.指纹库所需空间的计算方法每个指纹索引占用32字节，每个指纹占用36字节。根据用户的数据选择分片大小，按照每个数据片按照3KB计算，每1TB重删后的数据包含357913941个数据片，换算成指纹及索引的占用为357913941*（32+36）=24338148010B=22.67GB。同理，按照每个数据片按照4KB计算，每1TB重删后的数据需要的17GB存储空间。举例：用户重删后的数据为N，单位为TB。则最大需要：22.67GB*N空间存放指纹，最小需要17*N空间存放指纹。6.查看操作系统版本位数(1)Windows下，在cmd中输入systeminfo命令找到OS版本、系统类型即可确定系统版本、位数(2)Linux下查看版本和位数的方法：注意：也可用getconfLONG_BIT进行判断位数(3)对于应用的版本、位数判断，方法如下：Oracle环境：输入sqlplus/assysdba即可看出版本Sqlserver环境：在查询窗口输入selectSERVERPROPERTY('edition')，执行查询，如果是64位的会有64-bit字样，如果是32位没有输出：注意：也可通过select@@version命令查询版本、位数MySQL环境：在shell终端下输入mysql-V即可7.内存使用指导介质服务器内存消耗：开重删：1G+重删服务器缓存+300M*任务数+3.5G+1不开重删：1G+200M*任务数介质服务单个远程复制任务（同步重删数据）:(1G+单个最大文件大小/4k*48B)~(1G+单个最大文件大小/3k*48B)参照值：以远程复制一个1TB的文件为例，源端介质服务器内存占用在12G~16G之间重删服务器缓存默认值为1GB。客户端内存消耗：开重删：(200M+160M+N)*任务数（N为配置客户端时重删内存空间，默认为200M）不开重删：300M*任务数8.机房搬迁后（控制台IP发生变化）数据恢复操作步骤：1）进入客户端，修改客户端配置文件。对于windows系统，点击【开始】-【客户端配置】，进入客户端配置页面，修改服务器IP为当前控制台IP；对于linux系统，修改clientsetting.config中targetIpAddr为当前控制台IP；2）登录控制台，进入【介质服务器管理】-【网络管理】-【接收数据IP】，添加当前控制台IP作为新的接收数据IP，此处需要注意，无法将原有的接收数据IP编辑为当前控制台IP，因为这个IP跟对应的备份任务之间有关联。3）登录控制台，进入【介质服务器管理】-【备份恢复】，选中备份任务，点击【编辑】，修改接收数据IP为当前控制台的接收数据IP。注意：如果不做以上处理，是无法恢复控制台IP发生变动前的备份数据，这一点需要特别注意。AnyBackup5.0.2.0备份存储柜实施指导文档地　　址：上海市联航路1188号浦江智谷8号楼2层邮　　编：201112咨询热线：021-54222601服务热线：400-880-1569官方主页：�HYPERLINK"http://www.eisoo.com/"�http://www.eisoo.com�微博主页：�HYPERLINK"http://e.weibo.com/eisoosoftware"�http://e.weibo.com/eisoosoftware�I