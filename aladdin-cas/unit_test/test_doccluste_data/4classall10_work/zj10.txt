(最佳实践)(最佳实践)	AnyBackup5.0.2.0最佳实践Oracle实时备份目　录目　录	2第一章概览	31.1简介	31.1.1Oracle实时备份	41.1.2Oracle恢复	41.2Oracle实时备份支持功能	4第二章限制性列表	6第三章客户端安装	63.1Windows客户端安装	63.1.1Windows环境确认：	63.1.2Windows客户端安装	83.3客户端配置	13第四章Oracle备份环境检查	154.1Windows环境备份前置条件检查	154.1.1监听配置检查	154.1.2数据库状态检查	184.1.3归档日志状态检查：	184.3介质服务器检查及配置	21第五章实时备份最佳实践	225.1Oracle实时备份最佳实践	225.1.1命名规则说明	225.1.2实时备份任务建立	22第六章实时恢复最佳实践	286.1Oracle恢复概述	286.2Oracle故障诊断及恢复方式选择	286.2.1普通恢复应用场景及诊断方式	286.2.2挂载恢复应用场景及诊断方式	286.3浏览恢复	286.3.1普通恢复注意事项	286.3.2恢复步骤	296.3.3异机恢复步骤	316.4挂载恢复	356.4.1挂载恢复注意事项	356.4.2自动挂载恢复步骤	356.4.3手动挂载恢复步骤	37第一章概览1.1简介卷实时备份可以将您服务器上的某一个卷进行整体实时备份（存在于此卷上的数据全部可以受到实时备份的保护），形成一个“虚拟卷”。并且在您创建了卷实时备份任务之后，基于iSCSI卷挂载技术可以让您把该“虚拟卷”挂载到您的服务器上，“虚拟卷”上的数据对于您来说是立即可用的。这样就实现了当您的原数据因出现意外而无法使用时的数据瞬间恢复。您的查询需求也可以在该“虚拟卷”上完成，从而减轻了生产服务器的负担。卷CDP驱动是位于Volume驱动和disk驱动之间的一个系统驱动程序，负责捕获来自上层的所有的IO操作，进行IO重定向和分发到journal卷上去，供上层客户端实时的从日志卷中取数据发送到OFS介质服务上去。日志卷空间可以实现空间自动回收，避免日志池占用空间越来越大。内核态驱动和用户态客户端之间也有交互，这两个模块之间的交互主要是控制消息的交互，比如启动、停止CDP,产生一致性标识等。卷CDP模块逻辑结构和工作原理：1.1.1Oracle实时备份Oracle实时备份基于卷CDP的实时备份1.1.2Oracle恢复1.Oracle浏览恢复Oracle浏览恢复基于卷CDP的浏览恢复2.Oracle挂载恢复Oracle挂载恢复基于卷CDP的挂载恢复，可支持选择多个卷进行挂载自动挂载：无需手动进行iscsi连接，挂载盘符自动分配手动挂载：需手动进行iscsi连接，挂载盘符自动分配1.2Oracle实时备份支持功能	功能	子功能	支持	备注	备份		√	包含完全初始化及增量复制	断点续传		√		历史时间点保留策略		√		多实例备份恢复		√	每个任务支持多个实例	数据源动态更新		√		Oracle+自定义数据源备份		√		浏览恢复		√	支持应用联机	挂载恢复	自动挂载	√	不支持应用联机第2章限制性列表1.挂载恢复不支持应用一致性处理2.挂载恢复不支持指定盘符恢复3.备份/恢复不支持进度显示4.不支持编辑任务的数据源5.日志卷磁盘脱机恢复后不支持断点续传6.PCB-5672M11-ST-oracle实时备份与恢复-挂载多个盘符后，停止任务耗时长且抛错“消息发送超时”第三章客户端安装3.1Windows客户端安装确定客户端安装包，需要确定用户环境中操作系统的位数以及数据库的位数，同时对于少数用户出现在64bit的操作系统上安装32bit的数据库的情况，需要安装和数据库位数相同的包，即需要安装32bit的客户端安装包。3.1.1Windows环境确认：cmd，运行systeminfo命令，查看系统版本详细信息。cmd命令行中，登录Oracle数据库(sqlplus“/assysdba”)，查看Oracle数据库的版本命令：select*fromv$version;3.1.2Windows客户端安装1.双击windows客户端安装程序，进入安装向导界面；2.点击【下一步】，指定安装路径；3.点击【下一步】，输入服务器端IP；4.选择是否安装iSCSIInitator工具和卷CDP驱动。当前系统非2000、2003或xp系统，iSCSI选项不可选,若是在2000,2003或者XP系统安装客户端，实时备份恢复Oracle数据库可以默认不勾选，对于实时备份，选项“安装卷CDP驱动”必须勾选；5.点击【下一步】进行安装，直至完成；安装完成后，会提示系统需要重启。此处也可以不必重启，驱动也能安装成功。3.3客户端配置在浏览器上输入http://IP:9800/的方式，然后用用户名和密码登录控制台；点击数据保护，客户端名称中，可以查看新安装的客户端；将鼠标放在客户端上，可以查看客户端的详细信息，若下图；用鼠标选中对应的客户端，然后用户可以通过点击齿轮状的按钮，可以进行以下操作：新建客户端组：根据向导，建立用户端组后，用户可以采用鼠标拖动的方式，将对应的客户端加入对应的组中；修改名称：默认的名称为操作系统的hostname，而hostname不好识别，用户可以根据需要给客户端命名为一个容易识别的名称，以便管理；配置客户端：该选项，可以配置重删数据任务设置和卷实时任务设置，根据用户的实际资源情况，设置对应的数值即可，其中内存使用限制越大，性能越好；新建虚拟客户端：在此选项中，用户可以选择创建双机、集群、hyper-v和VMware客户端；第四章Oracle备份环境检查4.1Windows环境备份前置条件检查4.1.1监听配置检查Oracle备份要求Oracle数据库可以使用“sqlplus“sys/mima@Oracle_sidassysdba””的方式能正常连接数据库，否则备份可能失败，检测方法如下；首先进入cmd命令行，输入连接数据库命令：C:\Windows\system32>sqlplus"sys/eisoo@racdbassysdba"SQL*Plus:Release10.2.0.1.0-ProductiononMonMar1017:22:172014Copyright(c)1982,2005,Oracle.Allrightsreserved.Connectedto:OracleDatabase10gEnterpriseEditionRelease10.2.0.1.0-ProductionWiththePartitioning,OLAPandDataMiningoptionsSQL>如果登录过程中，出现错类似“TNS-xxxxxx:TNS:xxxxx”的错误，说明监听的配置有问题，请按照如下方式配置监听；监听配置，以Oracle10g为例（备注，建议配置监听之前，先执行检查的步骤，如果监听可以满足备份恢复要求，则可以不用重新配置）;实验环境概述：Oracle_HOME=D:\Oracle\app\dbOracle_SID=orclHOST=zy-PC主机IP=192.168.1.236第一步：停止监听用cmd登录命令行，运行命令，lsnrctlstop，停止监听；第二步：编辑D:\Oracle\app\db\network\admin\listener.ora如下SID_LIST_LISTENER=(SID_LIST=(SID_DESC=(SID_NAME=PLSExtProc)(Oracle_HOME=/u01/Oracle)(PROGRAM=extproc))(SID_DESC=(GLOBAL_DBNAME=orcl)(Oracle_HOME=/u01/Oracle)(SID_NAME=orcl)))LISTENER=(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=PA-V2-236)(PORT=1521)))红色部分为创建数据库默认没有的，需要手动添加进去，其中Oracle_HOME和GLOBAL_DBNAME、SID_NAME根据实际生产环境而定，可能和例子中不同；第三步：编辑D:\Oracle\app\db\network\admin\tnsnames.oraORCL=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=PA-V2-236)(PORT=1521)))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=orcl)))该文件一般使用创建数据库后默认的配置即可，不需要重新配置。第四步：启动监听C:\Windows\system32>lsnrctlstart出现如下界面，表示启动成功。第五步：验证监听是否可用C:\Windows\system32>tnspingorcl出现如下界面表示监听正常：验证看看在关闭数据库的情况下能否正常登录SQL>shutdownimmediate;关闭数据库SQL>exit;退出数据库，重新登录C:\Windows\system32>sqlplus“sys/eisoo.com@orclassysdba”，如果仍然登录成功说明数据库监听配置正确，如果登录出现一下界面，说明监听配置不正确，需要检查错误，重新配置；4.1.2数据库状态检查在进行Oracle数据库备份时，要求数据库必须在open状态，检查方法为在登录数据库后，运行命令“selectinstance_name,statusfromv$instance”：SQL>selectinstance_name,statusfromv$instance;INSTANCE_NAMESTATUS----------------------------racdbOPEN如果数据库为非open状态，请协调用户系统管理员，将数据库开启至open状态在进行备份，对于正常提供生产业务的数据库来说，数据库肯定在open状态，否则无法提供业务；4.1.3归档日志状态检查：	Oracle数据库备份对归档模式有以下要求:1.数据库必须开启归档模式；2.Oracle数据库归档路径，不能是数据库闪回区；3.归档路径所在的文件系统应该有足够的空间去承载用户的数据库应用；4.对于数据库数据文件采用ASM管理的数据库，归档路径不能存放在ASM中，必须使用本地文件夹作为归档路径；检测方法及步骤如下；	检查Oracle归档模式是否开启，在登录数据库后，运行命令“archiveloglist”查看，对于未开启归档模式的数据库，反馈结果为“非归档模式”；对于已经开启归档模式的数据库，显示结果为“存档模式”，同时会显示具体的归档路径：SQL>archiveloglist数据库日志模式      非存档模式自动存档      禁用存档终点      USE_DB_RECOVERY_FILE_DEST最早的联机日志序列  321当前日志序列     326SQL>archiveloglist数据库日志模式      存档模式自动存档      启用存档终点      D:\arch最早的联机日志序列  321下一个存档日志序列 326当前日志序列     326当用户未开启归档模式时，需要采用如下的方式，开启归档模式，应特别注意，在开启数据库的归档模式是需要关闭数据库的，会有一定的停机时间，需要和用户提前沟通停机时间再进行处理，切勿自行中断用户业务；SQL>shutdownimmediate数据库已经关闭。已经卸载数据库。Oracle例程已经关闭。SQL>startupmountOracle例程已经启动。数据库装载完毕。SQL>alterdatabasearchivelog;数据库已更改。SQL>alterdatabaseopen;数据库已更改。当用户的数据库处于开启归档日志，但是归档日志路径为闪回区时，应将归档路径设置为本地路径，注意Oracle数据库的安装用户必须对归档路径有读写权限，否则会造成数据库停止工作，同时归档路径所在的文件系统，要有足够的空间，如果归档路径文件系统空间被占用完全，数据库也将无法工作，归档路径更改方式如下:创建归档路径，windows环境中，直接右击建立目录即可；登录数据库后，采用如下命令修改当路径：SQL>altersystemsetlog_archive_dest_1='location=D:\arch'scope=both;（修改归档路径）SQL>archiveloglist;	（查看归档路径是否修改成功）DatabaselogmodeArchiveModeAutomaticarchivalEnabledArchivedestinationD:\archOldestonlinelogsequence123Nextlogsequencetoarchive124Currentlogsequence124对于采用ASM管理数据库数据的Oracle来说，要求归档路径不能在ASM中，而只能放在本地节点上，检查Oracle数据库是否为ASM数据库的方法如下，对于ASM的数据库来说，显示结果为“+ASM_Diskgroup_Name/xxx/xxx.dbf”的方式；SQL>selectnamefromv$datafile;NAME--------------------------------------------------------------------------------D:\oradata\racdb\system.259.701543613D:\oradata\racdb\undotbs1.260.701543635D:\oradata\racdb\sysaux.261.701543641D:\oradata\racdb\test1.dbfD:\oradata\racdb\users.264.701543673D:\oradata\racdb\test2.dbf4.3介质服务器检查及配置为保证备份任务可正常执行，在创建Oracle备份任务前，请检查介质服务器是否正常。检查方法，可以在登录控制台后，在存储管理，介质服务器管理中查看介质服务器状态及可用空间；第五章实时备份最佳实践5.1Oracle实时备份最佳实践5.1.1命名规则说明1.【命名规则】:用户名、任务组、任务等对象命名规则满足：不允许为空，且名称长度必须为3~50个字符；2.【邮件命名规则】:Email地址只能由字母A~Za~z、数字0~9及特殊字符@.-_组成，类似于yourname@domain.com的形式，且最长不能超过50个字符；3.【备注信息规范】：备注信息最大不超过255字符；5.1.2实时备份任务建立1.登录爱数备份控制台，点击数据保护选中对应的客户端在任务管理中，点击新建按钮选择实时备份选择Oracle数据库；2.输入任务名称，在备注处，输入自己想要的备份信息，选择想要的介质服务器作为备份的目的地，信息填写完毕后，点击[下一步]按钮；3.各个备份选项说明如下：【指定日志卷路径】实时备份缓冲区的路径设置，该路径不可与监控卷冲突【配置空间】可配置“日志缓冲区空间”及“实时任务内存空间”【时间频率】默认30秒产生时间点【历史数据保存时间】默认保存时间是30天，最小保存时间1天4.点击“+”号展开数据源，Oracle实时备份任务支持自动发现数据源的功能，但是需要手动配置实例名，数据库的用户名和密码，具体如下图；添加的用户必须具有sysdba的权限，一般使用sys用户，密码输入完成后点击确定按钮；如果能展开表空间则配置正确，如果无法展开，则用户或密码错误；注意：新建Oracle实时任务，数据源可以选多个Oracle实例及自定义数据源，但是编辑任务则不可以修改数据源FAQS：1.如果选中数据源时，有如下报错，标明没有对实例进行授权，即添加正确的用户名和密码；2.实例配置完成后，点击展开数据源，出现如下报错，该报错有两个原因1)配置的数据库用户没有sysdba的权限2)输入的密码错误；正确的配置用户名密码即可解决：3.实例配置完成后，点击展开数据源，出现关于监听的错误，一般错误格式“ORA-xxxxx:TNS:xxxxxx”具体如下，出现监听的问题，请返回上一张的监听配置检查，配置监听，测试无误后，再尝试：4.发起备份任务时，提示“请求失败，您没有进行该操作的权限”，该问题是由于控制台没有进行相关的授权，添加对应的授权后，即可解决；添加授权在控制台界面，【运营管理】【许可证管理】中添加，输入对应的授权码，点击在线激活，即可；第六章实时恢复最佳实践6.1Oracle恢复概述	AnyBackup5.0版本针对用户的实际需求提供丰富的恢复方式选择，主要有：浏览恢复、挂载恢复；	【浏览恢复方式】基于对象文件系统OFS，选择目标时间点，遍历时间树，将数据从OFS中恢复到本地磁盘的一种覆写型的恢复方法【挂载恢复方式】客户端连接存储使用标准的iSCSIInitiator，采用iSCSI挂载技术可以将已经备份的数据瞬间恢复出来并且立即可用6.2Oracle故障诊断及恢复方式选择6.2.1普通恢复应用场景及诊断方式应用场景1)当数据库损坏或数据丢失，无法通过挂载恢复同步数据来修复的情况下，可以使用浏览恢复6.2.2挂载恢复应用场景及诊断方式应用场景1)挂载恢复不会对原卷数据产生影响，但可以临时替代原卷进行应用操作6.3浏览恢复6.3.1普通恢复注意事项1)浏览恢复的目的卷需选择比源卷总空间大的卷，否则会恢复失败2)需将数据库关闭6.3.2恢复步骤1.登录爱数备份控制台，点击任务管理浏览恢复；2.选择要恢复的时间点及数据；3.恢复到原机4.点击【下一步】，确定恢复后是否应用联机6.3.3异机恢复步骤1.登录爱数备份控制台，点击任务管理浏览恢复；2.选择要恢复的时间点及数据；3.恢复到异机注意事项：1）异机与原机数据库用户，密码一致2）恢复后需更改异机listener.ora文件、tnsnames.ora文件中的host4.选择恢复策略，用户可以勾选‘恢复使数据库联机’及输入执行备注信息；FAQS：1.浏览恢复出现部分成功，应用联机失败出现这种情况时，需使数据库处于非静默状态，执行相关命令为：1)select*fromv$backup2)Alterdatabaseendbackup;3)Alterdatabaseopen;6.4挂载恢复6.4.1挂载恢复注意事项1.客户端服务MicrosoftiSCSIInitiatorService需启动6.4.2自动挂载恢复步骤1.登录爱数备份控制台，点击任务管理挂载恢复；2.选择要恢复的时间点及数据；3.选择自动挂载4.点击完成6.4.3手动挂载恢复步骤1.登录爱数备份控制台，点击任务管理挂载恢复；2.选择要恢复的时间点及数据；3.选择手动挂载4.点击完成FAQS：1.未启动客户端的iscsi服务，恢复失败2.更多问题，可以参考文件系统实时备份的FAQ。(WWW.EISOO.COM)(17/68)