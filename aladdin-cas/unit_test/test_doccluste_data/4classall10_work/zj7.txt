rentan目录1第一章概述11.1简介11.1.1Hyper-V单机定时备份31.1.2Hyper-V恢复31.1.3任务管理31.1.4重复数据删除3第二章系统要求32.1操作系统4第三章支持的功能5第四章入门54.1安装部署54.1.1安装位置54.1.2开始之前54.1.3安装94.2配置94.2.1介质服务器配置94.2.2授权配置94.2.3客户端配置94.3备份94.3.1备份注意事项104.3.1Hyper-V备份最佳实践154.4恢复154.4.1恢复注意事项154.4.2恢复步骤第一章概述1.1简介本文档是爱数备份容灾家族Hyper-V单机定时备份与恢复最佳实践文档，主要描述了如何正确地使用爱数备份容灾家族产品成员进行Hyper-V备份与恢复的方法，包括部署前后的注意事项和典型部署方案。本技术文档面向爱数备份容灾家族产品成员的用户和相关技术人员，主要介绍Hyper-V备份与恢复的基础知识，以及如何正确使用爱数备份容灾家族产品成员部署Hyper-V备份。旨在通过此文档帮助用户和技术人员快速掌握Hyper-V备份与恢复模块的使用方法。1.1.1Hyper-V定时备份1.1.2Hyper-V恢复1.1.3任务管理1.1.4重复数据删除1.1.1Hyper-V单机定时备份1、Hyper-V简单介绍Hyper-V是微软的一款虚拟化产品，是微软第一个采用基于hypervisor的技术。可以利用windowsserver08、08R2、2012、2012R2的Hyper-V角色，允许创建一个虚拟服务器计算环境。这样一个虚拟的计算环境，利用更多的硬件资源，提高计算资源的效率。每个虚拟机是一个虚拟化的计算机系统，在一个隔离的执行环境下运行。这允许你同时运行多个操作系统在一台物理计算机。Hyper-V提供了软件基础设施和基本的管理工具，可用于创建和管理虚拟服务器计算环境。2、Hyper-V备份恢复功能模块简介Hyper-V调用VolumeShadowCopyService（VSS）来备份和恢复虚拟机。且Hyper-V备份方式分为两种，一种是在线备份（即“ChildVMSnapshot”或者“ChildPartitionSnapshot”方式），该备份方式需要满足一系列条件，我们会在下文详细说明；另方一种备份方式是离线备份（即“SavedState”式）。特别说明，卷影拷贝服务（VolumeShadowCopyService，VSS）是在特定卷上建立数据拷贝时间点，并在将来的某一时刻把数据恢复到任何一个你曾创建的时间点的状态。VSS使用copyonwrite技术进行快照，COW快照需要消耗一些存储空间–建立快照卷。当我们为一个数据卷创建一个快照之后，这些预留的空间用来存放被变化数据更新的旧数据。COW快照在初始化的过程中仅仅创建用来描述源数据块位置的指针信息(元数据)，而不是完整的将源数据块拷贝过来。因此初始化的过程几乎可以在瞬间完成，对系统的影响也很小。COW快照会跟踪数据卷的写操作和数据块变化。当某个数据块发生改变时，在将旧的数据覆盖之前，首先将该块的旧数据复制到预留的快照卷，该步骤仅在数据卷相应数据块位置发生第一次写操作请求时进行。如果我们需要访问某个时间点的快照数据，对没有改变过的块直接从数据卷读取;对已经改变并被复制的块则从快照空间读取。从快照被创建那一刻开始，每个快照都会跟踪记录描述块改变的元数据信息。COW快照的主要优势在于空间的高效利用，因为快照卷只需要保留发生过变化的数据块，与数据卷相比要小得多。但是我们也知道COW快照有个缺点，它会引起数据卷性能的下降，这是因为创建快照之后，对数据卷的写操作会增加一个等待的过程–即旧数据块复制到快照卷的过程。另外一个关键问题是每个快照卷必须依赖一个完整的数据卷。3、备份模式简介ChildPartitionSnapshot/Online模式在这种模式下，它使用VSS在子系统参与备份虚拟机。为支持“ChildPartitionSnapshot”的方法，都必须满足以下条件：1、备份（卷快照）集成服务必须安装和运行在备份目标虚拟机。服务名称是“Hyper-V的卷影复制请求者”。且要求安装在目标虚拟机上的集成服务版本和Hyper-V服务器的版本一致。2、备份目标虚拟机必须处于运行状态。3、虚拟机快照文件的位置和虚拟机原来的vhd等磁盘文件的位置要在主机操作系统相同卷上。4、备份目标虚拟机的所有卷都是基本磁盘，不是动态磁盘。5、备份目标虚拟机的所有磁盘，必须使用支持文件系统快照（必须为NTFS，故FAT格式和exts（linux系统）都不支持）。Windows2000不支持该种备份模式。SavedState/Offline模式对于不满足“ChildPartitionSnapshot”模式的虚拟机，执行备份时，都将采用““默认的备份机制被称为“保存状态”的方法。由于虚拟机不满足在线备份的条件，但是又要保证数据的一致性，所以在备份的过程中会将虚拟机短暂的处于一种保存状态，以便VSS执行快照操作，等VSS快照执行完毕以后，处于保存状态的虚拟机会自动恢复到原先的状态，后面的备份操作对虚拟机不会产生影响。处于保存状态的时间一般不会超过1分钟。特别对于开机的虚拟机，需要进行数据保护，但不满足在线备份，建议在空闲的时候进行备份，以免备份时影响生产业务。4、完全备份将选定的虚拟机完全备份到指定目的地的备份集中。每次执行时，它都会将虚拟机的所有数据完整的备份到ofs介质中，并产生一个时间点，用于记录备份的内容。5、增量备份是基于上一次完全备份或者增量备份，增量备份根据前面备份的虚拟机磁盘文件集进行过滤，只备份发生变化的数据，从而避免完全相同的虚拟机磁盘文件重复备份，同时产生一个时间点，以便恢复使用。在尚未进行完全备份的情况下，进行增量备份时会自动转换为完全备份。1.1.2Hyper-V恢复通过浏览恢复，恢复备份时间点。1.1.3任务管理1.【命名规则】:用户名、任务组、任务等对象命名规则满足：不允许为空，且名称长度必须为3~50个字符；2.【邮件命名规则】:Email地址只能由字母A~Za~z、数字0~9及特殊字符@.-_组成，类似于yourname@domain.com的形式，且最长不能超过50个字符；3.【备注信息规范】：备注信息最大不超过255字符；1.1.4重复数据删除本版本支持开启源端重复数据删除的Hyper-V定时备份任务。第二章系统要求2.1操作系统支持的操作系统：MicrosoftWindowsServer2008X64MicrosoftWindowsServer2008R2EnterpriseMicrosoftWindowsServer2012X64MicrosoftHyper-VServer2008X64MicrosoftHyper-VServer2008R2MicrosoftHyper-VServer2012MicrosoftWindowsServer2012R2Standard第三章支持的功能下表列出了Hyper-V定时备份模块所支持的功能。	功能	子功能	支持	备注	备份类型	完全备份	√			增量备份	√		循环备份		√	完全备份、增量备份相结合的循环	高可用虚拟机		√		非高可用虚拟机		√		浏览恢复		√		异机恢复		√		恢复粒度		√	单个虚拟机	多虚拟机恢复		√		指定恢复虚拟机名		√	支持恢复虚拟机时恢复为新虚拟机名第四章入门4.1安装部署4.1.1安装位置4.1.2开始之前4.1.3安装4.1.1安装位置当您成功完成客户端的安装后，装有Hyper-V的机器即可作为客户端连接至Anybackup控制台。您可通过控制台页面中【备份容灾】->【客户端】查看客户端连接情况。4.1.2开始之前1、客户端为64-bit类型。4.1.3安装Windows客户端安装方法登录到客户端所在的机器，将客户端安装包文件AnybackupClientSetup_x64.exe拷贝到指定位置；双击客户端文件，接收许可证协议，点击“安装”开始安装客户端；进入客户端安装向导，”下一步“；输入指定服务器和客户端IP地址；默认“下一步”，点击“安装”（选择是否安装iSCSIInitator工具，当前系统非2000、2003或xp系统，iSCSI选项不可选，若是2000,2003或者XP系统安装客户端，备份恢复Hyper-V单机可以默认不勾选）；安装完成后点击“完成”；安装完成后点击“关闭”；4.2配置4.2.1介质服务器配置为保证备份任务可正常执行，在创建Hyper-V备份任务前，请检查介质服务器是否正常。4.2.2授权配置为保证创建备份任务成功，在创建Hyper-V备份任务前，请检查【运营管理】→【授权管理】中已添加授权码并激活，否则创建Hyper-V备份任务失败，如下图：4.2.3客户端配置1、Hyper-V服务器上的服务正常启动。2、安装客户端后客户端服务正常启动。4.3备份	哪些内容会进行备份？	哪些内容不会进行备份？	虚拟机磁盘文件，快照文件，配置文件	Hyper-V网络，系统配置等其他信息4.3.1备份注意事项1、备份虚拟机时需保证备份的虚拟机所在的磁盘至少有1GB的预留空间存放卷影副本。2、对于不满足“ChildPartitionSnapshot”模式的虚拟机，执行备份时，都将采用““默认的备份机制被称为“保存状态”的方法。由于虚拟机不满足在线备份的条件，但是又要保证数据的一致性，所以在备份的过程中会将虚拟机短暂的处于一种保存状态，以便VSS执行快照操作，等VSS快照执行完毕以后，处于保存状态的虚拟机会自动恢复到原先的状态，后面的备份操作对虚拟机不会产生影响。处于保存状态的时间一般不会超过1分钟。特别对于开机的虚拟机，需要进行数据保护，但不满足在线备份，建议在空闲的时候进行备份，以免备份时影响生产业务。3、SMB3.0存储虚拟备份，SMB3.0存储服务器上需安装“文件服务器VSS代理服务”。4.3.1Hyper-V备份最佳实践1、在浏览器中输入：http://***.***.***.***:9800登录爱数备份存储柜控制台，依次打开节点【备份容灾】/【客户端】，打开客户端管理界面，如下图所示：开始创建Hyper-V定时备份任务，选中Hyper-V客户端，然后点击“新建”，选择“Hyper-V虚拟化平台”，如下图所示：输入任务名称例如“Hyper-V定时备份任务”，点击“下一步”按钮，如下图所示：对应“离线备份”模式，对于不满足“在线备份”条件的虚拟机，一定要启用该选项，否则备份一定会失败，点击“下一步”按钮后进入“计划任务”配置界面，如下图所示：5、在选择数据源时，可以根据不同环境的需求选择数据源，包括单个虚拟机，甚至整个虚拟机平台。当选择整个服务器时，这样选择选择整个目录（可以确保此目录下有新增的虚拟机也能够包含在该任务中，成功备份）。再点击“下一步”按钮，选择任务策略信息，如下图：5、进入“计划任务”配置界面，如下图所示：6、点击”新建“，进入计划设计界面：根据自己的时间需求，配置相对的计划任务，如下图：在这里，如果用户想至少保证一个月的数据安全：1）每周末数据应用比较平缓的时候，进行一次完全备份；2）隔两日晚时进行一次增量备份；3）设置保留完全备份副本数为4，这样能够保证近28天的数据不会被丢失；注：完全备份：是对虚拟机的所有数据进行备份。增量备份：是基于上一次完全备份或者增量备份，增量备份根据前面备份的虚拟机磁盘文件集进行过滤，只备份那些新的虚拟机磁盘。7、点击“确定”按钮后，任务配置完成，选择任务，点击启动，提示执行时的备份类型，这里默认选择“完全备份”，点击“确定”按钮即可，然后点击“执行”链接标签。下图是【常规执行任务】中虚拟机备份任务的执行情况。直至最后成功完成。4.4恢复4.4.1恢复注意事项新建虚拟机恢复不支持Hyper-V高版本环境下的备份虚拟机恢复到低版本的环境下。恢复原存储路径时，需选择“强制覆盖”恢复策略，否则恢复失败。多虚拟机同时恢复时，不支持“目标虚拟机名称”。SMB3.0恢复位置存储路径需手动输入，输入格式为：\\IP地址或机器名\SMB挂载路径\目录名4.4.2恢复步骤1、进行浏览恢复界面2、选择要恢复的虚拟机数据源选择客户端后，点击“恢复”，选择要恢复的时间点，如下图：选择需要恢复的数据，见图：3、选择需要恢复到的Hyper-V服务器。选择客户端，点击“浏览”后，如下图所示：4、恢复位置选择恢复位置选择：虚拟机恢复名称选择，如果需要重命名，选择其他名称即可：选择是否“强制覆盖”和“强制开机”，点击完成后开始恢复：注释：如果恢复到原客户端，且原客户端上被备份的虚拟机没有删除，必须勾选强制覆盖，否则无法进行虚拟机恢复。5、开始恢复恢复时的信息如下：如上图所示，开始恢复虚拟机。恢复完成后，这样就完成了虚拟机的恢复。FAQ当环境出现备份或恢复速度较慢，怎样解决?首先查看存储柜的cached值，如果cached值小于6GB时，可以使用以下方法进行性能调优。1.打开/etc/sysctl.conf文件。#vi/etc/sysctl.conf2.修改如下参数的值为下方参数对应的值，如参数名不存在则新增。vm.min_free_kbytes=0vm.swappiness=0vm.vfs_cache_pressure=0vm.dirty_background_ratio=50vm.dirty_ratio=80vm.dirty_writeback_centisecs=100003.保存/etc/sysctl.conf文件，并执行sysctl-p命令。FAQ执行备份时，报错“介质受写入保护”。主要原因1：VSS写入程序已拒绝包含错误0x800423f3，该写入程序暂时性错误。此为Hyper-Vbug，见：http://technet.microsoft.com/en-us/library/dd347840.aspx。解决方法1：重新备份一次。主要原因2：备份虚拟机所在磁盘可用空间不足。解决方法2：请检查磁盘可用空间是否充足，使虚拟机可以正常开机使用后再进行备份。2.恢复时，虚拟机抛错“添加安全属性失败”主要原因：由于目标机器性能不稳定，造成虚拟机第一次恢复时，添加安全属性失败。解决方法：重新恢复一次即可。进行虚拟机恢复时，会有某些虚拟机从windowsserver08或者windowsserver08R2恢复到windowsserver2012的环境时，会导致虚拟机无法正常进入系统（例如：redhat5.3），或者导致蓝屏（例如：window2000sp4）。图一：图二：主要原因：windowsserver08或者windowsserver08R2的guest系统支持redhat5.3或者windows2000sp4。详细支持guest系统见：http://social.technet.microsoft.com/wiki/contents/articles/2761.Hyper-V-supported-guest-os-list.aspx。而windowsserver2012则不支持。详细支持guest系统见：http://technet.microsoft.com/zh-cn/library/hh831531.aspx。解决方法：根据系统版本支持列表进行操作。5.虚拟机从windowsserver08恢复windowsserver08R2，或者同版本见的恢复，恢复成功，但虚拟机处于“saved”，启动虚拟机提示“虚拟机无法启动”。图一：图二：主要原因：Hyper-V不同版本间的兼容性问题。解决方法：1、对已恢复成功，但处于“已保存”状态的虚拟机点击启动，见图：但是启动失败，见图：2、删除保存状态3、重新启动，见图：6.虚拟平台的虚拟机名或者父目录中包含韩文等特殊字符，不能正常显示主要原因：此版本不支持韩文等特殊字符。解决方法：将要备份的虚拟机中韩文等特殊字符改名。7.恢复到新的服务器，虚拟机无法启动，提示“iso文件不存在”，此问题存在2008/2008R2系统，2012及以上系统不存在此问题。主要原因：原始Hyper-V服务器的虚拟机有一个CDISO映像挂接到虚拟CD或DVD驱动器上。在还原虚拟机的Hyper-V服务器上：在备份期间，ISO映像所在的路径与原始Hyper-V主机上的相应路径不同。解决方法：1、连接目标虚拟机。2、将绑定的iso文件从DVD驱动弹出。3、重新启动虚拟机即可。8.恢复到新的服务器，虚拟机无法启动，提示“配置错误或者无法找到对应路径”主要原因：新恢复的Hyper-V服务器，缺少源Hyper-V服务器不一致的路径，或者网卡型号不匹配解决方法：1、检查新Hyper-V服务器，恢复的目标虚拟机网卡匹配是否有效，如果出现“配置错误”，请重新选择新Hyper-V服务器的网卡。2、检查新Hyper-V服务器，恢复的目标虚拟机快照路径配置是否有效，如果源路径在新服务器不存在，请重新配置合适的可用路径。9.虚拟机备份时，抛错“添加快照集失败”。主要原因：执行备份时，通过VSS对目标虚拟机执行快照，没有成功执行快照。原因包括：1、Hyper-V服务器没有足够的磁盘空间。2、有其他程序在调用VSS执行快照任务，导致本次任务执行失败。解决方法：1、确保Hyper-V服务器有足够的空间，以用来存放虚拟机的快照文件。2、执行Hyper-V虚拟机备份任务时，尽量避免有其他应用使用VSS。10.新建Hyper-V任务展开数据源时，抛错“创建备份引擎失败”。主要原因：执行备份时，初始化VSS失败，因为Hyper-V只支持64位客户端。如果安装32位的客户端，则会抛错“创建备份引擎失败”。解决方法：卸载掉32位客户端，安装64位客户端。11.虚拟机备份失败，抛错添加快照集失败，错误码：2147754767。主要原因：这种系统provider错误问题，目前无法修复。解决方法：再次执行备份。AnyBackup5.0最佳实践Hyper-V单机定时备份上海爱数软件有限公司Add：上海市闵行区联航路1188号浦江智谷8号楼2层A座Tel：+86-021-54222601Fax：+86-021-54326440