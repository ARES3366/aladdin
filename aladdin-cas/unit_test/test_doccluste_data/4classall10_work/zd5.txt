mahaoyu信息级别：秘密级版权声明版权所有©2003—2014爱数软件有限公司未经本公司许可，任何单位或个人不得以任何形式，复制、传播、摘抄本文档内容的部分或全部。本文档内容上可能会有增删和修改，爱数软件有限公司会定期将修订后的内容纳入新版本中，如有更改恕不另行通知。关于爱数爱数是中国领先的数据管理解决方案提供商，整体数据管理业务已经遍及全球市场。爱数的数据管理解决方案着眼于企业最核心的资产：数据，并从业务连续性、数据存储、数据保护、非结构化数据管理及数据长期保存五个维度出发，帮助客户解决云化数据中心基础设施层的数据管理需求。在云计算、虚拟化以及BYOD和移动互联四大趋势下，随着IT即服务的目标明朗化，客户的整体建设需求也在顺势而为变的更加关注数据管理服务：高性能可弹性扩展且池化管理的存储多重高效的数据保护方式足够开放和安全的非结构化数据管理我们立足于趋势前沿，紧贴行业市场需求，针对不同的客户定位，基于专业沉淀的技术，通过持续创新产品，提供专业的数据管理解决方案和服务，致力于通过高效的数据管理来帮助用户提升运营效率，并加固业务连续性，其中爱数专业的存储产品AnyStorage助客户解决数据高效存储、数据可用性、数据长期保存的难题；爱数卓越的备份一体机，从超易备到AnyBackup再到TxCloud，提供前端到后端的全面强大的数据安全保障服务，采用多种保护模式从多个维度满足客户数据保护的需求；爱数创新的非结构化数据管理产品AnyShare和易享云，助力客户在新趋势下提升和优化非结构化数据管理效率；爱数增值型云产品基于Tx统一运营管理平台，可助力客户轻松实现共享灾备云和共享文档云，即以SaaS模式提供备份即服务和文档即服务。借助爱数的方案和产品，我们的客户可以从容布局云端，赋予IT战略价值，实现从数据资产到信息资产的跨越，有效提升业务效率。作为备份一体机的首创者和引领者，在IDC2013年关于中国备份一体机市场的研究报告中，爱数以18.5%的市场份额位居中国品牌第一。同年，爱数凭借完整的数据管理解决方案入选GartnerCoolVendor名单。源于优秀的企业运营理念和价值观，包括客户为先、平等尊重、兑现承诺、持续变革、追求卓越，我们一直专注于全球智能数据管理典范企业的愿景践行，致力于为全球各地的客户实现无法想象的IT商业价值。如今，爱数的产品和解决方案已经成功服务于全球上万客户，遍及党政、医卫、涉密、教育、企业以及云服务领域等行业，我们将持续用推动业务转型的革命性创新来成就客户发展，帮助客户迎合行业趋势，驾驭数据未来。目录3关于爱数6一．写作目的6二．目标读者6三．实施版本6四．步骤61.注意事项72.控制台安装103.初始化配置124.创建卷135.修改接收数据IP146.设置自备份计划147.配置告警规则158.创建用户159.安装客户端1710.配置客户端1811.许可证授权1812.校正系统时间1813.重启服务19五．附录191.端口和服务进程一览表222.指纹库所需空间的计算方法233.查看操作系统版本位数254.内存使用指导255.控制台卸载276.RedHat本地yum源搭建方法277.机房搬迁后（控制台IP发生变化）数据恢复一．写作目的指导AnyBackup5.0.2.0的实施工作，介绍从软件安装到配置过程中的注意事项，定义实施标准流程，明确可实施的质量边界。二．目标读者售后实施人员。三．实施版本控制台：爱数备份软件5.0(Version:5.0.2.0.329)客户端：5.0.2.0.329四．步骤1.注意事项1）系统配置要求：两颗4核CPU、内存16GB2）系统内核：不低于2.6.18；版本：64位.3）服务端口不被占用：查看控制台端口4）SELinux状态需为permissive.若不是则有如下两个方法处理：方法一：直接在shell环境下输入如下命令：setenforce0（此种方法无需重启服务器，属于临时解决方法）方法二：修改配置文件，将/etc/selinux/config配置文件，将SELINUX=enforcing改为SELINUX=permissive，然后重启服务器5）系统平台支持（开发版系统即可满足安装软件版控制台）：Redhat564bit、Redhat664bit、CentOS564bit、CentOS664bit、SUSE1164bit6）若需要执行VMware高级备份，则控制台需安装NFS服务。检查及安装步骤详见：2-6）7）重删配置要求：若用户需要购买重删功能，则必须要配置两块400G或800G的SSD硬盘，专用于重删DDCache卷，以便提高重删效率。（SSD硬盘系产品配件）8）磁盘分区挂载到卷目录后，需要手动在/etc/fstab文件中添加挂载路径。如下图：9）如果出现机房搬迁，原有控制台IP发生变动，恢复备份数据前，需要修改一些设置，具体请参照机房搬迁后（控制台IP发生变化）数据恢复2.控制台安装1）root用户登录，上传安装包至控制台机器某个自定义路径。说明：a.建议安装在/home、/mnt、/opt或在根目录下新建目录，不可以安装在/root、/tmp、/bin等系统目录下。b.数据库的data文件、php、nginx的日志文件等，都在安装目录AnyBackupServer下，建议安装空间大于2G。2）使用命令tarzxvfxxx.tar.gz解压安装包。3）解压后的目录为AnyBackupServer，cdAnyBackupServer/app/scrIPts，进入安装脚本所在目录。4）执行安装:./install.sh。确定安装：y，回车添加IPtables（说明Suse1164bit环境无需此步骤）：y，回车5）控制台开始执行安装，并且最终输出安装成功的提示信息。6）若需要执行VMware高级备份，则控制台需安装NFS服务。先确定是否安装NFS包，用rpm-qa|grepnfs-utils命令查看。如果未安装，安装如下:Centos564bit系统安装NFS：yuminstall-ynfs-utilsportmapCentos664bit系统安装NFS：yuminstall-ynfs-utilsrpcbindRedhat564bit系统安装NFS：yuminstall-ynfs-utilsportmapRedhat664bit系统安装NFS：yuminstall-ynfs-utilsrpcbindSuse1164bit系统安装NFSserver，用yast安装nfs-kernel-server包，SUSElinux11的光盘中自带.注意事项：1.NFS需要的rpm包下载地址（此地址仅供参考）：http://rpm.pbone.net/2.一般系统光盘都自带NFS包，从系统光盘安装即可.3.如果无法联网的话，须搭建本地yum源，具体方法详见RedHat本地yum源搭建方法控制台卸载步骤详见附录：控制台卸载3.初始化配置1）控制台安装完成后，在浏览器中访问http://IP:9800（图中IP以192.168.240.62为例），首次访问会弹出初始化配置向导页，选择设置管理控制台IP，点击下一步。2）设置用户密码、邮箱。默认密码均为123456，默认audit用户未启用，此处可设置新密码以及启用用户，也可不修改使用默认设置（根据用户需要设置，建议此处设置新的密码），设置完成后，直接点击下一步。3）创建卷，此处选择存储路径跟介质空间可创建默认OFS介质，以及自备包保存路径。4）创建卷完成后，初始化配置完成，页面跳转到登录界面，使用新密码登录控制台，进入存储管理-介质服务器管理-介质管理，可以看到创建的默认卷；进入运营管理-自备份管理-自备份属性，可以看到自备份包保存路径。介质管理：自备包保存路径：4.创建卷操作路径:登录->存储管理->介质服务器管理->介质管理在初始化配置向导中会默认创建OFS卷，若要创建其他卷或对原有卷进行删除、修改。1）可创建的卷类型包括：OFS卷、挂载卷、DDCache卷。2）编辑卷只能编辑卷容量，相当于卷扩容操作。3）备份软件不同于存储柜，自备份数据卷不需要手动添加，在初始化配置中添加存储路径时默认创建自备份包保存路径，该路径在自备管理中可修改。4）如果用户购买了重删功能，则必须要创建DDCache卷。DDCache卷的作用是提高重删率，DDCache卷只能创建一个，且一旦创建不建议删除，删除后不会对以前数据造成影响，但是会影响后续备份的重删率。DDCache卷的大小约为每1T重删后的数据（无重复块），需要17GB-23GBDDCache空间存放指纹。查看指纹库空间计算方法注意：建议SSD磁盘专用于重删DDCache卷，便于提高重删效率。5）创建挂载卷。如果用户环境中有虚拟化环境需要使用高级备份方式进行备份，且需要使用挂载卷，否则不需要创建此卷。挂载卷的大小根据用户数据的实际大小判定,一般来说，需要备份多大数据量可创建稍微大于该数据量的挂载卷。挂载建只能创建一个。6）创建OFS卷，根据用户需要备份的数据大小及需要保留的副本数大致估算需要的卷空间并建对应大小的OFS卷。OFS卷可创建多个。注意：设置保留副本数时，实际需要预留的空间为副本数+1的数据容量大小。例如，一个副本数大小为10G，设置保留2个副本数，那至少需要预留空间为（2+1）*10G=30G。7）当前版本一个存储路径只能对应创建一个（一次）卷，建议创建卷时按照存储路径中的容量大小建，否则该存储路径剩余空间会被浪费。5.修改接收数据IP操作路径：登录->存储管理->介质服务器管理->系统信息->接收数据IP接收数据IP是指当介质服务器存在多张网卡时，在进行备份时可选择通过指定网卡进行数据传输，默认为127.0.0.1，此IP必须修改才可正常备份。一般需手动输入添加IP地址，IP地址的可选项为介质服务器所有可用网卡IP。（目的不支持多介质服务器，所以此处IP即控制台网卡IP）6.设置自备份计划操作路径：登录->运营管理->自备份管理->自备份属性此处默认策略（推荐设置）为每天备份一次，默认保存7个副本数，建议保留3个，计划备份时间为每天00:00:00。可根据用户的实际需求修改计划配置。7.配置告警规则操作路径：登录->日志和告警->告警管理此处需要根据用户的实际需求进行配置，点击“告警规则”tab，进入告警配置页，可根据需要勾选并启用告警规则。启用的告警规则并不会生效，需要点“配置”按钮添加检查对象以及邮件抄送人，也可点击告警跟规则列表中的级别、告警方式修改告警规则的级别跟告警方式。8.创建用户操作路径：登录->运营管理->用户管理此处根据用户的实际需要进行配置。暂不支持导入域用户。新创建的用户，默认密码为123456。用户登录后可在右上角的个人信息中修改密码。9.安装客户端安装过程不再累述，注意事项如下：1）客户端安装包的位数需要和数据库位数保持一致，如64bit操作系统上安装32位的数据库，则需安装32位的客户端。查看常见数据库/操作系统位数的方法2）在需要备份Gbase、Sybase、Exchange、Domino、MySQL、DB2的环境里安装客户端的时候，检查下客户端上是否有其他备份软件或者是用户自己设置的备份脚本，如果有，最好能停掉，否则可能会有交叉备份导致恢复的不是预期的数据。3）客户端跟控制台不可安装在同一机器上。4）支持客户端安装的操作系统环境见下表。	操作系统	CPU架构	操作系统位数	Windows2003SP1	X86	32	Windows2003SP1	X86	64	Windows2003SP2	X86	32	Windows2003SP2	X86	64	Windows2003R2	X86	32	Windows2003R2	X86	64	Windows2008	X86	32	Windows2008	X86	64	Windows2008SP2	X86	32	Windows2008SP2	X86	64	Windows2008R2	X86	64	Windows2012	X86	32	Windows2012	X86	64	Windows7	X86	32	Windows7	X86	64	Windows8	X86	64	RedHatEnterpriseLinux6	X86	32	RedHatEnterpriseLinux6	X86	64	RedHatEnterpriseLinux5	X86	32	RedHatEnterpriseLinux5	X86	64	CentOS5	X86	32	CentOS5	X86	64	CentOS6	X86	32	CentOS6	X86	64	SUSELinuxEnterpriseServer11	X86	32	SUSELinuxEnterpriseServer11	X86	64	RedFlagLinux6	X86	3210.配置客户端操作路径：登录->备份容灾->客户端用鼠标选中对应的客户端，然后用户可以通过点击齿轮状的按钮进行以下操作：1）配置客户端及客户端组：购买重删模块的用户，需要根据客户端机器的实际可用内存配置客户端进程使用的内存上限，默认值为200MB，此处配置越高效率越高，但是要控制大小，不能超过实际可用内存大小（配置后此客户端上的每个任务都将占用这么多内存）。推荐使用默认配置。推荐使用默认配置。指纹缓存路径使用本地卷，指纹缓存路径所在卷需要的可用空间按【任务数*客户端缓存空间配置大小】预留相应空间硬盘空间。请根据用户的数据量大小设定指纹缓存路径。2）新建虚拟客户端：在此选项中，用户若需要备份双机、集群、Hyper-v和VMware的数据，则需要创建虚拟客户端。否则不需要。11.许可证授权操作路径：登录->运营管理->许可证管理直接添加即可，不再累述。注意在线激活的时候，需要控制台可以连通外网，且已设置可用的DNS。如不能连外网，则使用激活工具激活。12.校正系统时间建议安装完控制台跟客户端后，分别检查其系统时间，若时间不正确，则需手动将时间校正为当前实际时间。13.重启服务操作路径：登录->介质服务器管理->系统信息若控制台出现服务异常，则可在系统信息页选择【重启服务】按钮，进行重启，此功能是重启所有控制台服务（重启服务前确保AnyBackupWebForDataengine、AnyBackupWebForLocal、AnyBackupPHPServer、AnyBackupWebServer这4个服务正常）。也可进入后台/etc/init.d目录进行手动重启，命令：/etc/init.d/AnyBackupXXXXXServer{start|stop|restart|status}五．附录1.端口和服务进程一览表Q：客户端服务器需要确保哪些端口开放？A：9902、9952。Q：控制台需要确保哪些端口开放？A：9800、3345、8500、8510、8520、9952、9902。Q:访问web管理界面的PC机器需要确保哪些端口开放？A：9800、3345、8500、8510、8520、9952。(1)Web服务器a.Nginx服务Web服务器，提供Web门户，RESTful接口转发等进程名称:/AnyBackupServer/app/3rdlibs/nginx/sbin/nginx服务名称:AnyBackupWebServer占用端口:9800b.php-fpm服务提供PHP脚本解析进程名称:/AnyBackupServer/app/3rdlibs/php/sbin/php-fpm服务名称:AnyBackupPHPServer占用端口:3345(2)TornadoWebServer命名规则:8代表web，5代表5r，十位起命名，个位留着用来做nginx的负载均衡a.Serverforlocal通过本地python脚本提供服务的RESTfulAPI进程名称:/AnyBackupServer/app/mgmserver/anybackup/bin/webforlocal服务名称:AnyBackupWebForLocal占用端口:8500b.Serverforthrift通过调用后端thrift接口提供服务的RESTfulAPI进程名称:/AnyBackupServer/app/mgmserver/anybackup/bin/webforthrift服务名称:AnyBackupWebForThrift占用端口:8510c.ServerforDataEngine调用DataEngine的接口提供服务的RESTfulAPI进程名称/AnyBackupServer/app/mgmserver/anybackup/bin/webfordataengine服务名称:AnyBackupWebForDataengine占用端口:8520(3)Python管理服务（内部使用）为C++服务提供数据库访问等管理功能的Thrift接口进程名称:/AnyBackupServer/app/mgmserver/anybackup/bin/thriftpysvc服务名称:AnyBackupThriftPySvc占用端口:9950(4)管理控制台提供客户端管理、更新管理等Thrift接口，维护客户端长连接进程名称:/AnyBackupServer/app/bin/esfdaemonn-fconsoled.config服务名称:AnyBackupBackupServer占用端口1:9951(thrift接口，内部使用)占用端口2:9952(维护长连接)(5)介质服务器提供介质管理thrift接口，同时接收和发送备份数据进程名称:/AnyBackupServer/app/bin/esfdaemon-fmediasvrd.config服务名称:AnyBackupMediaServer占用端口1:9955(thrift接口，内部使用)占用端口2:9902(接收备份数据)(6)mysql数据库服务提供数据库服务，将持久信息保存到数据库里，以便web前端直接从数据库里读取，提高执行效率进程名称:/usr/libexec/mysqld服务名称:AnyBackupDBServer占用端口1:99062.指纹库所需空间的计算方法每个指纹索引占用32字节，每个指纹占用36字节。根据用户的数据选择分片大小，按照每个数据片按照3KB计算，每1TB重删后的数据包含357913941个数据片，换算成指纹及索引的占用为357913941*（32+36）=24338148010B=22.67GB。同理，按照每个数据片按照4KB计算，每1TB重删后的数据需要的17GB存储空间。举例：用户重删后的数据为N，单位为TB。则最大需要：22.67GB*N空间存放指纹，最小需要17*N空间存放指纹。3.查看操作系统版本位数(1)Windows下，在cmd中输入systeminfo命令找到OS版本、系统类型即可确定系统版本、位数(2)Linux下查看版本和位数的方法：注意：也可用getconfLONG_BIT进行判断位数(3)对于应用的版本、位数判断，方法如下：Oracle环境：输入sqlplus/assysdba即可看出版本Sqlserver环境：在查询窗口输入selectSERVERPROPERTY('edition')，执行查询，如果是64位的会有64-bit字样，如果是32位没有输出：注意：也可通过select@@version命令查询版本、位数MySQL环境：在shell终端下输入mysql-V即可4.内存使用指导介质服务器内存消耗：开重删：1G+重删服务器缓存+300M*任务数+3.5G不开重删：1G+200M*任务数源端介质服务单个远程复制任务（同步重删数据）:(1G+单个文件大小/4k*48B)~(1G+单个文件大小/3k*48B)参照值：以远程复制一个1TB的文件为例，源端介质服务器内存占用在12G~16G之间目标端介质服务器内存占用以开启重删/不开重删时内存占用为准客户端内存消耗：开重删：(200M+160M+N)*任务数（N为配置客户端时重删内存空间，默认为200M）不开重删：300M*任务数5.控制台卸载卸载前请作如下工作：进入shell环境，停止AnyBackupMediaServer服务；进入bin目录（如果安装在/opt下，则进入到/opt/AnyBackupServer/app/bin目录），执行./ofsutil-appAnyBackup-clean-force；启动AnyBackupMediaServer服务；进入控制台界面，删除OFS卷、高速缓冲卷、DDCache卷、挂载卷；以下是卸载控制台的步骤：进入解压后的安装目录，cdAnyBackupServer/app/scripts执行./uninstall.sh确定卸载：y卸载完成，卸载成功提示信息：AnyBackupConsolehasbeenremoved.卸载后，删除OFS的配置信息，进入/var/lib/newcore/AnyBackup下，删除所有文件即rm-rf/var/lib/newcore/AnyBackup/*6.RedHat本地yum源搭建方法新建挂载点，作为本地光盘的挂载点，如图所示：新建本地yum配置文件，并且编辑里面的内容,如下所示：保存退出，即输入wq退出；插入系统光盘，将其挂载到/mnt/iso下,如图所示：使用yumlist更新下yum源信息即可。7.机房搬迁后（控制台IP发生变化）数据恢复操作步骤：1）进入客户端，修改客户端配置文件。对于windows系统，点击【开始】-【客户端配置】，进入客户端配置页面，修改服务器IP为当前控制台IP；对于linux系统，修改clientsetting.config中targetIpAddr为当前控制台IP；2）登录控制台，进入【介质服务器管理】-【网络管理】-【接收数据IP】，添加当前控制台IP作为新的接收数据IP，此处需要注意，无法将原有的接收数据IP编辑为当前控制台IP，因为这个IP跟对应的备份任务之间有关联。3）登录控制台，进入【介质服务器管理】-【备份恢复】，选中备份任务，点击【编辑】，修改接收数据IP为当前控制台的接收数据IP。注意：如果不做以上处理，是无法恢复控制台IP发生变动前的备份数据，这一点需要特别注意。AnyBackup5.0.2.0备份软件实施指导文档地　　址：上海市联航路1188号浦江智谷8号楼2层邮　　编：201112咨询热线：021-54222601服务热线：400-880-1569官方主页：�HYPERLINK"http://www.eisoo.com/"�http://www.eisoo.com�微博主页：�HYPERLINK"http://e.weibo.com/eisoosoftware"�http://e.weibo.com/eisoosoftware�I