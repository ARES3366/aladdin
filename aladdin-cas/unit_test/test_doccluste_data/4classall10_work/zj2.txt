(最佳实践)(最佳实践)	AnyBackup5.0.2.0最佳实践DB2定时备份目　录目　录	2第一章概览	41.1简介	41.1.1DB2备份	41.1.2DB2恢复	51.2DB2定时备份支持功能	5第二章限制性列表	6第三章客户端安装	73.1Windows客户端安装	73.1.1Windows环境确认	73.1.2Windows客户端安装	83.2Linux客户端安装	133.2.1Linux环境确认	133.2.2Linux客户端安装	143.3客户端配置	15第四章DB2备份环境检查	174.1Windows环境备份前置条件检查	174.1.1确认系统环境变量中包含了DB2的bin目录	174.2Linux备份前置条件检查	184.3介质服务器检查及配置	19第五章定时备份最佳实践	205.1DB2定时备份最佳实践	205.1.1命名规则说明	205.1.2定时备份任务建立	21第六章定时恢复最佳实践	326.1DB2恢复概述	336.2DB2故障诊断及恢复方式选择	336.3普通恢复	336.3.1恢复注意事项	336.3.2恢复步骤	34第一章概览1.1简介本文档是爱数备份容灾家族DB2一体化备份恢复最佳实践文档，主要描述了如何正确地使用爱数备份容灾家族产品成员进行DB2数据备份的方法，包括部署前后的注意事项和典型部署方案。DB2是IBM公司研制的一种关系型数据库系统，主要应用于大型应用系统，具有较好的可伸缩性，可支持从大型机到单用户环境，应用于OS/2、Windows等平台下。DB2所包括的产品有：服务器版、个人版、开发版、连接产品、客户端。DB2数据库本身提供了离线（脱机）和在线两种备份方式,爱数产品运用了DB2的在线备份方式。其中，在线备份包括三种备份类型：完全备份、增量备份和差分备份。1.1.1DB2备份完全备份将选定的数据源完全备份到指定目的地的备份集中。每次执行时，它不会根据最新的变动比较后进行备份，而是直接将所有的数据备份到OFS介质中，并产生一个时间点，用于记录备份的类容。增量备份是基于上一次完全备份，把数据源备份到OFS介质中，只备份文件内容有变动以及新增的文件，从而避免完全相同的文件重复的备份，同时产生一个时间点，以便恢复使用。在尚未进行完全备份的情况下，进行增量备份时会自动转会为完全备份。差异备份是基于上一次备份（可以是完全也可以是增量），备份新增的数据到OFS介质中，同时产生相应的时间点。1.1.2DB2恢复1.DB2标准恢复使用之前的数据库备份集来实现数据库的还原，然后使用归档日志及联机日志将数据库恢复到最新及指定时间点的状态，恢复时需要将停止数据库的生产业务；1.2DB2定时备份支持功能	功能	子功能	支持	备注	备份类型	完全备份	√			增量备份	√			差异备份	√		循环备份		√	完全备份、增量备份、差异备份相结合的循环	客户端自动搜索实例		√		客户端多实例备份恢复		√	每个任务只能支持一个实例	浏览恢复		√		异机恢复		√		恢复粒度		√	整个实例、单个数据库	指定恢复数据库名		√	支持恢复数据库时恢复为新数据库名	指定位置恢复		X	只能恢复到数据库原位置	灾难恢复		√	第二章限制性列表1、不支持64位系统恢复到32位系统，支持32位系统恢复到64位系统。2、不支持单表空间备份。3、不支持多实例备份。4、不支持跨DB2版本的恢复。5、不支持跨平台恢复（Windows、Linux不支持任意两个平台互相恢复）。6、恢复错误的指定时间点，报错‘日志前滚操作失败，1276‘。7、异机恢复-恢复到指定时间点和恢复最新可用状态都只能恢复到当时备份状态。8、Linux下欲执行DB2备份，安装客户端时必须在root用户下选择DB2选项安装。9、不支持多分区数据库。10、不支持指定位置恢复。11、不支持对同一数据库执行交叉备份。12、要求备份和恢复端的实例名，用户名和密码一致，缺一不可。13、建立和执行备份任务时，要求启动数据库服务，否则不能添加数据源。14、不支持DB2v8.2、DB2v10.5版本的备份和恢复。第三章客户端安装3.1Windows客户端安装确定客户端安装包，需要确定用户环境中操作系统的位数以及数据库的位数，同时对于少数用户出现在64bit的操作系统上安装32bit的数据库的情况，需要安装和数据库位数相同的包，即需要安装32bit的客户端安装包：3.1.1Windows环境确认cmd中，运行systeminfo命令，查看详细系统版本信息，如下：Cmd命令行中，登录DB2数据库,使用db2level命令，查看DB2数据库的版本，如果为64位数据库则会出现“64”位字样，若为32位数据库则会出现“32”位字样：3.1.2Windows客户端安装1.双击windows客户端安装程序，进入安装向导界面2.点击下一步，指定安装路径3.点击下一步，输入服务器端IP4.点击下一步，选择是否安装iSCSIInitator工具(当前系统非2000、2003或xp系统，iSCSI选项不可选)，若是2000,2003或者XP系统安装客户端，备份恢复DB2数据库可以默认不勾选。定时备份不需要安装卷CDP驱动。5.点击下一步进行安装，直至完成3.2Linux客户端安装3.2.1Linux环境确认在root用户下用命令uname–a，查看操作系统位数，i686,i386字样的为32bit操作系统，输出有x86_64的为64bit操作系统：[root@localhost~]#uname-aLinuxlocalhost.localdomain2.6.18-92.el5#1SMPTueApr2913:16:12EDT2008i686i686i386GNU/Linux在root用户下用命令cat/etc/issue，查看操作系统发行版本，我们的客户端支持redhat5、6,suse11，均使用相同的安装包[root@localhost~]#cat/etc/issueRedHatEnterpriseLinuxServerrelease5.2(Tikanga)Kernel\ronan\m在安装DB2数据库的用户下，用db2level查看数据库版本及位数，如果为64bit的数据库，在登录时，会有64bit字样，否则为32bit数据库：3.2.2Linux客户端安装root用户下，在根目录下，创建eisoo文件夹；将确定好的客户端安装包上传到eisoo目录下，然后用tar–zxvfpackage_name的方式解压；[root@localhosteisoo]#tarzxvfAnyBackupClient_Redhat_5_x64-5.0.1.0-20140725-release-2373.tar.gz切换到客户端安装文件夹的bin目录下，运行脚本./install.sh；[root@localhostbin]#cdAnyBackupClient_Redhat_5_x64/app/bin/[root@localhostbin]#./install.sh在客户端安装过程中，安装程序会检测安装条件是否满足，在条件不满足时，需要手动调整或者选择让程序自行调整，调整完成后，安装任务继续；第一步，填写自己的IP地址，针对一个服务器有多个网卡的情况，通过输入此IP，可以使备份数据通过指定的网卡备份，同时在控制台中显示时，显示该IP地址；第二步，填写控制台的IP地址；第三步，选择支持的数据库，在做DB2备份时，需要选择DB2；选择DB2数据库后，程序要求输入安装DB2数据库的用户名；第四步，输入libdb2.so文件的路径，此处需要注意路径中不要包含此文件名；第五步，确认选择无误后，输入y，确认安装；如果之前选择有误，可以输入no退出安装，然后重新运行安装脚本；FAQS:务必将客户端安装在新建的eisoo目录下，因为客户端安装会修改客户端所在目录的权限，如果安装在系统目录下，系统目录的权限可能会被修改造成系统问题或者用户应用出现问题；3.3客户端配置在浏览器上输入http://IP:9800/的方式，然后用用户名和密码登录控制台；点击数据保护，客户端名称中，可以查看新安装的客户端；将鼠标放在客户端上，可以查看客户端的详细信息，若下图；用鼠标选中对应的客户端，然后用户可以通过点击齿轮状的按钮，可以进行以下操作：新建客户端组：根据向导，建立用户端组后，用户可以采用鼠标拖动的方式，将对应的客户端加入对应的组中；修改名称：默认的名称为操作系统的hostname，而hostname不好识别，用户可以根据需要给客户端命名为一个容易识别的名称，以便管理；配置客户端：该选项，可以配置重删数据任务设置和卷实时任务设置，根据用户的实际资源情况，设置对应的数值即可，其中内存使用限制越大，性能越好；新建虚拟客户端：在此选项中，用户可以选择创建双机、集群、hyper-v和VMware客户端；第四章DB2备份环境检查4.1Windows环境备份前置条件检查4.1.1确认系统环境变量中包含了DB2的bin目录在“我的电脑”上右键单击，选择属性，然后选择“高级”，单击“环境变量”，在Path变量中寻找是否包含有DB2安装目录下的bin目录；提示：DB2安装完毕后系统路径默认已经包含bin目录。4.1.2确认要备份的数据库已经配置成归档模式。在进入db2命令窗口后，输入：db2getdbcfgforsample|find/I"arch"，如果是linux系统，则使用db2“getdbcfgforsample”|grepARCH检查logarchmeth1值是否为目录，其中sample是数据库名（下同）。4.1.3确认要备份的数据库已经将trackmod设置为“on”。在进入db2命令窗口后，输入：db2getdbcfgforsample|find/I"trac"检查跟踪修改的页数是否值为On，其中sample是数据库名。如果是linux系统，则使用db2“getdbcfgforsample”|grepTRACKMOD4.2Linux备份前置条件检查4.2.1确认libdb2.so动态库连接成功。在Anyback的安装目录下输入ll查看，图示：4.2.2确认要备份的数据库已经配置成归档模式。使用db2“getdbcfgfortoolsdb”|grepARCH，toolsdb为数据库名，如下图4.2.3确认要备份的数据库已经将trackmod设置为“on”。使用db2“getdbcfgfortoolsdb”|grepTRACKMOD截图如下图4.3介质服务器检查及配置为保证备份任务可正常执行，在创建DB2备份任务前，请检查介质服务器是否正常。检查方法，可以在登录控制台后，在存储管理，介质服务器管理中查看介质服务器状态及可用空间。第五章定时备份最佳实践5.1DB2定时备份最佳实践5.1.1命名规则说明1.【命名规则】:用户名、任务组、任务等对象命名规则满足：不允许为空，且名称长度必须为3~50个字符；2.【邮件命名规则】:Email地址只能由字母A~Za~z、数字0~9及特殊字符@.-_组成，类似于yourname@domain.com的形式，且最长不能超过50个字符；3.【备注信息规范】：备注信息最大不超过255字符；5.1.2定时备份任务建立1.登录爱数备份控制台，点击数据保护备份管理选中对应的客户端在任务管理中，点击新建按钮选择定时备份选择DB2数据库；2.输入任务名称，在备注处，输入自己想要的备份信息，选择想要的介质服务器作为备份的目的地，信息填写完毕后，点击[下一步]按钮；3.在选项中，填设置想要的备份类型，是否开启高级功能选项，各个选项说明如下：【重复数据删除选项】勾选该选项可以启动源端重复数据删除的功能，该选项，在建立任务后，不能通过修改任务的方式更改此属性；【备份数据保存完全副本数】可以设置用户保留完全副本的个数；设置完成后，点击【下一步】按钮，继续；4.点击“+”号展开数据源，DB2定时备份任务支持自动发现数据源的功能，但是需要手动配置实例名，数据库的用户名和密码，具体如下图；Windows下的默认用户是administrator，linux的默认用户是db2inst1，密码输入完成后可以点击测试按钮，查看配置是否OK，连接测试成功后，点击确定按钮；此时点击“+”号，可以正常展开数据源，选中数据源，然后点击【下一步】继续FAQS：1.如果选中数据源时，有如下报错，标明没有对实例进行授权，即：添加正确的用户名和密码；2.设置计划，在此步骤，用户可以选择定时备份任务的执行策略，如执行什么类型的备份任务、一次性执行、每天执行、没几周执行、每月执行；开始时间为任务生效的时间，可以根据需要设置；高级计划选项，设置好在持续的时间区间内，可以使任务在规定的时间内重复执行；同时在此步骤，可以新建、修改、删除、暂停的功能，点击对应的按钮，即可进行此操作；计划设置特别推荐：DB2的备份类型有3种：完全备份、增量备份、差分备份。完全备份：是对数据库的整个数据及日志进行备份。增量备份：是上一次完全备份以来数据的修改部分及日志。差分备份：是上一次备份以来数据的修改部分及日志，其中差分备份的上一次备份有可能是增量备份。说明：这个概念与其他的文件备份和数据库备份有所区别，请注意。DB2的表空间备份将没有完全、增量、差异之分，当用户选择的是一个数据库下的几个表空间作为数据源时，则不管用户选择的是哪一种备份类型，备份的都将是这几个表空间的数据，及日志文件。针对用户的实际情况，及用户的IO需求、安全需求等，请仔细考虑任务计划策略的设置。在这里，推荐用户能够至少保证一个月的数据安全：1.每周末数据应用比较平缓的时候，进行一次完全备份；2.隔两日晚时进行一次增量备份；3.每日白天，隔一定时间做一次差分备份，比如每日中午、晚上可以各进行一次差分备份；4.设置保留完全备份副本数为4，这样能够保证近28天的数据不会被丢失；5.将日志存放于安全的镜像区域。DB2计划任务新建、修改、删除、暂停全部的功能如下：5.计划设置完毕，如果资源足够，请立即开始一次完全备份。选中任务，点击【发起】按钮，可以看到可以发起的操作类型，点击【备份】按钮，即可开始备份操作；FAQS：·发起备份任务是，提示“请求失败，您没有进行该操作的权限”A:该问题是由于控制台没有进行相关的授权，添加对应的授权后，即可解决；添加授权在控制台界面，【运营管理】【授权管理】中添加，输入对应的授权码，点击在线激活，即可；·在新建任务，展开数据源时，遇到报错，包含‘sql1032n‘，见图:A：没有启动相应数据库实例。window环境下，通过命令提示行输入命令db2cmd或者其他db2连接工具也可，进入db2命令行窗口，执行db2start命令即可；linux环境下，则需要db2的用户名登陆系统后，直接输入db2start即可。·Q：新建任务后，执行备份任务报错“sql2413n“见图：A：没有对数据库TEST进行脱机备份，同时务必注意到对db2的数据库进行联机备份必须先进行归档模式设置。简单说，遇到此报错，在db2命令行窗口，先执行命令db2updatedbcfgforTESTusinglogarchmeth1"Disk:e:\archive”,此命令用于更改归档模式；再执行命令db2backupdatabaseTESTtoe:\backup，此命令用于进行脱机备份。注释：其中TEST和e:\archive,e:\backup分别为示例中的数据名和路径，每个用户的数据库名不是统一的，而且路径名需要用户先新建好。总之，数据库名和路径名是可以改变的，视环境而定。Q:设置归档模式后，备份仍然报错‘sql1116n‘，见图：A:在设置归档模式后，需要重新脱机完全备份一次数据库，修改该类数据库的参数，需要重启数据库。如果仍然出错，请重启爱数备份软件客户端服务。·Q：执行增量备份时，遇到报错‘sql2426n，原因代码=1‘，见图：A：db2进行增量备份，要开启trackmod。即执行命令db2updatedbcfgfordb_nameusingtrackmod“on”。·Q:设置trackmod进行增量备份，任务仍然会报错‘sql2426n，原因代码=1’A:db2的增量备份，需要设置该trackmod选项为on状态。设置完成后，需要做一次脱机完全备份，然后才支持进行增量备份。·Q:任务建立后，执行一段时间后，手动或者db2数据库自动新增量表空间后，执行增量备份失败，报错‘sql2426n，原因代码=2‘见图：A:这是因为不论数据库是否做过设置或备份过，新增表空间后，必须先进行一次完全备份。第六章定时恢复最佳实践6.1DB2恢复概述	AnyBackup5.0版本普通恢复	【普通恢复方式】采用先恢复数据文件，再回滚归档日志的方式恢复数据库；6.2DB2故障诊断及恢复方式选择根据数据丢失范围，分析采用何种恢复措施：1）如果数据库已经毁坏，可以将整个数据库恢复到原位置；2）如果想将原数据库做一个复制，则可以通过恢复数据库，然后选择恢复后的数据库名来进行恢复；3）如果想将整个数据库还原到一个以前的状态，在可以在恢复时指定恢复到时间点来进行恢复。6.3普通恢复6.3.1恢复注意事项1、定时备份异机恢复时，务必要避免此种情况：甲机器上有数据库A，乙机器上也有数据库A，备份数据源为甲上的A数据库，恢复到乙机器上的指定其他位置，新命数据库名B，有可能恢复失败，报错为“sql1001n”或者“sql1005n”，提示数据库名不可用或者数据库名已经存在。2、定时备份恢复时，务必启动db2数据库服务，同时断开与恢复数据有关的所有连接。即在db2命令行窗口，执行命令db2listapplications,查看是否有活动的数据库，然后，在执行命令db2forceapplicationall。3、选择指定时间点恢复时，务必选择要恢复的时间点之后的时间。例如，控制台产生一个备份时间点为2013年1月1日5:30，而db2软件实际完成时间可能2013年1月1日5:31,可以通过命令db2listhistorybackupallforxxxx查看。一般情况，时延不会超过一分钟，所有在指定时间点时，选择2013年1月1日5:31之前的时间点恢复都会报错“指定的日志前滚恢复时间xxxx小于备份时间”。4、异机恢复成功后的数据，要确保此后能正常恢复，务必先进行一次脱机备份，再用此产品操作。5、不支持跨版本跨平台恢复。6、受DB2软件版本的限制，本产品不支持db2跨版本的恢复，也不支持64位数据库恢复32位。7、Linux系统下指定位置恢复时，务必确保db2用户对此目录有执行权限。务必确保恢复时，登陆系统的用户是db2用户。6.3.2恢复步骤备注：windows和Linux只有恢复端的操作系统不一致，控制台的操作步骤一样。故具体的恢复流程均可参考下述恢复步骤。1.点击【任务管理】中的【发起】->【浏览恢复】，在恢复页面中选择要恢复数据源2.点击【恢复】按钮，选择要恢复的时间点及数据注意：如果是要恢复到最新状态，推荐选择最新时间点。因为在多次恢复过程中，其他时间点恢复到最新状态的日志被截断，恢复成功的数据实际上是当时备份的数据，并不是最新的。3.选择恢复位置，默认为恢复至原客户端原位置，恢复为原数据库名称此处，可以选择恢复至其他客户端，可以指定目标数据库的名称4.选择好数据源后，确定要恢复的时间点。FAQS：·Q:覆盖恢复到原数据库时会有警告信息‘sql2539w‘，见图：A：恢复前请选择恰当的恢复位置及数据库名。此处警告不影响恢复结果。·Q:恢复时如果有程序连接，在恢复时，任务会出错‘sql1035n‘，见图：A:如果需要恢复数据，请连接数据库，检查是否有进程连接。检查命令为：db2listapplications如果有进程连接，请确认该进程无用的时候，再使用命令：db2forceapplicationsall将所有的进程退出后，再进行数据库恢复。·Q：恢复时，如果遇到断网，控制台崩溃，介质服务器离线，客户端死机等异常情况造成的任务失败，等环境稳定后，重新执行恢复任务失败，且报错‘sql2574n‘。A：这是因为在第一恢复时，由于出现异常情况，导致恢复的数据库已经损坏，不可用。此时只能先将被损坏的数据库drop掉，再重新恢复。·Q:删除归档日志后，恢复到任意时间点时会出错A:这是因为最后数据库日志前滚的时候出了问题。无法找到指定的日志了。请尝试恢复到最新可用状态。·Q:DB2定时备份，在备份时出现异常（包括断网，重启存储柜等），导致备份失败，且重新备份仍然可能导致失败。且抛错‘提示读取的信息id不一致’A:这主要是因为异常导致备份软件与DB2的备份后端进程还在导致。如果DB2版本是v9.5或者v9.7。找到如下图的进程db2vend，杀掉该进程即可。·Q:恢复到最新可用状态后，发现数据库与备份时有些差别A:这是因为当恢复到最新可用状态，日志在前滚之后会将备份后具体化的日志的事务也实现。可以选择备份后且在做其他操作之前的时间点进行恢复。备注：·Q:在执行备份或者回复的任务中，遇到有关db2的sql语句报错怎么办A：通过ibm中国官网http://www.ibm.com/cn/zh/，锁定报错的代码号，进一步可以查询到可能导致任务失败的各种原因，以及对应原因的解决方法。Q:当环境出现备份或恢复速度较慢，怎样解决?首先查看存储柜的cached值，如果cached值小于6GB时，可以使用以下方法进行性能调优。1.打开/etc/sysctl.conf文件。#vi/etc/sysctl.conf2.修改如下参数的值为下方参数对应的值，如参数名不存在则新增。vm.min_free_kbytes=0vm.swappiness=0vm.vfs_cache_pressure=0vm.dirty_background_ratio=50vm.dirty_ratio=80vm.dirty_writeback_centisecs=100003.保存/etc/sysctl.conf文件，并执行sysctl-p命令。(WWW.EISOO.COM)(8/54)