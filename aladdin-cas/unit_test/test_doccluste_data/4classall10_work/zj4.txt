(最佳实践)(最佳实践)	AnyBackup5.0.2.0最佳实践ExchangeServer数据库定时备份目　录目　录	2第一章概览	41.1简介	41.1.1ExchangeServer备份	51.1.2ExchangeServer恢复	51.2ExchangeServer定时备份支持功能	5第二章限制性列表	6第三章客户端安装	73.1客户端安装	73.1.1开始之前	73.1.2安装	7客户端配置	11第四章ExchangeServer备份环境检查	124.1备份前置条件检查	124.1.1数据库状态检查	124.1.2客户端版本	124.2介质服务器检查及配置	12第五章定时备份最佳实践	135.1ExchangeServer定时备份最佳实践	135.1.1命名规则说明	135.1.2定时备份任务建立	13第六章定时恢复最佳实践	206.1浏览恢复应用场景及恢复方式选择	206.2ExchangeServer定时恢复最佳实践	206.2.1普通恢复注意事项	206.2.2恢复步骤	20第一章概览1.1简介本文档是爱数备份容灾家族ExchangeServer一体化备份恢复最佳实践文档，主要描述了如何正确地使用爱数备份容灾家族产品成员进行ExchangeServer数据备份的方法，包括部署前后的注意事项和典型部署方案。MicrosoftExchangeServer是一个主面的Internet协作应用服务器，适合有各种协作需求的用户使用。ExchangeServer协作应用的出发点是业界领先的消息交换基础，它提供了业界最强的扩展性、可靠性、安全性和最高的处理性能。ExchangeServer提供了包括从电子邮件、会议安排、团体日程管理、任务管理、文档管理、实时会议和工作流等丰富的协作应用，而所有应用都可以从通过Internet浏览器来访问。ExchangeServer是一个设计完备的邮件服务器产品，提供了通常所需要的全部邮件服务功能。除了常规的SMTP/POP协议服务之外，它还支持IMAP4、LDAP和NNTP协议。ExchangeServer服务器有两种版本，标准版包括ActiveServer、网络新闻服务和一系列与其他邮件系统的接口；企业版除了包括标准版的功能外，还包括与IBMOfficeVision、X.400、VM和SNADS通信的电子邮件网关，ExchangeServer支持基于Web浏览器的邮件访问。ExchangeServer数据库的存储结构由四大部分组成：邮箱存储（MailboxStore）、公用文件夹存储（PublicFolderStore）、事务日志文件（TransactionLog）、域控制服务器的系统状态（SystemState）。邮件的数据、公用数据夹数据与分别存放在MailboxStore与PublicFolderStore中。ExchangeServer的数据库（store）是由两个档案所组成：丰富文本文件（扩展名为.EDB），它存放了每封邮件讯息和MessageApplicationProgrammingInterface（MAPI）的内容。另一个则为原始内容「数据流（Stream）」档案（扩展名为.STM），它保存了所有非MAPI的信息。因此，信箱存放区是由Priv1.edb和Priv1.stm。公用数据夹存放区是由Pub1.edb和Pub1.stm组成。每一个Store里都有这两个档案，且ExchangeServer将这两个档案视为一组。所以每一个存放区（Store）的大小，就是将丰富文本文件、原始内容文件、和事务日志文件组合在一起后的大小。这两种数据都以ExtensibleStorageEngine（ESE）数据库格式存放。1.1.1ExchangeServer备份Microsoft®ExchangeServer主要包括两种备份方式：完全备份和增量备份。下面简单介绍这两种备份方式。完全备份备份被选中的数据库的数据信息，包括数据库文件、日志文件和检查点文件。与增量备份相比，完全备份中的每个备份使用的存储空间更多，花费的时间也更多，所以完全备份的创建频率通常比增量备份低。增量备份增量备份是备份自上次完全备份后的所有更改，仅仅备份事务日志文件而不备份当前数据库，并且不截断日志。该次完全备份称为增量备份的“基准”。在还原增量备份时，首先会还原其基准备份，然后依次还原离基准备份最近的增量备份。相比之下，还原增量备份会花费更多的时间。1.1.2ExchangeServer恢复通过浏览恢复，恢复备份时间点。1.2ExchangeServer定时备份支持功能	功能	子功能	支持	备注	备份类型	完全备份	√			增量备份	√		循环备份		√	完全备份、增量备份相结合的循环	客户端自动搜索实例		√		客户端多实例备份恢复				浏览恢复		√		异机恢复				恢复粒度		√	ExchangeServer2007粒度为单个存储组；ExchangeServer2010粒度为单个数据库	指定恢复数据库名		X	第二章限制性列表1、不支持异机恢复。2、不支持同一数据库同时创建多个定时备份任务。3、建立、执行备份任务和恢复任务时，要求启动相关服务，且writer组件正常可用。4、建立、执行备份任务时至少有一个数据库是装载状态。第三章客户端安装3.1客户端安装3.1.1开始之前1、客户端包括32-bit和64-bit两种类型，如果您使用的数据库为32-bit版本，则您应该使用32-bit的客户端；如果您使用64-bit的数据库，您应该使用64－bit的客户端，如果您64bit的操作系统上安装32bit的数据库的情况，需要安装和数据库位数相同的包，即需要安装32bit的客户端安装包。3.1.2安装Windows客户端安装方法点击【安装】如下点击【下一步】可以选择【更改】安装位置。更改好安装位置后，继续【下一步】，如下图：指定好服务器IP和客户端IP地址后继续【下一步】如下图：选择是否安装iSCSIInitator工具和卷CDP驱动。当前系统非2000、2003或xp系统，iSCSI选项不可选,若是在2000,2003或者XP系统安装客户端，定时备份恢复ExchangeServer数据库可以默认不勾选，定时备份不需要安装卷CDP驱动，确定后进行【下一步】，如下图：点击【安装】，开始安装，如下图：安装完成后，点击【完成】【关闭】退出向导。向导中的每一步都可以【取消】或者进行【上一步】回退操作。客户端配置在浏览器上输入http://IP:9800/的方式，然后用用户名和密码登录控制台；点击备份容灾，客户端名称中，可以查看新安装的客户端；将鼠标放在客户端上，可以查看客户端的详细信息；用鼠标选中对应的客户端，然后用户可以通过点击齿轮状的按钮，可以进行以下操作：新建客户端组：根据向导，建立用户端组后，用户可以采用鼠标拖动的方式，将对应的客户端加入对应的组中；修改名称：默认的名称为操作系统的机器名，而机器名不好识别，用户可以根据需要给客户端命名为一个容易识别的名称，以便管理；配置客户端：该选项，可以配置重删数据任务设置和卷实时任务设置，根据用户的实际资源情况，设置对应的数值即可，其中内存使用限制越大，性能越好；新建虚拟客户端：在此选项中，用户可以选择创建双机、集群、hyper-v和VMware客户端；第四章ExchangeServer备份环境检查4.1备份前置条件检查4.1.1数据库状态检查在进行ExchangeServer数据库备份时，需先检查：1、writer组件正常（检查方法见后面FAQ中WRITERCOMPONENT相关部分）2、数据库可正常装载卸载3、复制服务、信息存储服务为启动状态4.1.2客户端版本爱数备份软件客户端包括32-bit和64-bit两种类型，如果您使用的ExchangeServer为32-bit版本，则您只能使用32-bit的客户端(即使是在64位操作系统上，也只能使用32-bit的客户端)；如果您使用的ExchangeServer为64-bit版本,请使用64-bit的客户端。·如果您使用的客户端版本位数和备份的ExchangeServer版本位数不一致，可能会导致无法展开数据源。·客户端ExchangeServer的数据文件、系统文和日志文件路径下不可以有自定义的*.chk文件。4.2介质服务器检查及配置为保证备份任务可正常执行，在创建ExchangeServer备份任务前，请检查介质服务器是否正常。检查方法，可以在登录控制台后，在存储管理，介质服务器管理中查看介质服务器状态及可用空间；第五章定时备份最佳实践5.1ExchangeServer定时备份最佳实践5.1.1命名规则说明1.【命名规则】:用户名、任务组、任务等对象命名规则满足：不允许为空，且名称长度必	须为3~50个字符；2.【邮件命名规则】:Email地址只能由字母A~Za~z、数字0~9及特殊字符@.-_组	成，类似于yourname@domain.com的形式，且最长不能超过50个字符；3.【备注信息规范】：备注信息最大不超过255字符；5.1.2定时备份任务建立1.登录爱数备份控制台，点击【数据保护】【备份管理】选中对应的客户端在任务管理中，点击新建按钮选择定时备份选择ExchangeServer数据库；2.输入任务名称，在备注处，输入自己想要的备份信息，选择想要的介质服务器作为备份的目的地，信息填写完毕后，点击[下一步]按钮；3.在选项中，填设置想要的备份类型，是否开启高级功能选项，各个选项说明如下：【重复数据删除选项】勾选该选项可以启动源端重复数据删除的功能，该选项，在建立任务后，不能通过修改任务的方式更改此属性；【备份数据保存完全副本数】可以设置用户保留完全副本的个数；【启用高级备份（邮件级备份恢复）】ExchangeServer数据库定时备份不用勾选此选项，如果勾选则为ExchangeServer高级定时备份（邮件级备份恢复）且不可以修改回来。设置完成后，点击【下一步】按钮，继续；4.点击“+”号展开数据源，ExchangeServer定时备份任务支持自动发现数据源的功能，具体如下图；此时点击“+”号，可以正常展开数据源，选中数据源，然后点击【下一步】继续;5.设置计划，在此步骤，用户可以选择定时备份任务的执行策略，如执行什么型的备份任务、一次性执行、每天执行、每几周执行、每月执行；开始时间为任务生效的时间，可以根据需要设置；高级计划选项，设置好在持续的时间区间内，可以使任务在规定的时间内重复执行；同时在此步骤，可以新建、修改、删除、暂停的功能，点击对应的按钮，即可进行此操作在设置【开始时间】时，爱数存储柜建议您尽量在服务器空闲时进行备份操作；另外，在设置【备份数据保存完全副本数】时，可在综合考虑您的存储空间和数据需求等因素后进行合理的设置。设置完成后，单击【完成】按钮，退出备份任务向导。提示：在设置“备份数据保存完全副本数”时，可能会出现这样的错误操作。假设这样一个场景，使用者tom设置“最大保存完全副本数”为2，备份策略是每隔3个小时进行一次完全备份，上午8：00备份任务开启，下午2：00时，就会出现两个完全备份集。按照备份策略，下午2：00会进行一次完全备份，因为tom设置只保留2个完全备份集，所以下午2：00产生的这个完全备份集就会覆盖上午8：00的完全备份集，造成数据丢失。所以请您在考虑完全备份操作执行的时间间隔因素后，再设置合理的备份策略。ExchangeServer计划任务新建、修改、删除、暂停全部的功能如下：6.在任务创建完毕后，如果觉得任务配置信息有误，可以在选中该任务，并点击“编辑”按钮，进行编辑；编辑的步骤，和创建任务的步骤基本相同；7.计划设置完毕，如果资源足够，请立即开始一次完全备份。选中任务，点击【发起按钮，可以看到可以发起的操作类型，点击【备份】按钮，即可开始备份操作；FAQS：·Q：在新建任务，展开数据源时，遇到报错，，见图:A:没有装入的数据库或存储组，请确保数据库服务正常，且数据库或存储组是装入状态。·Q：备份失败，提示没有找到匹配的WRITERCOMPONENTA：这是由于卷影复制服务管理工具命令行里面没有MicrosoftExchangeServerWriter，可以在命令提示符里输入命令vssadminlistwriters查看您重启ExchangeServer信息存储服务即可。·Q：备份失败，没有找到匹配的COMPONENTA：所备份的服务器的所有数据库均处于卸载状态，您可以选择一个数据库装载，或者新建一个数据库。·Q：备份失败，提示给定的备份数据源只支持整个服务一起备份A：ExchangeServer2007：不同存储组下的数据库的数据库文件放在同一个文件夹下，备份时数据源不是整个服务器。ExchangeServer2010：不同数据库的数据库文件放在同一个文件夹，备份时数据源不是整个服务器。所以，修改任务的数据源为整个服务器，或者，修改数据库的存储路径（将不同存储组下的数据库的数据库文件放在不同的位置（ExchangeServer2007），或者将不同数据库的数据库文件放在不同的位置（ExchangeServer2010））即可。第六章定时恢复最佳实践6.1浏览恢复应用场景及恢复方式选择根据数据丢失范围，分析采用何种恢复措施：1）如果数据库已经毁坏，可以将整个数据库恢复到原位置；2）如果只是部分数据丢失则选择时间点进行浏览恢复。6.2ExchangeServer定时恢复最佳实践6.2.1普通恢复注意事项1、定时备份恢复时，务必启动ExchangeServer数据库服务。2、受ExchangeServer软件版本的限制，本产品不支持ExchangeServer跨版本的恢复。3、ExchangeServer数据库的备份恢复时，ExchangeServer数据文件、日志文件、系统文件路径下：1.以E或e开头并.log结尾的用户自定义文件恢复后会被删除（联机恢复/不联机恢复相同）恢复后数据库可用；非e或E开头的log文件不会被删除或覆盖2.所有用户自定义的*.edb文件都会备份，被备份的*.edb文件恢复后会覆盖现有文件，恢复增量备份的数据时，自定义的*.edb文件数据不会恢复回来3.不能有自定义的*.chk文件4.其他格式的文件没有被覆盖，也不会被删除6.2.2恢复步骤1.点击【任务管理】中的【浏览恢复】，在恢复页面中选择要恢复数据源2.点击【恢复】按钮，选择要恢复的时间点及数据3.选择恢复位置，默认为恢复至原客户端原位置，恢复为原数据库名称4.选择恢复策略，默认不勾选恢复后使数据库联机。6.点击完成，创建恢复任务成功，可以在【任务监控】界面查看到创建的恢复任务FAQS：·Q:恢复后，手动装载数据库失败数据库重建，恢复备份数据，手动装载数据库，装入数据库失败，如下图所示A:装载数据库失败的原因有很多，如果出现图中的错误描述（hr=0x80004005,	ec=1011），则是由于数据库的GUID不一致导致。可以在手动装载之前，右击对应数	据库的属性，勾选【还原时可以覆盖此数据库】选项。·Q：利用OutlookWebApp访问邮箱，提示无法访问ActiveDirectory资源数据库和邮箱重建后，恢复备份数据，手动装载数据库，然后利用OutlookWebApp访问邮箱，提示无法访问ActiveDirectory资源。A：1.数据恢复成功后，在ActiveDirectory里添加于之前一模一样的用户（先删除刚才重建的邮箱（包含用户））；2.在【收件人配置】里面点击【断开连接的邮箱】，如果没有出现已被删除的邮箱，可在ExchangeServerManagementShell（或ExchangeServer命令行管理程序）中输入命令：	Clean-MailboxDatabase–Identity“MailboxDatabaseName”（将	MailboxDatabaseName替换成恢复的邮箱数据库的名字）；3.刷新【断开连接的邮箱】界面，右击邮箱，点击【连接】，按照提示（选择【匹配用户】）操作即可；如果该数据库中包含多个邮箱，需要对每个邮箱执行上述操作；4.重启ActiveDirectory域控制器和ExchangeServer服务器（注意，应先将服务器关机，然后重启域控，之后再将服务器开机）。如果用户登录不上可以少等待几分	钟即可。注意：此种方法只在【保留已删除的邮箱期限】时间内有效，具体设置界面见下图·Q：ExchangeServer2007在发件箱或收件箱中删除邮件，立即恢复备份时间点，删除的邮件没有恢复回来。ExchangeServer2007备份完后，用户登陆在发件箱或收件箱中删除邮件，然后立即	恢复刚才备份的时间点，恢复后手动装载数据库，发现删除的邮件没有出现发件箱或收	件箱中。A:1.等一段时间（取决于机器的性能，一般1~2分钟）再恢复一次；2.从【已删除邮件】邮件里面将邮件直接移到发件箱或者收件箱中。·Q：ExchangeServerDAG恢复后装载部分数据库失败。ExchangeServerDAG备份数据库，恢复备份数据到主动副本所在的服务器，装载数据库失败，如下图A：装载数据库失败的原因有很多，如果出现图中的错误描述（hr=0x80004005,ec=-515），则可以尝试将日志E0n.log（其中n为0,1,2,……）剪切到另一个位置，然后再装载。·Q:恢复ExchangeServer增量备份时间点失败，提示获取ExchangeServer数据库失败。可能原因及解决方法：1.备份的ExchangeServer版本为ExchangeServer2007SP1及以下，并且日志信息中有类似下图的错误如果出现这种问题，请将ExchangeServer2007升级到SP2及以上。要恢复的ExchangeServer数据库无法卸载，可以打开ExchangeServer管理控制台，手动卸载对应的数据库。如果出现这种问题，可以查看系统日志，了解ExchangeServer数据库不能卸载的具体原因，一般可以通过重新启动信息存储服务解决此类问题。·Q：恢复前改变了数据库.edb文件路径的话，恢复后数据库装载不上A：恢复前改变了数据库.edb文件路径的话不可以联机恢复，否则恢复后无法装载上数据库不联机恢复成功后，需要手动将恢复的文件拷贝到新的路径中(一定要先拷贝后装载，否则还是装载不上)（因为如果恢复装载的话会产生新的日志，即使此时将恢复的文件拷贝到新位置，也会因记录的文件信息与实际日志信息不一致而装载失败）·Q：删除存储组后重新建一个同名的存储组，恢复出现无法装载数据库A:原因新建一个同名的存储组后检查点文件*.chk改变操作步骤：1.环境：ExchangeServer有存储组test1，其检查点为E01.chk，执行完全备份2.如果用户此时删除了存储组test1，之后又新建了存储组test2，之后又重新建了test1存储组（此时存储目录下的简查点文件可能变为E03.chk）3.将此路径下所有文件拷贝一份到临时文件夹中，执行不联机恢复后此时请不要装载数据库，将临时文件拷贝回来即可·Q：ExchangeServer数据库的恢复后以E或e开头并.log结尾的用户自定义文件恢复被删除A：因为ExchangeServer数据库文件格式为*.edb,e*.log,*.chk，备份时将备份这些文件，所以ExchangeServer数据库路径下最好不要有用户自定义文件，如果有用户自定义文件的格式符合ExchangeServer文件格式：1.以E或e开头并.log结尾的用户自定义文件恢复后会被删除（联机恢复/不联机恢复相同）恢复后数据库可用；非e或E开头的log文件不会被删除或覆盖2.所有用户自定义的*.edb文件都会备份，被备份的*.edb文件恢复后会覆盖现有文件，恢复增量备份的数据时，自定义的*.edb文件数据没有恢复回来(因为增量备份只备份日志文件，不会备份*.edb文件)3.不能有自定义的*.chk文件4.其他格式的文件没有被覆盖，也不会被删除·Q：如果数据源只选择部分数据库，其中有卸载的数据库，此时编辑任务时不显示被卸载的数据库，但在任务的数据源列表中还是会显示此数据库A：数据源列表中已记录新建任务时的数据库，应该显示。·Q：控制台删除公共文件夹，后执行不联机恢复，恢复成功，但控制台界面不可以看到此数据库A：控制台删除公共文件夹，后执行不联机恢复，恢复成功，但控制台界面不可以看到此数据库，此时剪切此恢复数据到临时文件位置，重新建此同名公共文件夹数据库，卸载此数据库后删除所有数据，再将临时文件位置的数据拷贝到此，右键属性，允许覆盖，再重装即可。·Q：当一个存储组下有数据库是卸载状态时，只备份其日志文件A：一个存储组下有数据库是卸载状态的，当数据库不在同一路径下时，备份时只备份装载状态的数据库文件.edb,非装载状态的数据库的edb文件不会被备份，只备份log日志文件；当数据库在同一路径下时可以备份其数据文件。·Q：ExchangeServer2007增量备份有新增数据数，再恢复之前备份的数据出现新增数据库装载不上操作：1、ExchangeServer中有数据库A，执行完全备份2、新增数据库B执行增量备份，3、恢复完全备份的数据A：１、您需要卸载B数据库后再执行恢复，如果未卸载则恢复失败，提示请tmp日志文件被占用，需先卸载Ｂ数据库。2、恢复完全备份数据只恢复A数据库，此时B数据库可能会无法装载成功，因为Exchange2007的A和B两个数据库都在同一存储组下，共享着日志文件，此时完全备份的数据中没有B数据库相关信息，所以会出现装载不上。建议您可以在恢复前执行一次完全备份。·Q：ActiveDirectory和ExchangeServer完全重装且路径都改变后，再次恢复ExchangeServer数据库的数据，用户组织结构丢失、用户权限丢失A：１、ActiveDirectory和ExchangeServer重装前先备份ActiveDirectory和ExchangeServer数据库数据·2重装完后先恢复ActiveDirectory再恢复ExchangeServer数据库即可。如果ActiveDirectory路径改变，则不可以直接恢复ActiveDirectory，方法一：可以通过命令修改方法二：可以新建同名用户，然后新建此用户的邮箱，但此方法会导致ActiveDirectory用户的组织结构丢失、用户权限丢失。·Q:ExchangeServer中用户邮箱被删除，恢复数据数据库后,用户邮箱不存在或新建用户和用户邮箱后原先的邮箱数据丢失A:不要直接新建用户和用户邮箱；可以在AcitiveDirectory中新建同名用户，在ExchangeServer的【收件人配置】-【已断开连接的邮箱】选中此用户右击【连接】即可找回之前的用户邮箱数据。(WWW.EISOO.COM)(8/54)