(最佳实践)(最佳实践)	AnyBackup5.0.2.0最佳实践ActiveDirectory定时备份目　录目　录	2第一章概览	41.1简介	41.1.1ActiveDirectory备份	41.1.2ActiveDirectory恢复	41.1.3任务管理	41.1.4重复数据删除	51.2ActiveDirectory定时备份支持功能	5第二章限制性列表	6第三章客户端安装	73.1安装部署	73.1.1开始之前	73.1.2安装	73.2客户端配置	12第四章ActiveDirectory备份环境检查	134.1介质服务器配置	134.2客户端备份前置条件	134.3备份	13第五章定时备份恢复最佳实践	145.1ActiveDirectory定时备份最佳实践	145.2ActiveDirectory浏览恢复最佳实践	185.2.1恢复注意事项	185.2.2恢复步骤	19第六章FAQs	21第七章备份故障排除	227.1备份成功但有警告信息	227.2备份失败	22第八章恢复故障排除	248.1恢复成功但有警告信息	248.2恢复失败	24第一章概览1.1简介本文档是爱数备份容灾家族ActiveDirectory一体化备份恢复最佳实践文档，主要描述了如何正确地使用爱数备份容灾家族产品成员进行ActiveDirectory数据备份的方法，包括部署前后的注意事项和典型部署方案。ActiveDirectory®目录服务可安装在运行Microsoft®Windows2000ActiveDirectoryvancedServer、Windows Server® 2003、WindowsServer 2008、WindowsServer 2008R2、WindowsServer2012和indowsserver2012r2的服务器上。ActiveDirectory存储有关网络上的对象的信息，并使管理员和用户更方便地查找和使用这种信息。ActiveDirectory使用结构化的数据存储作为目录信息的逻辑化、分层结构的基础。这种数据存储，也称为目录，包含与ActiveDirectory对象有关的信息。这些对象通常包括共享资源，如服务器、卷、打印机、网络用户和计算机帐户。通过登录验证以及目录中对象的访问控制，将安全性集成到ActiveDirectory中。通过一次网络登录，管理员可管理整个网络中的目录数据和单位，而且获得授权的网络用户可访问网络上任何地方的资源。基于策略的管理减轻了即使是最复杂的网络的管理。1.1.1ActiveDirectory备份完全备份将选定的数据源完全备份到指定目的地的备份集中。每次执行时，它不会根据最新的变动比较后进行备份，而是直接将所有的数据备份到OFS介质中，并产生一个时间点，用于记录备份的内容。1.1.2ActiveDirectory恢复通过浏览恢复，恢复备份时间点。1.1.3任务管理1.【命名规则】:用户名、任务组、任务等对象命名规则满足：不允许为空，且名称长度必须为3~50个字符；2.【邮件命名规则】:Email地址只能由字母A~Za~z、数字0~9及特殊字符@.-_组成，类似于yourname@domain.com的形式，且最长不能超过50个字符；3.【备注信息规范】：备注信息最大不超过255字符；1.1.4重复数据删除本版本支持ActiveDirectory定时备份源端重复数据删除。1.2ActiveDirectory定时备份支持功能	功能	子功能	支持	备注	备份类型	完全备份	√			增量备份				差异备份			循环备份				客户端自动搜索实例		√		客户端多实例备份恢复			每个任务只能支持一个实例	浏览恢复		√		异机恢复				恢复粒度		√	整个实例	指定恢复数据库名				灾难恢复			第二章限制性列表1、只限于实例级别的备份恢复。2、不支持异机恢复，只支持原机原位置恢复。第三章客户端安装3.1安装部署3.1.1开始之前1、客户端包括32-bit和64-bit两种类型，如果您使用的系统为32-bit版本，则您应该使用32-bit的客户端；如果您使用的系统为64-bit，您应该使用64－bit的客户端。2、如果您的ActiveDirectory数据库安装在windows2003操作系统上，请确保该系统安装有系统补丁KB958644，否则备份会失败。3.1.2安装Windows客户端安装方法点击【安装】如下点击【下一步】可以选择【更改】安装位置更改好安装位置后，继续【下一步】，如下图：指定好服务器IP和客户端IP地址后继续【下一步】如下图：选择是否安装iSCSIInitator工具和卷CDP驱动。当前系统非2000、2003或xp系统，iSCSI选项不可选,若是在2000,2003或者XP系统安装客户端，定时备份恢复ActiveDirectory数据库可以默认不勾选，定时备份不需要安装卷CDP驱动，确定后进行【下一步】，如下图：点击【安装】，开始安装，如下图：安装完成后，点击【完成】【关闭】退出向导。向导中的每一步都可以【取消】或者进行【上一步】回退操作。3.2客户端配置在浏览器上输入http://IP:9800/的方式，然后输入用户名和密码登录控制台；点击数据保护，客户端名称中，可以查看新安装的客户端；将鼠标放在客户端上，可以查看客户端的详细信息。用鼠标选中对应的客户端，然后用户可以通过点击齿轮状的按钮，可以进行以下操作：新建客户端组：根据向导，建立客户端组后，用户可以采用鼠标拖动的方式，将对应的客户端加入对应的组中；修改名称：默认的名称为操作系统的机器名，为了能更方便识别，用户可以根据需要给客户端命名为一个容易识别的名称，以便管理；配置客户端：该选项用来重删任务数据设置，根据用户的实际资源情况，设置对应的数值即可，其中内存使用限制越大，性能越好；第四章ActiveDirectory备份环境检查4.1介质服务器配置为保证备份任务可正常执行，在创建ActiveDirectory备份任务前，请检查介质服务器是否正常。1、备份服务、介质服务正常，IP配置正确2、有卷，有足够可用的介质空间4.2客户端备份前置条件1、如果您的系统是windows2008及以上版本请确保ActiveDirectory数据库服务NTDS为开启状态，windows2003没有NTDS服务可以检查NTDSWriter，具体检测方法参见下面的FAQ。Windows2008及以上环境建立和执行备份任务时，要求启动NTDS服务，否则不能添加数据源。2、恢复时，域控需进入目录还原模式；存在NTDS服务的（windows2008及其以上系统），可以不须进入目录还原模式，停止NTDS服务即可。4.3备份	哪些内容会进行备份？	哪些内容不会进行备份？	ActiveDirectory活动目录数据库、事务日志和检查点文件	除ActiveDirectory活动目录数据库、事务日志和检查点文件的内容第5章定时备份恢复最佳实践5.1ActiveDirectory定时备份最佳实践1、登录管理控制台，点击标签栏【数据保护】-->【备份管理】选项卡，在操作界面，选择【新建】，点击【定时备份】选择ActiveDirectory数据库，在弹出的新建任务向导中填写任务基本信息2、根据需要设置选项，点击【下一步】3、展开并选择数据源，如图，勾选数据源。点击【下一步】。4、计划的推荐配置。在爱数产品中，有多种任务计划可以进行选择，比如每天、每周、每月，或者是当客户端开机、关机、联网时。设置方法如下：进入任务设置计划向导，选择备份类型、备份计划、开始时间。继续添加计划或者修改、删除计划计划设置特别推荐：ActiveDirectory的备份类型只有1种：完全备份。完全备份：是对数据库的整个数据及日志进行备份。说明：这个概念与其他的文件备份和数据库备份有所区别，请注意。1.针对用户的实际情况，及用户的IO需求、安全需求等，请仔细考虑任务计划策略的设置。2.建议在一个墓碑生存时间内至少有两次完全备份。说明：墓碑生存时间查询：ad14.com域为例,在ad14.com的域控中运行如下命令Dsquery*"CN=DirectoryService,CN=WindowsNT,CN=Services,CN=Configuration,DC=ad14,DC=com"-scopebase-attrtombstonelifetime5、计划设置完毕，如果资源足够，即可开始一次完全备份。选中任务，点击【发起】【备份】，选择需要的执行类型，填写备注信息，点击【备份】按钮，即可开始备份操作，如下图5.2ActiveDirectory浏览恢复最佳实践5.2.1恢复注意事项1、本产品不支持ActiveDirectory跨版本跨平台的恢复，也不支持64位数据库恢复32位。2、进行ActiveDirectory数据库恢复时，ActiveDirectory域控需要进入目录还原模式，否则恢复会失败。3、不支持将ActiveDirectory数据库直接恢复到另外一台ActiveDirectory域控，也不支持将ActiveDirectory数据库直接恢复到重建后的ActiveDirectory域控，若要执行上述操作，会导致域控不可用，甚至蓝屏，请慎重！4、对于windows2003的机器，恢复前需要先关机重新启动进入目录还原模式后执行恢复，恢复完后重新正常启动即可。1.授权还原：目录还原模式进行ActiveDirectory数据库恢复前，ActiveDirectory域控需要进入目录还原模式，方法是：重新启动ActiveDirectory域控，按F8键进入高级模式，选择“目录服务还原模式”，然后用本地管理员登陆。对于安装在windows2008及以上系统的ActiveDirectory域控，还可以在命令提示符窗口执行命令：bcdedit/setsafebootdisrepair，然后重启机器，就直接出现目录还原模式的登录界面（以后重启该计算机时，都会出现目录还原模式的登陆界面，因此在您完成ActiveDirectory数据库恢复后，请在命令提示符窗口执行命令：bcdedit/deletevaluesafeboot，再重启该计算机，便会重新以一般模式来启动系统）。另外，对于安装在windows2008及以上系统的ActiveDirectory域控，也可以不用重新启动计算机进入目录还原模式，只需要将ActiveDirectoryDS（ActiveDirectoryDomainServices）服务停止，就可以执行ActiveDirectory数据库的恢复，不过此时只能进行非授权恢复。恢复完后再重新启动ActiveDirectoryDS服务。2.ActiveDirectory数据库恢复（非授权恢复）ActiveDirectory域控进入目录还原模式后，就可以执行ActiveDirectory数据库恢复，步骤如下：5.2.2恢复步骤1.点击【任务管理】中的【发起】【浏览恢复】2.选择要恢复的时间点及数据3.选择恢复位置，默认为恢复至原客户端原路径，点击【下一步】4.选择好恢复路径后填写备注信息，点击【完成】按钮任务将提交到执行列表中，执行恢复。第六章FAQs暂无。第七章备份故障排除7.1备份成功但有警告信息暂无。7.2备份失败·Q：多备份失败，提示没有找到匹配的WRITERCOMPONENT。·问题原因：卷影复制服务管理工具命令行里面没有MicrosoftExchangeWriter，可以在命令提示符里输入命令vssActiveDirectoryminlistwriters查看·解决方法：重新安装域控即可。·Q：在新建任务，展开数据源时，遇到报错，无法打开NTDS，请确认是否正确安装ActiveDirectory，见图:A：请确认您的客户端安装包位数，客户端ActiveDirectory安装正确，且windows2008机器以上系统NTDS服务是启动状态。·Q：ActiveDirectory备份计划任务，刚开始成功，后来都失败问题描述：windows2003系统上的ActiveDirectory计划任务，刚开始时计划任务备份成功，后来计划任务备份都失败。可能原因：系统缺少补丁KB958644。A：给系统打上KB958644补丁。第八章恢复故障排除8.1恢复成功但有警告信息暂无。8.2恢复失败·Q：多域控授权恢复两次，第二次数据没有恢复回来。问题描述：1.在同一站点包含三个域控，新建用户test1、test2、test3。2.新建ActiveDirectory备份任务，数据源选择其中一台域控，执行完全备份。3.删除用户test1，修改任务，执行完全备份。4.删除用户test2，然后进行授权恢复第一个备份时间点；恢复完后，三台ActiveDirectory域控都包含用户test1、test2、test3。5.删除用户test1、test3，授权恢复第二个备份时间点；恢复完后，三台ActiveDirectory域控都只含有用户test2。A：这是因为：1.授权还原不会覆盖在进行备份之后创建的新对象。它只能在配置和域上下文中的对象上执行。不支持架构命名上下文的权威性还原。2.授权恢复增加版本属性号是按天数来增加的，每隔一天增加100000，相同一天的时间点增加的版本属性号是相同的。3.因此，恢复第一个备份时间点后，对用户test1、test3的操作增加了这两个用户的属性号，同时由于多域控的复制关系，其他ActiveDirectory上的这两个用户属性号提高了，然后再恢复第二个备份时间点的时候，数据恢复到了选定的客户端，但是一段时间后，由复制关系及版本属性号的高低，该数据会被覆盖，导致发生数据没有恢复回来的现象。解决方法：第二次授权恢复的时候，手动将增加的版本属性号设置成大于第一次和修改后的属性号，提高版本属性号，避免被复制。·Q：借助系统异机恢复ActiveDirectory，结果恢复完系统后蓝屏·问题描述：ActiveDirectory数据库的数据文件没有存放在系统盘，备份此ActiveDirectory域控的系统，然后异机恢复系统，恢复完后重启系统，结果蓝屏。·问题原因：ActiveDirectory域控的系统启动需要ActiveDirectory数据库中的对象信息，由于ActiveDirectory还没有恢复，所以蓝屏，不能启动。·解决方法：异机恢复完系统后，重启机器，按F8进入目录还原模式，恢复ActiveDirectory数据库，恢复完后，再重启机器（如果依旧蓝屏，可以尝试通过蓝屏修复工具进行修复,具体操作请参考《Windows操作系统备份与恢复最佳实践》）。·Q:当环境出现备份或恢复速度较慢，怎样解决?解决方法：首先查看存储柜的cached值，如果cached值小于6GB时，可以使用以下方法进行性能调优。1.打开/etc/sysctl.conf文件。#vi/etc/sysctl.conf2.修改如下参数的值为下方参数对应的值，如参数名不存在则新增。vm.min_free_kbytes=0vm.swappiness=0vm.vfs_cache_pressure=0vm.dirty_background_ratio=50vm.dirty_ratio=80vm.dirty_writeback_centisecs=100003.保存/etc/sysctl.conf文件，并执行sysctl-p命令。(地址：上海市联航路1188号浦江智谷8号楼2层A座邮编：201112咨询热线：021-54222601服务热线：400-880-1569传真：021-54326441客服邮箱：support@eisoo.com)(WWW.EISOO.COM)(22/23)