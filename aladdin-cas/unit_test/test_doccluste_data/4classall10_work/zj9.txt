目录1第一章概述11.1简介11.1.1ORACLERAC定时备份11.1.2ORACLERAC恢复21.1.3任务管理21.2ORACLE定时备份支持功能3第二章限制性列表4第三章客户端安装43.1客户端安装11第四章ORACLERAC备份最佳实践21第五章ORACLERAC恢复最佳实践215.1恢复注意事项215.2浏览恢复步骤255.3恢复到单机步骤335.4高级恢复33第六章FAQ第一章概述1.1简介本文档是爱数备份容灾家族ORACLERAC定时备份与恢复最佳实践文档，主要描述了如何正确地使用爱数备份容灾家族产品成员进行ORACLERAC备份与恢复的方法，包括部署前后的注意事项和典型部署方案。本技术文档面向爱数备份容灾家族产品成员的用户和相关技术人员，主要介绍ORACLERAC备份与恢复的基础知识，以及如何正确使用爱数备份容灾家族产品成员部署ORACLERAC备份。旨在通过此文档帮助用户和技术人员快速掌握ORACLERAC备份与恢复模块的使用方法。1.1.1ORACLERAC定时备份完全备份将选定的ORACLERAC数据库完全备份到指定目的地的存储介质中。每次执行时，它都会将ORACLERAC数据库的数据文件，控制文件，参数文件和日志文件备份到ofs介质中，并产生一个时间点，用于记录备份的内容。增量备份是基于上一次完全备份或者增量备份，增量备份根据前面备份的文件集进行过滤，只备份那些新的数据块，从而避免完全相同的数据块重复备份，同时产生一个时间点，以便恢复使用。在尚未进行完全备份的情况下，进行增量备份时会自动转换为完全备份。1.1.2ORACLERAC恢复1.Oracle浏览恢复使用之前的数据库备份集来实现数据库的还原，然后使用归档日志及联机日志将数据库恢复到最新及指定时间点的状态，恢复时需要将停止数据库的生产业务；2.Oracle高级恢复单独恢复不同类型的物理文件，包含控制文件、数据文件、日志文件、参数文件，在用户需要单独恢复执行类型的文件时，可以选择此种恢复方式；1.1.3任务管理1.【命名规则】:用户名、任务组、任务等对象命名规则满足：不允许为空，且名称长度必须为3~50个字符；2.【邮件命名规则】:Email地址只能由字母A~Z、a~z、数字0~9及特殊字符@.-_组成，类似于yourname@domain.com的形式，且最长不能超过50个字符；3.【备注信息规范】：备注信息最大不超过255字符；1.2ORACLE定时备份支持功能下表列出了ORACLERAC定时备份恢复模块所支持的功能。	功能	子功能	支持	备注	备份类型	完全备份、增量备份	支持		客户端自动搜索数据库		支持	需手动添加实例并授权	单任务多数据库备份恢复		不支持		多任务多数据库（一个数据库对应一个任务）		支持		单实例多任务同时备份		不支持		恢复方式	浏览恢复、高级恢复	支持		恢复位置	原ORACLERAC任意节点、相同配置的ORACLERAC，以及其他的非raw存储的单机环境	支持		备份恢复粒度	整个实例和单个或多个文件	支持		异机恢复到RAC		支持		备份压缩	ORACLE提供的备份压缩	支持		备份压缩	本软件提供的压缩	不支持		重复数据删除		支持		归档日志删除		支持		定时备份策略		支持	限制性列表不支持64位系统恢复到32位系统，也不支持32位系统恢复到64位系统不支持单表空间备份不支持一个任务选择多个数据库进行备份不支持跨oracle版本的恢复不支持跨平台恢复（Windows、Linux不支持任意两个平台互相恢复）异机恢复-恢复到指定时间点和恢复最新可用状态都只能恢复到当时备份状态Linux下欲执行oracle备份，安装客户端时必须在root用户下选择oracle选项安装不支持指定位置恢复不支持对同一数据库执行交叉备份。要求备份和恢复端的实例名，用户名和密码一致，缺一不可添加ORACLE实例要正确，注意对应的节点授权要正确，可以通过展开实例检查ORACLERAC的备份数据暂不支持恢复到裸设备存储的ORACLE单机环境，仅支持恢复到ASM存储和文件系统的ORACLE单机环境。ORACLERAC仅支持ASM存储和裸设备存储的RAC环境。不支持一个任务中备份多个ORACLERAC实例，每一个ORACLERAC实例都需要单独建立一个备份任务进行备份。ORACLERAC多实例环境的恢复，恢复之前请将ORACLE用户的环境变量文件中的$ORACLE_SID定义为想要恢复的ORACLE_SID，再以ORACLE用户重启客户端后echo$ORACLE_SID确认输出的SID为要进行恢复的SID后，再进行恢复操作，否则会造成恢复到另一个实例造成环境损坏的风险，切记。Linux环境下的ORACLERAC数据恢复时，客户端环境必须以ORACLE用户启动。ORACLERAC定时备份，设置归档日志删除时，有些归档通过数据库自己的删除命令也无法删除的，会有残留，残留不大，当残留量很大的时候建议进入ASM，手动删除。ORACLE11gRAC备份时有很小概率出现grid进程无法启动，备份任务卡死的情况，此处为ORACLE自己的bug，手动停止该任务，并重新开始执行即可。ORACLERAC备份后，添加表空间后，恢复一致性失败，提示创建数据文件失败。此处可以选择创建表空间之后的备份集进行恢复，若之后没有备份集，可以手动删除原来的新建表空间的数据文件，进行恢复即可恢复成功。备份和恢复ORACLE数据时，ORACLE的监听配置需要满足能够以服务认证的方式进行连接，例如能够以sqlplussys/eisoo@orclassysdba;的方式进行连接，否则备份和恢复任务将会失败。备份过程中如若遇到表空间很大但实际数据很小的情况时，备份还是会遍历整个表空间，在输出信息上会显示卡住不继续刷新新的输出信息的现象，这是正常的。恢复的时候，会用srvctlstopdatabase-dxxx来停止ORACLE实例，如果这个命令执行有错，则恢复失败，请先确保数据库实例可以用srvctlstopdatabase-dxxx命令正常停止。恢复到单机的情况下，请确保归档路径与备份的RAC节点的归档路径一致。请确保待恢复的客户端中ORACLE的归档日志的路径ORACLE能够有写的权限。第三章客户端安装3.1客户端安装3.1.1开始之前客户端包括32-bit和64-bit两种类型，如果您使用的数据库为32-bit版本，则您应该使用32-bit的客户端；如果您使用64-bit的数据库，您应该使用64-bit的客户端。2、在Linux平台安装客户端，选择以root用户安装。3.1.2安装Windows客户端安装方法点击【安装】如下点击【下一步】可以选择【更改】安装位置更改好安装位置后，继续【下一步】，如下图：指定好服务器IP和客户端IP地址后继续【下一步】如下图：选择是否安装iSCSIInitator工具和卷CDP驱动。当前系统非2000、2003或xp系统，iSCSI选项不可选,若是在2000,2003或者XP系统安装客户端，定时备份恢复可以默认不勾选。定时备份不需要安装卷CDP驱动，确定后进行【下一步】，如下图：点击【安装】，开始安装，如下图：安装完成后，点击【完成】【关闭】退出向导。向导中的每一步都可以【取消】或者进行【上一步】回退操作。Linux下客户端安装方法1.登录到客户端所在的机器，将客户端安装包拷贝到指定位置2.解压安装包文件进入解压后的目录，执行安装步骤，如下图所示第一步：输入客户端的ip地址第二步：输入控制台的ip地址第三步：输入要备份的数据库的代号第四步：输入安装ORACLE数据库的linux的操作系统的用户名第四章ORACLERAC备份最佳实践进入控制台管理界面在浏览器中输入：http://***.***.***.***:9800登录爱数备份存储柜控制台，依次打开节点【备份容灾】/【客户端】，打开客户端管理界面，如下图所示：创建虚拟客户端点击【客户端名称】列表有上方的小齿轮下拉列表，点击【新建虚拟客户端】，从弹出的虚拟客户端类型中选择“ORACLERAC客户端”，如下图所示：填写好虚拟客户端名称，并选择好一个集群的所有节点后点击“确定”即可完成客户端创建。创建ORACLERAC定时备份任务从客户端列表中选中需要创建任务的虚拟客户端，点击【任务管理】中的【新建】，点击【定时备份】，再从下一级中选择【ORACLE数据库】，如下图：填写好任务名，选择好介质服务器，点击【下一步】，如下图：配置ORACLERAC定时备份任务的选项，包括“重复数据删除选项”，“数据压缩选项”，“备份数据保存完全副本数”，“归档日志删除选项”和“归档日志存储选项”，如下图：点击【下一步】添加实例并授权，全局数据库名是自动获取的，不用添加，点击蓝色的【设置】即可弹出添加实例和授权对话框，填写好实例名，用户名和密码后，点击【确定】。注意：实例名一定要是对应节点下的实例，如果填写混乱了，通过下面展开ORACLE实例是发现不了问题的，这样会导致接下来备份失败。授权完以后一定要检查一下授权是否有误，展开ORACLE实例，看是否能正常显示所有的表空间，如下图：接下来是给ORACLERAC定时备份任务配置定时备份策略，如下图：备份类型为必选项，可以选择“完全备份”和“增量备份”，备份计划可以使用一次性计划，每天某些时段的计划和每周指定几天等，这里不做详解。当然也可以不要定时备份计划，每次靠手动执行。点击【确定】，【完成】后任务创建成功。在对应客户端的任务管理中会有显示。如下图：至此，ORACLERAC定时备份任务创建完毕。执行备份在指定客户端的“任务管理”中选中指定的定时备份任务，并点击“发起”，选择“备份”，如下图：备份类型有两种，任意选择，第一次备份也可以选择“增量备份”，为了防止误操作，我们程序对此做了处理，只要是第一次备份，不管是什么备份都将作为完全备份处理，所以这里可以放心选择。点击“备份”后即可发起备份，备份过程中的情况可以在“任务监控”中看到，比方说备份速度，已经完成的备份量是多少，包括正在备份数据文件还是日志文件都可以看到。如下两张图：备份完成以后，可以在【任务历史记录】中查看，是否备份成功，如下图：第五章ORACLERAC恢复最佳实践5.1恢复注意事项停止客户端服务，然后切换到ORACLE用户下启动客户端,如图用“srvctlstopdatabase-dorcl”停止数据库，看是否可以成功停止所有实例用“srvctlstartinstance-dorcl-iorcl1-omount”启动其中的一个实例到mounted状态用“sqlplussys/eisoo@orcl1assysdba”连接实例，检查是否可以连接上如果是恢复到单机，请确保全局数据库名，用户名和密码一致如果是多数据库多任务的环境进行恢复，linux需注意要恢复的数据库和恢复环境中的环境变量$ORACLE_SID相对应，windows则需要注意注册表中ORACLE_SID与要恢复的数据库一致5.2浏览恢复步骤进入浏览恢复界面选中ORACLERAC定时备份任务，并点击【任务管理】中的【发起】，从下拉菜单中选择【浏览恢复】，如下图：选择恢复数据源选择“时间点”，并勾选要恢复的数据，点击【下一步】，如下图：选择恢复位置和恢复方式（完全恢复或不完全恢复）选择要恢复的客户端，然后选择是完全恢复还是，不完全恢复，如果是不完全恢复，则需要选择重做日志时间，选择好后点击【下一步】，如下图：注意：“重定向路径”如果是原机恢复则不需要填写。选择恢复后是否使数据库联机这个页面是让使用者选择恢复完数据后是否需要打开数据库，默认情况是勾选的，如下图：5、开始恢复点击【完成】即可发起恢复。恢复时的实时状态同样可以在【任务监控】中查看如下：5.3恢复到单机步骤恢复参数文件发起高级恢复，如下图：选择时间点，并勾选“参数文件”如下图：选择恢复位置，勾选客户端，浏览恢复路径，如下图：点击“下一步”，“完成”发起参数文件恢复。修改参数文件修改前的参数文件，如下图：修改后的参数文件，如下图：根据恢复的参数文件创建spfile启动ORACLE实例到STARTED恢复日志文件，控制文件和数据文件并重定向发起浏览恢复，如下图：选择相同的客户端，填写重定向路径，如下图：去掉“恢复使数据库联机”勾选，如下图：点击“完成”发起恢复。修改在线日志文件路径重命名在线日志文件，如下图：使ORACLE数据库联机数据库联机需要resetlogs，如图：联机后可以根据需要删除不需要的undo和redo，禁用不需要的线程，如下图：至此，ORACLERAC恢复到单机操作完成。5.4高级恢复高级恢复部分可以参考《ORACLE单机定时备份恢复最佳实践》文档。需要说明的是日志恢复的部分，如果日志存放在节点上，高级恢复恢复日志文件是已文件恢复的方式恢复日志文件的，如果归档日志存放在共享存储，则高级恢复是用rman进行恢复的。第六章FAQ1、rman正在运行时发起备份，则备份失败，如下图：遇到这种情况时，可以排查一下，是不是rman被占用了，确保rman空闲再备份即可。2、开启重复数据删除必须用root用户启动客户端才能备份，否则备份失败，会报如下错误：如果任务开启了重删，出现了备份失败，报错目录没有权限的情况，如下图：遇到此问题，给相关目录和目录下文件授权然后再备份即可。4、oracle10g（10.2.0.4）racasm存储恢复到单机文件系统报错ora-00600，如下图：这个问题是oracle的bug，bug号7207932，请恢复到ASM单机环境。5、当环境出现备份或恢复速度较慢，怎样解决?首先查看存储柜的cached值，如果cached值小于6GB时，可以使用以下方法进行性能调优。1.打开/etc/sysctl.conf文件。#vi/etc/sysctl.conf2.修改如下参数的值为下方参数对应的值，如参数名不存在则新增。vm.min_free_kbytes=0vm.swappiness=0vm.vfs_cache_pressure=0vm.dirty_background_ratio=50vm.dirty_ratio=80vm.dirty_writeback_centisecs=100003.保存/etc/sysctl.conf文件，并执行sysctl-p命令。AnyBackup5.0.2.0最佳实践ORACLERAC定时备份恢复上海爱数软件有限公司Add：上海市闵行区联航路1188号浦江智谷8号楼2层A座Tel：+86-021-54222601Fax：+86-021-54326440