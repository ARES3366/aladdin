AdministratorAnyBackup5.0.2.0最佳实践ExchangeServer高级定时备份目　录2目　录4第一章概览41.1简介51.1.1ExchangeServer高级备份51.1.2ExchangeServer高级恢复61.1.3任务管理61.1.4重复数据删除61.2ExchangeServe高级定时备份支持功能9第二章限制性列表10第三章客户端安装103.1安装部署103.1.1开始之前103.1.2安装153.2客户端配置16第四章环境检查164.1介质服务器配置174.2客户端备份前置条件184.3备份19第五章定时备份恢复最佳实践195.1ExchangeServer高级定时备份最佳实践245.2ExchangeServer高级浏览恢复最佳实践245.2.1恢复注意事项245.2.2选择恢复类型255.2.3恢复步骤27第六章FAQs28第七章备份故障排除287.1备份成功但有警告信息297.2备份失败32第八章恢复故障排除328.1恢复成功但有警告信息328.2恢复失败第一章概览1.1简介本文档是爱数备份容灾家族ExchangeServer一体化备份恢复最佳实践文档，主要描述了如何正确地使用爱数备份容灾家族产品成员进行ExchangeServer数据备份的方法，包括部署前后的注意事项和典型部署方案。MicrosoftExchangeServer是一个主流的Intranet协作应用服务器，适合有各种协作需求的用户使用。ExchangeServer协作应用的出发点是业界领先的消息交换基础，它提供了业界最强的扩展性、可靠性、安全性和最高的处理性能。ExchangeServer提供了包括从电子邮件、会议安排、团体日程管理、任务管理、文档管理、实时会议和工作流等丰富的协作应用，而所有应用都可以从通过Internet浏览器来访问。ExchangeServer是一个设计完备的邮件服务器产品，提供了通常所需要的全部邮件服务功能。除了常规的SMTP/POP协议服务之外，它还支持IMAP4、LDAP和NNTP协议。ExchangeServer服务器有两种版本，标准版包括ActiveServer、网络新闻服务和一系列与其他邮件系统的接口；企业版除了包括标准版的功能外，还包括与IBMOfficeVision、X.400、VM和SNADS通信的电子邮件网关，ExchangeServer支持基于Web浏览器的邮件访问。ExchangeServer数据库的存储结构由四大部分组成：邮箱存储（MailboxStore）、公用文件夹存储（PublicFolderStore）、事务日志文件（TransactionLog）、域控制服务器的系统状态（SystemState）。邮件的数据、公用数据夹数据与分别存放在MailboxStore与PublicFolderStore中。ExchangeServer的数据库（store）是由两个档案所组成：丰富文本文件（扩展名为.EDB），它存放了每封邮件讯息和MessageApplicationProgrammingInterface（MAPI）的内容。另一个则为原始内容「数据流（Stream）」档案（扩展名为.STM），它保存了所有非MAPI的信息。因此，信箱存放区是由Priv1.edb和Priv1.stm。公用数据夹存放区是由Pub1.edb和Pub1.stm组成。每一个Store里都有这两个档案，且ExchangeServer将这两个档案视为一组。所以每一个存放区（Store）的大小，就是将丰富文本文件、原始内容文件、和事务日志文件组合在一起后的大小。这两种数据都以ExtensibleStorageEngine（ESE）数据库格式存放。多功能邮局是微软公司基于微软HostedExchangeServer技术开发的一款带有Pushmail的多功能企业邮局。其中ExchangeServer平台是微软研发的消息与协作系统。MicrosoftExchangeServer有企业邮、商务邮、协作邮三款产品，其基本邮件功能都有：POP3,IMAP协议、联系人管理、OutlookWebApp、大容量邮件附件支持、安全和垃圾邮件防御、入站收件人筛选、隐私保护、病毒邮件扫描、邮件加密传输、加密访问、外出助理程序、邮件规则、独立域控制面板、邮件还原中心、全局通讯簿（GAL）查找、国际邮件转发、邮件代理、个性化签名设置；且协作邮还有outlookanywhere、共享邮件、共享日历、共享任务和共享联系任务功能；移动功能三者均有PushMail(手机邮件)、移动设备同步（ActiveSync）、全球地址簿（移动设备地址簿同步管理）、手机防盗，远程数据清除功能，且商务邮和协作邮有SharePoint文档库5G总空间的文档库功能。微软通信平台基于ITIL框架，其专家能有效地处理问题、变更所有有关微软通讯产品的管理。通过成熟的Ticket系统及电子邮件和电话的辅助，对各种事件迅速做出反应，确保全球超过200个ExchangeServer服务器和60,000余邮件客户端的稳定运行。1.1.1ExchangeServer高级备份Microsoft®ExchangeServer主要包括两种备份方式：完全备份和增量备份。下面简单介绍这两种备份方式。完全备份备份被选中的用户邮箱的数据信息，包括邮箱文件结构、邮件、日历、联系人、任务等。与增量备份相比，完全备份中的每个备份使用的存储空间更多，花费的时间也更多，所以完全备份的创建频率通常比增量备份低。增量备份增量备份是备份自上一次备份后的所有更改。改此完全备份称为增量备份的“基准”。在还原增量备份时，首先会还原其基准备份，然后依次还原离基准备份最近的增量备份。相比之下，还原增量备份会花费更多的时间。1.1.2ExchangeServer高级恢复通过浏览恢复，恢复备份时间点。1.1.3任务管理1.【命名规则】:用户名、任务组、任务等对象命名规则满足：不允许为空，且名称长度必须为3~50个字符；2.【邮件命名规则】:Email地址只能由字母A~Za~z、数字0~9及特殊字符@.-_组成，类似于yourname@domain.com的形式，且最长不能超过50个字符；3.【备注信息规范】：备注信息最大不超过255字符；1.1.4重复数据删除本版本支持ActiveDirectory定时备份源端重复数据删除。1.2ExchangeServe高级定时备份支持功能	功能	子功能	支持	备注	备份类型	完全备份	√			增量备份	√			差异备份			循环备份				客户端自动搜索用户邮箱		√		客户端多用户邮箱的备份恢复		√		浏览恢复		√		异机恢复		√		恢复粒度		√	单封邮件	指定恢复数据库名				灾难恢复			第二章限制性列表1、客户端必须安装outlook。2、客户端控制面板中必须做邮件配置。在【控制面板】（切换到经典视图）--选择【邮件】--【显示配置文件】--删除原有配置后，重新添加administrator的配置文件，并选择【始终使用此配置文件】；第三章客户端安装3.1安装部署3.1.1开始之前客户端包括32-bit和64-bit两种类型，如果您使用的outlook为32-bit版本，则您应该使用32-bit的客户端；如果您使用的outlook为64-bit，您应该使用64－bit的客户端。3.1.2安装Windows客户端安装方法点击【安装】如下点击【下一步】可以选择【更改】安装位置。更改好安装位置后，继续【下一步】，如下图：指定好服务器IP和客户端IP地址后继续【下一步】如下图：选择是否安装iSCSIInitator工具和卷CDP驱动。当前系统非2000、2003或xp系统，iSCSI选项不可选,若是在2000,2003或者XP系统安装客户端，定时备份恢复ExchangeServer高级任务可以默认不勾选，定时备份不需要安装卷CDP驱动，确定后进行【下一步】，如下图：点击【安装】，开始安装，如下图：安装完成后，点击【完成】【关闭】退出向导。向导中的每一步都可以【取消】或者进行【上一步】回退操作。3.2客户端配置在浏览器上输入http://IP:9800/的方式，然后输入用户名和密码登录控制台；点击备份容灾，客户端名称中，可以查看新安装的客户端；将鼠标放在客户端上，可以查看客户端的详细信息。用鼠标选中对应的客户端，然后用户可以通过点击齿轮状的按钮，可以进行以下操作：新建客户端组：根据向导，建立客户端组后，用户可以采用鼠标拖动的方式，将对应的客户端加入对应的组中；修改名称：默认的名称为操作系统的机器名，为了能更方便识别，用户可以根据需要给客户端命名为一个容易识别的名称，以便管理；配置客户端：该选项用来重删任务数据设置，根据用户的实际资源情况，设置对应的数值即可，其中内存使用限制越大，性能越好；新建虚拟客户端：在此选项中，用户可以选择创建双机、集群、hyper-v和VMware客户端等。第四章环境检查4.1介质服务器配置为保证备份任务可正常执行，在创建Exchangeserver备份任务前，请检查介质服务器是否正常。备份服务、介质服务正常，IP配置正确有卷，有足够可用的介质空间3、客户端ExchangeServer安装位置有足够空间。4.2客户端备份前置条件至少有一个数据库正常可用，非卸载状态；administrator所在的数据库必须为已载入状态；至少存在一个可用用户邮箱（可用用户是指用户可正常使用，非禁用状态）；建立和执行备份任务时，要求启动MSExchangeISh和MSExchangeRepl服务（信息存储服务和复制服务），否则不能添加数据源；建议您不要修改系统时间，如果修改系统时间为之前的时间点，则当前时间到修改后的时间之间产生的数据不会被备份，需要进行一次完全备份；被禁用或删除的用户无法备份其数据；不支持对用户群组的备份恢复。客户端必须安装outlook，且与ExchangeServer数据库的位数对应；邮箱设置。在【控制面板】（切换到经典视图）--选择【邮件】--【显示配置文件】--删除原有配置后，重新添加administrator的配置文件，并选择【始终使用此配置文件】；5RClient客户端安装好后，进入服务，设置为管理员账户登录，注意此处输入密码需正确，确定后重启5RClient服务。4.3备份爱数备份存储柜只备份ExchangeServer邮箱邮件信息，其数据库的数据信息，其配置信息并不备份；其用户信息存放在ActiveDirectory中，也不备份。	哪些内容会进行备份？	哪些内容不会进行备份？	用户邮箱结构、邮件、日历、联系人、任务等	无关紧要的文件比如存储组下的CatalogData，公用文件夹存储、邮箱数据库，公用文件夹数据库，事务日志文件，用户信息、通讯组信息定时备份恢复最佳实践5.1ExchangeServer高级定时备份最佳实践登录管理控制台，点击标签栏【数据保护】-->【备份管理】选项卡，在操作界面，选择【任务管理】，点击【新建】-->【定时备份】-->【ExchangeServer数据库】在弹出的【新建任务向导】中填写任务基本信息，点击【下一步】，进入【选项】；3、根据需要选择任务策略，默认备份策略均为未选中状态，设置您需要的最大保存完全副本数；勾选【启用高级备份】选项，并设置ExchangeServer高级备份缓存路径，点击【下一步】；注：1、此处所有选项默认为不开启；2、新建ExchangeServer高级备份任务则必须勾选【启用高级备份】，且勾选后修改任务时不可以修改此选项；3、勾选启用高级备份后必须设置ExchangeServer高级备份的缓存路径；4、编辑修改任务时可以修改ExchangeServer高级备份的缓存路径（不可以修改勾选是否启用高级备份选项）；5、缓存路径空间必须确保足够大，可根据要备份的数据量预估给予缓存路径的空间；6、缓存路路可浏览选择也可手动填写；手动填写时注意路径符合系统路径创建规范，且磁盘为已存在磁盘，且不支持全角字符，不支持软盘、DVD盘或不存在的磁盘；7、此处可开启备份数据保存的副本数，建议开启4-5个副本并与任务计划协调使用以确保数据在一定时间段内数据的完整性；若不开启则默认副本数为不限制；4、展开数据源，勾选后点击【下一步】。这里显示的是可用用户，如果用户为禁用状态则因检测不到而无法显示；如果administrator所在的存储组未卸载状态则此处用户均检测不到；如果只有一个可用用户勾选后则默认为全选，以后有新增用户也会被备份。5、根据需要设置计划任务，点击【添加】按钮为任务新增计划；6、点击【完成】即新建任务完成。计划的推荐配置：在爱数产品中，有多种任务计划可以进行选择，比如一次性、每天、每周、每月，或者是当客户端开机、关机、联网时。设置方法如下：进入任务设置计划向导，选择备份类型、备份计划、开始时间。可继续添加计划或者修改、删除或暂停计划计划设置特别推荐：ExchangeServer邮件的备份类型有2种：完全备份、增量备份。完全备份：是对用户邮件的整个邮箱结构和邮件进行备份。增量备份：是上一次备份以来数据的修改部分的备份。说明：这个概念与其他的文件备份和数据库备份有所区别，请注意。针对用户的实际情况，及用户的IO需求、安全需求等，请仔细考虑任务计划策略的设置。在这里，推荐用户能够至少保证两个月的数据安全：1.每两周周末数据应用比较平缓的时候，进行一次完全备份；2.隔日晚时进行一次增量备份；3.设置保留完全备份副本数为4，这样能够保证近56天的数据不会被丢失；如果数据量比较大，也可以一个月执行一次完全备份。7、计划设置完毕，如果资源足够，即可开始一次完全备份。选中任务，点击【发起】--【备份】按钮，选择需要的执行类型，点击【备份】按钮，即可开始备份操作注：任务正在备份时不能卸除数据库、禁用用户或者删除用户。5.2ExchangeServer高级浏览恢复最佳实践5.2.1恢复注意事项1、定时备份恢复时，务必启动MSExchangeISh和MSExchangeRepl服务（信息存储服务和复制服务）。2、本产品不支持ExchangeServer跨版本的恢复。3、ExchangeServer邮件恢复时要恢复邮件的用户需可用，非禁用状态或已被删除。4、ExchangeServer进行数据库恢复后，mapi会连接登陆不上，这时更改新建配置outlook文件就能登陆，更改步骤“控制面板->邮件->显示配置文件->添加”,用域管理员账户配置administrator，详细见4.2的第八条。5.2.2选择恢复类型根据数据丢失范围，分析采用何种恢复措施：1）如果用户邮件全部丢失，可以将此用户所有邮件全部恢复到原位置；2）如果只是部分数据丢失则选择时间点针对已丢失部分邮件进行浏览恢复；3）异机恢复需要与原机环境相同，需要有足够的缓存目录空间；4）异机恢复需要有与原机相同的域用户，域用户邮箱、且用户非禁用状态；ExchangeServer数据库正常可用，为已载入状态。5.2.3恢复步骤1.选中任务点击【发起】-->【高级恢复】。2、在恢复页面中选择要恢复数据源，点击【下一步】；3、选择恢复位置，点击【下一步】；默认为恢复至原客户端原位置，使用备份时定义的缓存路径，恢复不支持重命名；也可以进行异机恢复，异机恢复需要指定缓存路径，路径根据要恢复的邮件大小给予足够空间。4、进入【恢复策略】，填写执行备注信息，点击【完成】，任务即执行恢复。第六章FAQs1、不支持跨ExchangeServer版本的恢复。2、不支持指定位置恢复。3、不支持对同一数据库执行交叉备份。4、建立和执行备份任务时，要求启动数据库服务，否则不能添加数据源。5、客户端服务需要用域管理员用户登录6、需设置邮箱配置文件7、异机恢复时，异机必须要与原机环境相同，有相同的域用户，域用户邮箱、且用户非禁用状态；ExchangeServer数据库正常可用，为已载入状态。第七章备份故障排除7.1备份成功但有警告信息备份部分成功有警告信息Q：备份出现部分成功，有警告信息：获取用户user1的目录失败，此用户的邮件将无法备份。详细信息为:打开用户user1的信息存储失败。见图:A:1、用户所在的数据库或存储组没有装入，请确保数据库服务正常，且数据库或存储组是装入状态。2、ExchangeServer服务配置中此邮箱被禁用或者在已断开连接的邮箱中，请将用户启用；3、用户没有被删除4、配置文件正确7.2备份失败Q：在新建任务，展开数据源时，遇到报错，见图:A：1、没有装入的数据库或存储组，请确保数据库服务正常，且数据库或存储组是装入状态。2、启动MicrosoftExchangeServerInformationStore服务3、administrator用户所在的存储组或数据库为已装入状态Q：在新建任务，展开数据源时，遇到报错，见图:A：请确保您的5RClient服务是使用管理员administrator用户用户登录，且密码正确。若您此时修改为administrator用户登录，需要重启服务。Q：备份失败，提示客户机未安装outlook，见截图A：由于ExchangeServer高级的备份需要使用outlook中的组件去解析邮件，所以必须安装outlook。Q：备份失败，提示获取邮件的入口标识失败，或导出邮件失败，导出用户时出错，获取用户的目录失败，请确认用户是否存在，或用户邮箱是否正常，见截图图一：图二：A：1、此用户所在的数据库或存储组没有装入，请确保数据库服务正常，且数据库或存储组是装入状态；ExchangeServer服务配置中此邮箱是否在已断开连接的邮箱中；此用户没有被删除或禁用；配置文件正确；备份时出现断网。Q：备份失败，缓存目录设置在C盘访问被拒A：1、缓存目录不要设置不可访问的文件夹2、缓存目录不要设置在C盘Q：备份失败，缓存目录磁盘空间不足Q：备份时断网，任务失败或部分成功A:ExchangeServer高级备份恢复不支持断网操作，断网后的数据全部备份恢复失败。用户可重连网络稳定后重新执行备份恢复。Q：备份出现导出邮件发生异常，文件名或扩展名太长，任务部分成功。A:出现此问题是由于用户邮件目录太长超过255个字符导致，（邮件的临时目录完整目录，临时目录为用户新建任务时设置的那个目录，eg：临时目录为D:\test，邮件为”administrator/收件箱/工作邮件/项目总结.msg”目录，则临时文件为：“D:\test/tempbackupdata/Administrator/收件箱/工作邮件/项目总结.msg”共64个字符）。解决办法：用户邮箱文件夹不要目录太深，邮件名不太要过长。总长度不超过255字符即可。Q：刚刚新建的用户邮箱执行备份失败，提示打开用户邮箱user2的信息存储发生异常。A：用户邮箱对应的ActiveDirectory用户帐户是最近创建的，尚未复制到承载此客户端访问服务器的ActiveDirectory站点。需要等待一段时间或者直接重启NTDS服务（即ActiveDirectoryDomainServices服务）即可正常备份恢复。Q：删除或禁用用户邮箱后，任务的数据源属性中还有此用户邮箱，导致备份或恢复失败。A:任务的数据源属性是记录在数据库中的，任务建好后就不会随客户端用户邮箱的改变而改变，需要用户手动修改任务数据源取消删除或禁用的用户邮箱，即可备份恢复成功。Q：数据源中新建的用户邮箱没有自动发现。A:客户端控制面板中重新做邮件配置。在【控制面板】（切换到经典视图）--选择【邮件】--【显示配置文件】--删除原有配置后，重新添加administrator的配置文件，并选择【始终使用此配置文件】；注意：此处配置的是outlook所在机器的控制面板中的邮箱配置。Q：备份时数据源展不开A：1.客户端控制面板中重新做邮件配置。在【控制面板】（切换到经典视图）--选择【邮件】--【显示配置文件】--删除原有配置后，重新添加administrator的配置文件，并选择【始终使用此配置文件】；注意：此处配置的是outlook所在机器的控制面板中的邮箱配置。2.如果控制面板配置正常展不开则是由MAPI显示Exchange2007结构显示为Exchange2010结构导致。解决方法，可以给客户端一个MFCMapi.exe：使用MFCMapi.exe,session--loginon--选择administrator的配置文件---确定--双击administrator用户，进入后展开administrator的根目录即可查看用户邮件是否真正存在。如果上图中根目录下不是显示的IPM_SUBTREE，却显示TopofInformationStore，则需要按下图操作，Adressbook--ViewABhierarchy--全球通讯录，如果在过程中有弹出错误窗口，多次点击确定即可，直到可以查看到用户名列表。第八章恢复故障排除8.1恢复成功但有警告信息暂无。8.2恢复失败Q:恢复时出现导入邮件失败A:1、用户所在的数据库或存储组没有装入，请确保数据库服务正常，且数据库或存储组是装入状态。2、ExchangeServer服务配置中此邮箱被禁用或者在已断开连接的邮箱中，请将用户启用；3、用户没有被删除4、配置文件正确Q：磁盘空间不足，导致恢复失败A:如果是原机恢复出现磁盘空间不足，则用户可以修改任务的缓存路径，根据要备份恢复的数据量保证缓存目录的空间足够大，再次备份恢复即可。如果是异机恢复，则重新执行异机恢复，填写缓存路径时保证缓存目录的空间足够大即可。Q：恢复时杀执行进程A:不可以杀掉任务的执行进程，需重新执行任务Q：恢复时断网重连A:ExchangeServer高级备份恢复不支持断网操作，断网后的数据全部备份恢复失败。用户可重连网络稳定后重新执行备份恢复。Q：恢复时导入邮件出错，获取用户目录失败，请确认用户是否存在，或用户邮箱是否正常（未被禁用或断开连接）A:查看用户是否被禁用或不存在，或用户所在的数据库为装入。1、用户所在的数据库或存储组没有装入，请确保数据库服务正常，且数据库或存储组是装入状态。2、ExchangeServer服务配置中此邮箱被禁用或者在已断开连接的邮箱中，请将用户启用；3、用户没有被删除4、配置文件正确Q：恢复失败，ExchangeServer数据库的可用空间不足时，会导致数据库被卸载。A:需清理磁盘空间保证数据库空间可用，或者移动数据库存储路径和数据库路径；清理空间后重新恢复即可。Q：数据量比较大时发现客户端store.exe进程占用内存比较大A:Exchange2007及Exchange2010，备份恢复时，会调用store.exe进程，从而占用大量内存，属于正常现象也可参考相关文档http://blogs.technet.com/b/exchange/archive/2008/08/06/3406010.aspxQ:恢复后自定义的联系人文件夹属性改变A:对用户邮箱中联系人文件夹备份，删除文件夹后执行恢复，发现联系人文件夹属性变成了普通文件夹，如上图。这是因为MAPI接口中创建的文件夹类型中没有这种描述的类型，无法做程序中判断如果必须要求恢复的文件夹类型与备份时一致，需要先手动创建对应的文件夹，然后再恢复。Q:删除用户后新建同名用户恢复成功，但登陆失败A:用户登陆时需要加上域名登陆。Q:数据源中有多个用户被备份，删除一个用户后执行恢复直接失败A:任务备份或恢复前都会进行一次客户端邮件的检查，用于与控制台备份的数据的gns做对比，如果客户端检测不到此用户则直接失败。解决办法：新建同名用户重新执行恢复或者恢复时数据源不选被删除的用户邮箱数据。Q:不能两个同类型任务同时执行恢复。A:需要等现有任务执行完后再恢复此任务。Q:只选择一个用户邮件执行恢复但恢复了全部邮件。A:这是由于此用户文件夹下只有一封邮件，选择此邮件后相当于全选，所以都会恢复。Q:删除一封邮件后执行恢复，再次执行增量备份会备份此新恢复的邮件。A:由于备份是根据邮件的创建时间来判断的，恢复的那封邮件其实相当于新创建的邮件，只是邮件的发送时间接收时间不变，所以增量备份会再次备份此邮件。正常现象不影响应用。Q:恢复时出现导入邮件发生异常：错误原因：MicrosoftExchange信息存储区:服务器管理员已限制了可以同时打开的项目数。请尝试关闭已打开邮件，或删除正在撰写的未发送邮件中的附件和图像。。且查看客户端日志有:A:这是因为MAPI客户端同时打开项目数过多导致，可修改注册表解决，操作步骤：1、启动注册表编辑器(regedit)。2、导航到下列注册表子项：\\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\MSExchangeIS\ParametersSystem3、右键单击“ParametersSystem”，指向“新建”，然后单击“注册表项”。4、会在控制台树中创建新注册表项。5、将该注册表项重命名为“MaxObjsPerMapiSession”，然后按Enter。6、右键单击“MaxObjsPerMapiSession”，指向“新建”，然后单击“DWORD(32位)值”。会在结果窗格中创建新值。7、将该注册表项重命名为:objtFolder8、右键单击新创建的注册表项，然后单击“修改”。9、在“数值数据”框中，键入要限制此项使用的对象数，然后单击“确定”。例如，键入“10000”可增大对象的值。10、重新启动MicrosoftExchange信息存储服务。11、重新执行恢复操作即可。可以参考文档：http://technet.microsoft.com/zh-cn/library/bb676486%28v=EXCHG.80%29.aspx地址：上海市联航路1188号浦江智谷8号楼2层A座邮编：201112咨询热线：021-54222601服务热线：400-880-1569传真：021-54326441客服邮箱：support@eisoo.com