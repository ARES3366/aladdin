微软中国信息级别：秘密级IGBase定时备份恢复最佳实践——爱数备份容灾家族3.5信息级别：秘密级I版权所有版权所有©2003-2012爱数软件有限公司。未经本公司书面许可，任何单位或个人不得以任何形式，复制、传播、摘抄本FAQ内容的部分或全部。本FAQ内容上可能会有增删和修改，爱数软件有限公司会定期将修订后的内容纳入新版本中，如有更改恕不另行通知。信息级别：秘密级II关于爱数作为全球智能数据管理解决方案提供商，爱数围绕客户的需求持续创新，与合作伙伴开放合作，在存储整合、备份容灾、文档管理、安全归档、云计算等多个领域构筑了围绕数据生命周期管理的创新型解决方案。在政府、教育、医疗卫生、企业等诸多领域，爱数为客户提供有竞争力的智能数据管理解决方案和服务，包括备份容灾一体化领域的旗帜——EISOOAnyBackupFamily；安全文档云——EISOOAnyShareFamily；以及面向数据中心和共享灾备中心的备份容灾云解决方案——EISOOTxFamily；同时还提供给用户和合作伙伴高附加值的EISOOAnySupport贴心服务。目前，爱数的产品和解决方案已经成功服务于全球上万用户，并持续改善客户体验，提升业务价值，共同迈向成功。爱数软件有限公司地址：上海市闵行区联航路1188号浦江智谷8号楼2层A座邮编：201112网址：www.eisoo.com客户服务电话：021-54222601客户服务邮箱：support@eisoo.comhttp://www.hanqintech.com/mailto:support@eisoo.com信息级别：秘密级III目录第1章.概述............................................................................................................................11.1.目标读者..........................................................................................................................11.2.本文档适用范围..............................................................................................................1GBase定时备份功能模块简介...............................................................................................2第2章.GBase基础知识简介..................................................................................................12.1.GBase简介.......................................................................................................................12.2.关键技术原理..................................................................................................................12.2.1.GBase备份恢复原理分析...................................................................................1第3章.GBase定时备份恢复最佳实践...................................................................................23.1.GBaseforWindows定时备份恢复最佳实践..................................................................23.1.1.部署注意事项（包括客户端安装、环境配置等前期准备工作）...................23.1.2.GBase定时备份注意事项....................................................................................33.1.3.GBase定时备份最佳操作....................................................................................33.1.4.GBase定时备份数据恢复最佳操作.................................................................113.2.FAQ.................................................................................................................................14第1章.概述本文档是爱数备份容灾家族GBase定时备份与恢复最佳实践文档，主要描述了如何正确地使用爱数备份容灾家族产品成员进行GBase数据备份与恢复的方法，包括部署前后的注意事项和典型部署方案。1.1.目标读者本技术文档面向爱数备份容灾家族产品成员的用户和相关技术人员，主要介绍数据备份与恢复基础知识，以及如何正确使用爱数备份容灾家族产品成员部署GBase定时备份与恢复。旨在通过此文档帮助用户和技术人员快速掌握GBase定时备份与恢复模块使用方法。1.2.本文档适用范围数据库版本数据库位数操作系统CPU架构操作系统位数备注GBase8s_8.3.81.5132Windows2003SP2X8632支持GBase8s_8.3.81.5132Windows2003X8664支持GBase8s_8.3.81.5132Windows2008X8632支持GBase8s_8.3.81.5132Windows2008X8664支持GBase8s_8.3.81.5132Windows2008R2X8664支持GBase8g_8.3.0.532Windows2003SP2X8632支持GBase8g_8.3.0.532Windows2003X8664支持GBase8g_8.3.0.532Windows2008X8632支持GBase8g_8.3.0.532Windows2008X8664支持GBase8g_8.3.0.532Windows2008R2X8664支持GBase8s_8.3.85.1264Windows2003X8664支持GBase8s_8.3.85.1264Windows2008X8664支持提示：本文档中的界面截图来自爱数备份存储柜3.5.13。信息级别：秘密级2GBase定时备份功能模块简介功能描述功能模块定时备份、恢复客户端自动搜索实例不支持备份粒度服务器级别客户端多实例备份不支持同客户端多备份任务不支持恢复方式时间点恢复恢复粒度服务器级别恢复位置原位置恢复为其他数据库名不支持异机原位置恢复支持信息级别：秘密级1第2章.GBase基础知识简介2.1.GBase简介GBase是南大通用数据技术有限公司汇聚多方科研力量推出的自主品牌的数据库产品，具有稳定、实用、高效等特性。GBase致力于打造高品质的国产数据库品牌，以完善的服务，推动中国数据库产业的发展。GBase8s安全数据库系统主要适用于涉密信息系统、信息系统安全等级保护要求中规定的三级以上信息系统、国民经济支柱行业核心信息系统，以及其他信息系统等对数据管理具有高安全需求的领域。GBase8g,也即南大通用数据库管理系统是具有完全自主知识产权的数据库产品，该产品符合SQL92、ODBC、JDBC、ADO.NET等国际数据库规范和开发接口，参照国际主流数据库产品定义，提供完备的数据存储和数据管理功能。2.2.关键技术原理2.2.1.GBase备份恢复原理分析GBase数据库主要包含数据文件.gbd、表定义文件.dsc、日志文件等；如果没有在GBase配置文件gs.ini中设定单表存储gsdb_file_per_table，那么数据都存放在gbdata1中，反之，设置了就存放在.gbd中。执行备份时会先调用GBase自带的备份恢复工具rman工具进行联机备份，备份将产生临时文件，我们软件将备份此临时文件。Rman备份的文件包括数据库和表文件，log文件，数据文件和相关配置文件等。恢复时会先将ofs数据中的文件恢复到本地临时文件中，再将本地临时目录下的文件通过rman工具联机恢复到GBase数据库中，这就是GBase的备份恢复原理。信息级别：秘密级2第3章.GBase定时备份恢复最佳实践3.1.GBaseforWindows定时备份恢复最佳实践3.1.1.部署注意事项（包括客户端安装、环境配置等前期准备工作）1.身份验证Gbase8s可用两种身份验证方式，密码验证和密码卡验证，在这里GBase8s定时备份有密码验证和密码卡验证。GBase8g只有一种身份验证方式即密码验证。2.客户端版本a)爱数备份存储柜或者爱数备份软件客户端的版本需与控制台的版本保持一致。b)此版本定时备份恢复只支持GBase8g_8.3.0.5_32bit、GBase8s_8.3.81.51_32bit和GBase8s_8.3.85.12_64bit，需要根据数据库版本的位数选择对应位数的客户端。如果您使用的客户端版本位数和备份的GBase版本位数不一致，可能会导致无法展开数据源。不支持Win2003(32bit)，但支持Windows2003SP2(32bit)；不支持Win2003(32bit)是因为GBase数据库不支持Windows2003(32bit)。3.客户端类型爱数备份存储柜客户端类型有三种：普通型、后台型、安全型，如下图。如果你在域用户登陆的服务器上安装安全型客户端，将会导致无法进行身份验证；因此，如果服务器的登陆用户是域用户，请安装普通型或后台型客户端（安全型客户端与指定用户绑定，只有该用户才能备份和恢复当前计算机的数据）。信息级别：秘密级33.1.2.GBase定时备份注意事项1.新建GBase定时备份任务注意事项新建GBase定时备份任务，客户端数据库服务必须开启新建GBase定时备份任务时数据库实例信息应填写正确，选择正确的GBase版本，与对应的密码正在备份时添加的数据不会被本次任务备份2.恢复注意事项恢复数据库时客户端数据库服务必须开启恢复完成后必须重启数据库服务才可查看数据库如果修改数据库用户的密码，数据库实例信息中的密码必须与实际一致如果您的数据库版本是是GBase8S_8.3.81.51或者GBase8S_8.3.85.12，则需要在数据库安装目录\GeneralData\GBase\BackupRestoreTool\lib下找到jdbc.jar，拷贝一份到相同目录下重命名为gbase-connector-java-8.2.02-bin.jar，否则会恢复失败。异机恢复时，目标机器必须有GBase数据实例正在恢复时不要添加或修改数据，否则新添加或修改的数据也会被恢复的数据覆盖3.1.3.GBase定时备份最佳操作1.配置客户端信息级别：秘密级4以管理员身份登录管理控制台，单击左边【系统管理】中的【客户端管理】，进入客户端管理界面。在右边的客户端列表中单击选择需要的客户端，然后单击【配置客户端】菜单，弹出【修改客户端配置】窗口如下所示：勾选GBase，然后单击【确定】按钮后退出。2.新建GBase定时备份任务步骤一：登录管理控制台，点击【备份恢复管理】下的【备份管理】，选中【定时备份管理】单击右边的【新建任务】菜单，弹出的【新建定时备份任务向导】窗口如下：信息级别：秘密级5选择【备份数据库】，从数据库的下拉列表中选择【GBase】，点击下一步，进入【任务基本信息】步骤二：【任务基本信息对话框】对话框如下图所示:请输入任务名，选择任务组和备份目的地，确定是否勾选“启用源端重复数据删除”，数据源类型选择“普通数据”，单击【下一步】按钮，进入【选择数据源】对话框。信息级别：秘密级6步骤三：进入【选择数据源】对话框展开客户端数据源，选中GBase服务器的控件，点击【添加GBase服务器】按钮。弹出【添加GBase服务器】窗口，选择GBase的版本，GBase8G和GBase8S，如果您使用的是GBase8S_8.3.81.51_32bit或者GBase8S_8.3.85.12_64bit则选择GBase8S，如果您使用的是GBase8G_8.3.0.5_32bit则选择GBase8G。如果您选择了GBase8S，则需要正确填写数据库的服务名、超级管理员名、超级管理员密码、sysman密码、密码卡密码并选择临时路径。如果您选择的是GBase8G，则您不需要填写密码卡密码，密码卡呈灰色状态，只需要正确填写数据库服务名，超级管理员名、超级管理员密码、sysman密码、并选择好临时路径。如果您的数据库版本是是GBase8S_8.3.81.51或者GBase8S_8.3.85.12，则需要在数据库安装目录\GeneralData\GBase\BackupRestoreTool\lib下找到jdbc.jar，拷贝一份到相同目录下重命名为gbase-connector-java-8.2.02-bin.jar，否则会恢复失败。信息级别：秘密级7注意：1、这里GBase8S_8.3.85.12此版本没有sysman用户，但是为了同时支持三个版本，所以设定此处选择GBase8S时都需要填写sysman密码，如果您是此版本，则随便输入一个密码即可。2、如果您的数据量非常大，选择临时路径时请保证有足够的空间。3、临时路径不可以是只读文件、含有空格的文件夹4、如果数据库实例信息需要修改，则在任务界面中删除数据库实例重新添加即可。展开数据源，如下图。信息级别：秘密级8此处【手工清理】只是清理掉选择的数据源；【清理数据源】是取消数据源的勾选；所以使用此功能时请保证数据源列表中要有数据源，点击【下一步】，进入【设置计划及事件】注意：只指出数据库实例级别的备份，所以此处需要全选步骤四：【设置计划及事件】对话框如图所示：【添加】：信息级别：秘密级9根据您的需要可以选择按每天、每周、每月、一次性执行完全增量或者差异备份，并设置重复任务。【选项】点击【选项】，弹出任务管理对话框，在高级选项中有压缩和同步的设置【选项】设置是否允许介质同步，是否开启数据压缩功能，设置完成后，单击【完成】按钮，提交该操作到任务执行队列。【选项】默认介质同步为不勾选状态，此处可勾选可不勾选，如果您有足够大空间的介质同步服务器，则可以勾选，如果您没有介质同步服务器，则不用勾选；数据压缩功能默认为不启用压缩功能，如果您的数据量过大，则可以选择启用压缩功能，这样会为您的介质服务器节省一半左右的空间。如果您选择了【启用压缩】，则默认配置一个CPU资源来进行压缩，如果您的客户端有多个CPU资源，则可以根据你客户端CPU资源数进行配置,最大可配置为6个CPU。点击【确定】，完成配置。点击【确定】按钮，任务建好后，即到执行列表中。步骤五：成功创建定时备份任务创建成功后进【常规执行任务】界面，可查看创建成功的定时备份任务，任务类型，任务状态等任务详细执行信息。信息级别：秘密级10上图中正在进行联机备份是GBase自身的备份恢复工具正在备份，紧接着的输出的备份成功是GBase的备份恢复工具备份成功。执行完后任务即到实例清单中，如下图上图中输出客户端成功完成，执行结果成功。点击完成报告可以查看到完成报告备份用时，花费用时和备份总大小，原文件数。信息级别：秘密级11备份成功完成。3.1.4.GBase定时备份数据恢复最佳操作登录管理控制台，点击【恢复管理】，进入【浏览恢复】选择要恢复的任务，和对应的客户端后选择要恢复的时间点，展开数据源如下图展开介质服务器根节点，在任务列表框中单击展开您需要恢复的GBase定时备份任务，单击右边的【时间点】下拉框，选择您需要恢复到的时间点，勾选全选，选择要恢复的数据源，然后点击【恢复到客户端】按钮，将弹出【客户端恢复】对话框，选择您要恢复到的客户端。注意：此处只能勾选【全选】按钮，不支持恢复单个数据库。信息级别：秘密级12点击【恢复】后会跳出容灾数据恢复风险警告，如下图所示。注意：1.目前支持恢复到其他客户端，但是恢复数据只能恢复到原路径。如果恢复目标机器GBase的安装路径或数据文件存放路径与原机不一致，会导致恢复失败。2.目标机器数据库服务必须是开启状态，否则会连接不上数据库，无法找到数据文件目录，恢复失败。3.恢复的目标机器数据库必须正常，不可以删除GBase自带的系统数据库，否则会恢信息级别：秘密级13复失败。单击【确认执行】按钮，提交该恢复操作到任务执行队列。执行恢复后任务即到执行列表中，从输出信息中可以查看出正在执行恢复。数据恢复完成，如下图。当输出恢复成功和成功完成的信息时，则已经恢复成功。信息级别：秘密级143.2.FAQ问题1：新建GBase应用容灾任务时，展开数据源时，获得数据库列表失败的问题描述：新建GBase容灾任务，添加GBase服务器时获得数据库列表失败，见下图错误原因：1、数据库实服务未启动；2、数据库实例连接不上；3、数据库实例添加不正确，用户名，密码，路径，实例名不正确解决方法：1、正确添加数据库实例，实例名和对应的用户名密码要正确2、数据库服务开启，可以正常连接数据库3、可以展开数据源问题2：执行GBase定时备份任务时出现警告，目录删除失败，可能正被某程序锁定。信息级别：秘密级15错误原因：执行完全备份任务时，需要删除上一次完全备份的Full开头的文件，当这个文件被占用时会出现删除目录失败的提示信息解决方法：执行备份任务时不要进入临时目录，以防出现此警告。但是出现此警告并不影响任务，即使在备份恢复任务正在执行时进入了临时目录，也会成功完成任务。问题3：中文数据库输出信息中含有乱码错误描述：GBase数据库中有中文数据库，在任务执行中，输出信息含有乱码错误原因：这是GBase数据库本身中文字符转换机制，在GBase数据库中存储的数据就是以unicode码形式转化存储的;当数据库名中含有中文时，其对应的文件名有规律如下：1.如果字符为汉字，则对应的文件名为:@该汉字所对应的unicode码2.如果字符为@，则对应的文件名为:@0040举例：名为"爱数@eisoo"的数据库所对应的文件夹名为"@7231@6570@0040eisoo"，如下图所示信息级别：秘密级16解决方法：出现中文时，如上所述所以会有界面显示问题，不必介意问题4：恢复失败，出现GBase恢复调度启动失败，不能连接实例管理器错误原因：1、jdbc.jar未复制修改未gbase-connector-java-8.2.02-bin.jar信息级别：秘密级172、sysman密码错误解决方法：1、如果您的数据库版本是是GBase8S_8.3.81.51或者GBase8S_8.3.85.12，则需要在数据库安装目录\GeneralData\GBase\BackupRestoreTool\lib下找到jdbc.jar，拷贝一份到相同目录下重命名为gbase-connector-java-8.2.02-bin.jar，否则会恢复失败。2、修改数据库实例信息为正确信息，正确填写sysman密码问题5：备份或恢复失败，提示无法连接实例管理器错误原因：1、连续多次恢复必须重启客户端后再恢复或备份2、数据恢复完后数据库服务被关闭解决方法：每次恢复完后都要重启数据库服务，并确保数据库实例信息正确。问题6：备份后修改数据库用户密码和实例密码，恢复之前的时间点失败错误原因：备份是读取的任务中记录的数据库实例信息，恢复读取的是客户端配置中的数据库实例信息，所以如果您修改了sysdba或sysman的密码则备份或恢复时需要先修改任务的数据库实例信息为正确信息。解决方法：修改任务数据库实例信息为当前正确信息。注意：1、如果您恢复的是修改密码前的时间点，则恢复成功后数据库sysdba和sysman的密码将变为修改前的密码，此时再备份又将需要重新修改数据库实例密码为现在的正确密码。2、如果恢复的是修改密码后的时间点，则恢复成功后密码不会再更改3、信息级别：秘密级18建议不要频繁的修改数据库sysdba和sysman密码，如果修改，则可以通过修改数据库实例信息来解决。问题7：临时路径空间不足，备份或恢复失败.错误原因：临时路径空间不足时：备份提示：执行出错，GBase备份调度启动失败，请检查临时目录可用空间是否足够,见上图解决方法：选择临时路径时一定要根据你的数据量和你可能增减的数据量来选择足够大的空间。问题8：增量或差异备份失败，找不到完全备份！信息级别：秘密级19错误原因：执行完全备份前，上一次的完全备份Full文件被手动删除解决方法：由于GBase的增量或差异备份会依赖于前一次完全备份，所以不可以手动删除临时路径下的Full文件。如果删除则必须先进行一次完全备份。问题9：恢复失败:gsbackup:cdtoC:\GeneralData\GBase\Server\datagsbackup:Thistargetseemstobealreadyprepared.gsbackup:error:Thisincrementalbackupseemsnottobeproperforthetarget.gsbackup:Check'to_lsn'ofthetargetand'from_lsn'oftheincremental.错误原因：备份失败，GBase自带的备份恢复工具和我们软件共同使用,因为他们共用了备信息级别：秘密级20份日志文件，一起使用会混乱解决方法：1、建议不要将GBase自带的备份恢复工具和我们软件共用.2、GBase自带的备份恢复工具执行完全备份，我们自己的软件执行增量和差异备份，则GBase会在backuprestores记录上一次完全备份到现在的备份信息，混合使用会导致找不到完全备份。问题10：删除备份数据后，备份失败，提示CID已被标记删除。错误原因：删除备份数据时并未删除干净解决方法：等待数据被删除完后再执行备份，建议数据量过大时删除数据需要一点时间，等待数据被删除干净后再执行任务。问题11：删除备份数据后，直接执行增量或者差异备份，恢复会失败错误原因：删除备份数据后，则完全备份数据全部被删除，备份需要依赖于完全备份解决方法：删除备份数据后，必须先做一次完全备份问题11：当进入rman阶段的恢复，停止任务停不掉错误原因：恢复任务进入rman阶段后，数据库正在rman恢复时进程是听不掉的，若强制停掉会导致恢复的数据库不可用。信息级别：秘密级21解决方法：不影响使用，任务在rman恢复时停止任务停不掉会正常恢复结束，但显示为任务停止。问题12：数据库损坏时数据无法恢复错误原因：数据库损坏解决方法：1、查看数据库错误日志，数据库为何损坏；当读取表空间数据不一致时，数据库会起不来，这时如果是GBase8s_8.3.81.51_32bit可以通过删除所有bin-log文件重启数据库服务即可。2、如果查看数据库错误日志通过上述方法无法解决可通过重装数据库，启动数据库实例后，执行恢复任务3、异机恢复；找一个相同的良好的环境执行异机恢复，目标机器的数据库安装路径和数据文件存放路径需要和原机器相同	第1章.概述	1.1.目标读者	1.2.本文档适用范围	GBase定时备份功能模块简介	第2章.GBase基础知识简介	2.1.GBase简介	2.2.关键技术原理	2.2.1.GBase备份恢复原理分析	第3章.GBase定时备份恢复最佳实践	3.1.GBaseforWindows定时备份恢复最佳实践	3.1.1.部署注意事项（包括客户端安装、环境配置等前期准备工作）	3.1.2.GBase定时备份注意事项	3.1.3.GBase定时备份最佳操作	3.1.4.GBase定时备份数据恢复最佳操作	3.2.FAQ