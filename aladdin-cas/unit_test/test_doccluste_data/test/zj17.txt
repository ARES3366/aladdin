AnyBackup5.0.2最佳实践重复数据删除目　录第一章概览	31.1简介	31.2主要功能	41.2.1设置重复数据删除策略	41.2.2客户端重删数据任务设置	51.2.3重删支持SSD加速	51.3术语	61.4重复数据删除支持的功能	7第二章限制性列表	8第三章客户端安装	93.1Windows客户端安装	93.2Linux客户端安装	123.3客户端配置	134.1定时备份最佳实践	154.1.1命名规则说明	154.1.2定时备份任务建立	154.1.3配置客户端	194.1.4重复数据删除支持SSD加速	204.2重删任务恢复	24FAQs	24第一章概览1.1简介本文档是爱数备份容灾家族定时备份重复数据删除功能最佳实践文档，要描述了如何正确地使用爱数备份容灾家族产品成员开启重复数据删除策略备份的方法，包括部署前后的注意事项和典型部署方案。AnyBackup5.0提供定时备份任务重复数据删除解决方案。随着数字信息量的爆炸式增长，数据占用空间越来越大；在过去的10年里，很多行业提供的存储系统容量从数十GB发展到数百TB，甚至数PB。随着数据的指数级增长，企业面临的快速备份和恢复的时间点越来越多，管理保存数据的成本及数据中心空间和能耗也变得越来越严重。研究发现，应用系统所保存的数据中高达60%是冗余的，而且随着时间的推移冗余数据越来越多。为了缓解存储系统的空间增长，缩减数据占用空间，降低成本，最大程度地利用已有资源，重复数据删除技术已成为一个热门的研究课题。一方面，利用重复数据删除技术可以对存储空间的利用率进行优化，以消除分布在存储系统中的相同文件或者数据块；另一方面，利用重复数据删除技术可以减少在网络中传输的数据量，进而降低能量消耗和网络成本，并为数据复制节省大量网络带宽。1.2主要功能1.2.1设置重复数据删除策略完全备份一个或多个数据文件组成的一个完整副本，包含从备份开始处所有的数据块。重复数据删除策略支持除操作系统定时备份任务外的所有定时备份任务在完全备份时开启源端重复数据删除功能。增量备份包含从最近一次备份以来被修改、添加或删除的数据块。重复数据删除策略支持除操作系统定时备份任务外的所有定时备份任务在增量备份时启用源端重复数据删除功能。重复数据删除策略不支持编辑任务时修改此策略，故一旦开启重复数据删除的任务在执行完全备份、增量备份、以及某些数据库应用的日志备份时都会保持重复数据删除开启的状态。完全备份恢复开启重复数据删除功能的定时备份任务，已进行完全备份产生时间点，可将用户备份数据恢复到最新及指定时间点的状态，恢复数据正确，恢复方法依据不同定时备份任务可参照具体的定时备份应用最佳实践。增量备份恢复开启重复数据删除功能的定时备份任务，已进行增量备份产生时间点，可将用户备份数据恢复到最新及指定时间点的状态，恢复数据正确，恢复方法依据不同定时备份任务可参照具体的定时备份应用最佳实践。事物日志备份恢复开启重复数据删除功能的定时备份任务，已进行事务日志备份产生时间点，可将用户备份数据恢复到最新及指定时间点的状态，恢复数据正确，恢复方法依据不同定时备份任务可参照具体的定时备份应用最佳实践。某些数据库应用存在事务日志备份。差异备份恢复开启重复数据删除功能的定时备份任务，已进行差异备份产生时间点，可将用户备份数据恢复到最新及指定时间点的状态，恢复数据正确，恢复方法依据不同定时备份任务可参照具体的定时备份应用最佳实践。某些数据库应用存在差异备份。1.2.2客户端重删数据任务设置在【客户端管理】的【配置客户端】界面中提供重删数据任务设置，用户可以自由设置重删缓存存储路径和重删任务内存空间大小，客户端产生的指纹库缓存会存储到重删缓存存储路径下，如果不配置，则使用默认值（客户端安装目录下app\bin\dedupclient.config中的记录）；用户可根据自己客户端实际内存大小环境设置重删任务内存空间大小，可提高重删的效率，默认大小为200MB。1.2.3重删支持SSD加速通过支持SSD作为重删指纹库的存放位置，借助SSD的高性能读写，以提高重删指纹库的查询速度，提升重删效率。支持针对于插入存储柜前面板的SSD硬盘创建RAID，在此RAID上创建唯一的“DDCache卷”类型的卷，DDcache卷是用户存放重删指纹库数据的空间，如果用户没有创建该卷，则创建重删任务时启用重删选项将提示：“如果要启用重删选项，请创建DDcache卷”；如果DDCache卷中有指纹库信息，删除DDcache卷时提示警告信息“删除DDcahce卷将会删除重删指纹库数据，是否确认删除。”1.3术语重复数据删除：重复数据删除是一种数据压缩技术，简称重删，它分为源端重复数据删除和目的端重复数据删除。本文档中所说的重删默认为源端重复数据删除，它指的是在执行重复数据删除时，重复的数据在通过网络发送到存储端之前即被删除。可对网络环境中的重复数据进行识别和删除，并将重复的数据只在存储上保存一份的压缩技术。指纹：每一个数据，采用哈希算法所生成的唯一代表该数据的哈希值，该哈希值称为数据的指纹。指纹库：在存储端保存着所有数据的指纹的区域称为指纹库。重删：重复数据删除的简称。1.4重复数据删除支持的功能下表列出了重复数据删除模块所支持的功能。		功能	子功能	支持	备注	支持各种定时备份开启重删	ActiveDirectory数据库定时备份	√			DB2数据库定时备份	√			DominoServer数据库定时备份	√			ExchangeServer数据库定时备份	√			GBase数据库定时备份	√			Hyper-V虚拟化平台定时备份	√			MySQL数据库定时备份	√			Oracle数据库定时备份	√			SQLServer数据库定时备份	√			Sybase数据库定时备份	√			VMware虚拟化平台定时备份	√			操作系统定时备份	×			文件系统定时备份	√			邮件定时备份	√		备份类型	完全备份	√			增量备份	√			差异备份	√			事务日志备份	√		浏览恢复		√		异机恢复		√	第2章限制性列表1、不支持操作系统定时备份开启重复数据删除功能2、已设置重复数据删除功能的定时备份任务不支持在编辑此任务时修改此策略3、只能创建一个DDCache卷4、删除开启重复数据删除策略的任务数据时，后台数据实际不删除5、重删功能的可用性受软件授权“重复数据删除2TB”控制6、不支持重删数据分割大小的配置7、配置客户端内存空间大小时，如果客户并发任务多，不宜配置过大8、删除了DDCache卷前需重启mediaserver服务。删除了DDCache卷后，原有的重删任务再启动时会执行失败，重建DDCache卷后10分钟内不要重启mediaserver服务9、删除了DDCache卷后，原有的重删任务再启动时不会提示用户去建DDCache卷10、重复数据删除功能不支持介质同步11、重建DDCache卷10分钟内不要重启介质服务，否则备份错误失败12、设置客户端指纹缓存路径时不支持网络路径的配置，如光盘等13、重建DDCache卷将删除原DDCache卷中已存在的数据。若需要使用需在重建DDCache卷前将DDCache卷中的数据迁移出去并保证重建时指定的卷大小和原DDCache卷的大小相同。第三章客户端安装3.1Windows客户端安装(最佳实践)(最佳实践)	安装位置(WWW.EISOO.COM)(20/30)用户可将windows客户端安装包放到任意位置进行双击安装，安装过程根据安装向导提示一步步进行安装，操作简单。开始之前Windows客户端安装包分为：AnybackupClientSetup_x64.exe、AnybackupClientSetup_x86.exe两种，根据用户的具体32位还是64位系统进行选择安装。安装方法1步骤1：双击安装文件进行安装，如图3-1windows客户端安装向导1所示图3-1windows客户端安装向导1步骤2：勾选“我同意此许可”，点击【安装】按钮进行安装，如图3-2windows客户端安装向导2所示图3-2windows客户端安装向导2步骤3：点击【下一步】，进入安装目录的选择安装，如图3-3windows客户端安装向导3所示图3-3windows客户端安装向导3步骤4：配置控制台IP和端口，如图3-4windows客户端安装向导4所示图3-4windows客户端安装向导4步骤5：点击【下一步】，进行选择安装需要的组件或驱动程序，如图3-5windows客户端安装向导5所示，当前系统非2000、2003或xp系统，iSCSI选项不可选，若是在2000、2003或者XP系统中安装客户端，可根据具体备份应用选择是否安装iSCSIInitator，详见各个应用模块最佳实践。图3-5windows客户端安装向导5步骤6：点击【下一步】、【安装】进行客户端程序的安装，如图3-6windows客户端安装向导6所示图3-6windows客户端安装向导6步骤7：安装完成，如图3-7windows客户端安装向导7图3-7windows客户端安装向导73.2Linux客户端安装root用户下，在根目录下，创建eisoo文件夹；将确定好的客户端安装包上传到eisoo目录下，然后用tar–zxvfpackage_name的方式解压；[root@localhosteisoo]#tar-zxvfAnyBackupClient_Redhat_5_x86-5.0.0-20140304-release-1496.tar.gz切换到客户端安装文件夹的bin目录下，运行脚本./install.sh；[root@localhostbin]#cd/eisoo/AnyBackupClient_Redhat_5_x86-LASTEST/app/bin[root@localhostbin]#./install.sh在客户端安装过程中，安装程序会检测安装条件是否满足，在条件不满足时，需要手动调整或者选择让程序自行调整，调整完成后，安装任务继续；第一步，填写自己的IP地址，针对一个服务器有多个网卡的情况，通过输入此IP，可以使备份数据通过指定的网卡备份，同时在控制台中显示时，显示该IP地址；第二步，填写控制台的IP地址；第三步，选择支持的数据库，在做oracle备份时，需要选择oracle；选择oracle数据库后，程序要求输入安装oracle数据库的用户名，此处应注意，有很多环境中，oracle数据库不是安装在oracle用户下的，此处应当根据实际环境填写；第四步，选择是否安装CDP驱动，如果用户需要做实时备份或者应用容灾，需要安装此驱动，做定时备份不需要安装，此处我们选择no；第五步，确认选择无误后，输入y，确认安装；如果之前选择有误，可以输入no注意事项:1.务必将客户端安装在新建的eisoo目录下，因为客户端安装会修改客户端所在目录的权限，如果安装在系统目录下，系统目录的权限可能会被修改造成系统问题或者用户应用出现问题；2.Linux客户端安装前会检查系统环境是否符合要求，如果系统不是在premissivemodel的状态下，输入命令#/usr/sbin/setenforce0，使SELinux的状态为premissivemodel。3.3客户端配置在浏览器上输入http://IP:9800/的方式，然后用用户名和密码登录控制台；点击备份容灾，客户端名称中，可以查看新安装的客户端；将鼠标放在客户端上，可以查看客户端的详细信息，如下图；用鼠标选中对应的客户端，然后用户可以通过点击齿轮状的按钮，可以进行以下操作：新建客户端组：根据向导，建立用户端组后，用户可以采用鼠标拖动的方式，将对应的客户端加入对应的组中；修改名称：默认的名称为操作系统的hostname，而hostname不好识别，用户可以根据需要给客户端命名为一个容易识别的名称，以便管理；配置客户端：该选项，可以配置重删数据任务设置，根据用户的实际资源情况，设置对应的数值即可，其中内存使用限制越大，性能越好；新建虚拟客户端：在此选项中，用户可以选择创建双机、集群、hyper-v和VMware客户端；第四章重复数据删除最佳实践4.1定时备份最佳实践4.1.1命名规则说明1.【命名规则】:用户名、任务组、任务等对象命名规则满足：不允许为空，且名称长度必须为3~50个字符；2.【邮件命名规则】:Email地址只能由字母A~Za~z、数字0~9及特殊字符@.-_组成，类似于yourname@domain.com的形式，且最长不能超过50个字符；3.【备注信息规范】：备注信息最大不超过255字符；4.1.2定时备份任务建立1.以文件系统定时备份开启重删为例建立定时备份任务，其他定时备份应用任务参照对应的最佳实践文档，登录爱数备份控制台，点击备份容灾选中对应的客户端在任务管理中，点击新建按钮选择定时备份选择文件系统；2.输入任务名称，在备注处，输入自己想要的备份信息，选择想要的介质服务器作为备份的目的地，信息填写完毕后，点击[下一步]按钮；3.在选项中，填设置想要的备份类型，是否开启高级功能选项，各个选项说明如下：【重复数据删除选项】勾选该选项可以启动源端重复数据删除的功能，该选项，在建立任务后，不能通过修改任务的方式更改此属性；【备份数据保存完全副本数】可以设置用户保留完全副本的个数；设置完成后，点击【下一步】按钮，继续；4.点击“+”号，可以正常展开数据源，选中数据源，然后点击【下一步】继续；5.点击【新建】按钮创建备份任务计划，然后点击【确定】、【完成】，完成任务的创建。设置计划，在此步骤，用户可以选择定时备份任务的执行策略，如执行什么类型的备份任务、一次性执行、每天执行、每周执行、每月执行；开始时间为任务生效的时间，可以根据需要设置；高级计划选项，设置可以使任务在规定的时间内重复执行；同时在此步骤，可以新建、修改、删除、暂停的功能，点击对应的按钮，即可进行此操作；6.在任务创建完毕后，如果觉得任务配置信息有误，可以在【任务管理】中再选中该任务，并点击“编辑”按钮进行编辑；编辑的步骤和创建任务的步骤基本相同；重删策略不支持修改，此选项被置灰；7.计划设置完毕，如果资源足够，可立即开始一次完全备份。选中任务，点击【发起】按钮，可以看到可以发起的操作类型，点击【备份】按钮，即可开始备份操作；注意事项：1.发起备份任务时，提示“请求失败，您没有进行该操作的权限”，该问题是由于控制台没有进行相关的授权，添加对应的授权后，即可解决；8.添加授权在控制台界面，【运营管理】【许可证管理】中添加，输入对应的授权码和重复数据删除代理，点击在线激活即可；注意事项：1.如果无法在线激活，请先配置好有效的DNS地址；2.启用重删时如果没有创建DDCache卷，会提示“如果要启用重删选项，请创建DDCache卷”，创建了DDCache卷后才能选择启用重删选项。4.1.3配置客户端1.在【客户端组】处选择某客户端，点击齿轮按钮，选择【配置客户端】可对重删任务进行客户端指纹缓存路径配置和内存缓存空间大小配置；2.重删缓存存储路径可以通过手动输入，也可以点击【浏览】按钮进行路径选择，【重删缓存存储路径】：重删任务数据缓存存储路径，通过【浏览】按钮选择客户端上的存储路径；如果不配置，则使用默认值（客户端app\bin\dedupclient.config配置文件中的记录），如cache_store_path=D:\sysvol对手动输入的动作做如下检查:<1>windows路径格式中不包含*?"<>|，如果输入包含以上字符提示错误：重删缓存存储路径不应包含下列字符：*?"<>|<2>如果输入路径的盘符不存在，则在“确定”时给出错误提示信息“重删缓存存储路径检测不存在”<3>不支持网络路径3.【重删任务内存空间】：重删任务内存使用范围限制。默认200MB，约束为输入正整数。其中内存使用限制越大，性能越好；一般取默认值200MB就可以了，如果用户客户端实际内存比较大而且用户的并发任务不是很多可以配大点，如果并发任务多配置默认值为宜。内存配置太大并发任务一多客户端内存很快会被吃光，任务执行失败。注意事项：1.配置重删任务内存空间大小时，如果输入类似”123%……&&&“这样的值也会保存成功，保存值为实际的数值“123”，即内存大小限制为123MB，数字在前字母或特殊字符在后的输入情况不会做检测；输入的最小值限制为1MB；小数输入值会默认取其正整数部分值。4.1.4重复数据删除支持SSD加速1.增加SSD硬盘来作为指纹库存储介质的目的是为了提高指纹库查询速度，提升重删率2.使用场景：·用户采购了SSD硬盘，期望通过在SSD上存放重删指纹库，提高重删效率1>针对于插入存储柜前面板的SSD硬盘创建Raid2>支持在创建卷时，可以指定该Raid后，创建新增名为“DDCache”的卷类型，分配卷大小即可3>该存储柜的重删任务的指纹库会存放在这个卷中·用户无SSD硬盘，期望通过在普通硬盘存放重删指纹库1>针对于插入存储柜前面板的HDD硬盘创建Raid2>支持在创建卷时，可以指定该Raid后，创建新增名为“DDCache”的卷类型，分配卷大小即可3>该存储柜的重删任务的指纹库会存放在这个卷中3.在没有创建DDCache卷时，启用重删选项时将提示：“如果要启用重删选项，请创建DDCache卷“4.在【存储管理】->【介质服务器管理】->【磁盘管理】->【创建卷】，选择DDCache卷类型进行创建，根据需要选择已建的RAID上分配DDCache卷的大小，DDCache卷的大小约为每1T重删后的数据（无重复块），需要23GDDCache空间存放指纹。5.选好卷类型和卷大小以及RAID后，点击【保存】，创建DDCache卷6.创建了DDCache卷后再去创建重删任务执行备份，不会再提示“如果要启用重删选项，请创建DDCache卷“，任务执行过程中指纹信息会写到此卷上7.删除DDCache卷：在【存储管理】->【介质服务器管理】->【磁盘管理】->【卷管理】，选择DDCache卷，点击【删除卷】按钮进行删除。删除时如果有指纹数据，会提示“删除DDcahce卷将会删除重删指纹库数据，是否确认删除。”注意事项：1.有重删任务正在执行时不能删除DDCache卷，抛错；2.重新安装了AnyBackup5.0.1的server包后删除DDCache卷，原有的重删任务再启动时会因为没有DDCache卷执行失败，重建DDCache卷后才能使指纹数据重新写到DDCache卷中；3.删除了DDCache卷后，原有的重删任务再启动时不会提示用户重建DDCache卷，但任务会执行失败结束4.删除DDCache卷时，即使有指纹数据也可以删除，不影响已备份任务的恢复，但是再次备份重删任务时，数据会像没有备份过一样重新计算指纹信息、存储指纹信息、重删率；5.DDCache卷只能创建一个；6.如果DDCache卷满，需要重建DDCache卷才可继续使用；4.2重删任务恢复重删任务恢复与一般的没有开启重删备份的任务恢复过程相同，请参照其他各应用最佳实践文档。FAQs1.配置重删客户端怎样提高备份速度？配置客户端任务内存空间越大，备份的速度会越快，但是这个要根据用户客户端实际内存大小情况来配置，还有客户端备份任务并发数，一般使用默认值就可以了。具体参照以下：·客户端开重删内存消耗规律     开重删后客户端内存占用峰值：   （300M+160M+n)*任务数   n为配置客户端时输入的“重删任务内存空间”，默认为200M。     每个任务开重删备份时都会消耗客户端(300M+160M+n)这么多内存，有多少个任务数就会占用（300M+160M+n）*任务数 这么多内存且  （300M+160M+n)*任务数<客户端内存总数   如果按这个公式计算的内存总数超过了客户端的内存总数时，实际每个任务占用不了(300M+160M+n)这么多内存，有些任务的内存占的多，有的任务内存占的少，最多不超过(300M+160M+n)例如：如果配置为200M，任务数为4，客户端实际内存大小为16G，重删任务占用客户端内存为（300+200+160）*4=2640M如果配置为2G，任务数为10，客户端实际内存大小为16G，重删任务占用客户端内存为不确定值，各个任务内存占用有大有小，总大小<16G，因为（2000+300+160）*10=24600M>16G超过了客户端的实际内存大小·开重删后服务器端内存占用峰值：    2G+300M*任务数+X（X：每1T重删前数据占用1G，根据备份的数据量计算）通过大量的测试观察发现，服务器端内存占用基本满足这个公式，内存增长缓慢，不像客户端那样根据任务数成倍增长，所以客户端配置一般建议采用默认配置200M即可，如果客户端实际内存较大，用户可适当增加配置的内存大小，如果是多任务并发也不宜配置过大的内存空间，内存空间配置大对提升性能有一定的作用，但不是必须的，根据测试结果默认配置基本满足需求，性能体验还行。不正确的客户端内存配置，可能会导致并发任务执行卡死。2.创建DDCache卷如何提高备份速度？重删指纹库固定存放在DDcache卷中，不会占用别的路径下的空间，导致系统空间满通过支持SSD作为重删指纹库的存放地点，借助SSD的高性能读写，以提高重删指纹库的查询速度，提升重删效率3.如何删除OFS介质中数据后重建OFS卷和DDCache卷重启mediaserver服务？删除OFS数据servicemediaserverstoprm-rf/var/lib/newcore/AnyBackup/*rrm-rf/sysvol/_high_cache_disk_/backup/OFS/*rm-rf/sysvol/node/volume1/OFS/*删除指纹库数据rm-rf/sysvol/node/volume_dc/*servicemediaserverstart在web界面上删除后重建OFS卷和DDCache卷以上不允许用户在后台进行操作，如果技术支持人员在后台删除了OFS介质或指纹库的数据时，需做以上操作并在WEB界面上删除ofs和DDCache卷后(新建DDCache卷需等10分钟才能重启mediaserver服务)重建，保险起见重启下mediaserver服务。不重启时会报错。4.配置DDCache卷空间大小时，如何判断该取多大的DDCache卷？参考如下公式：22.67GB*N+512MBN对应重删后的数据量，单位为TB，空间最大上浮4GB建议配置DDCache卷初始大小至少400G以上5.更换了Server包后，没有重建DDCache卷，执行重删任务会怎么样？如果更换Server包后，不重建DDCache卷，在/apphome/app/bin目录下的dedupserver.config文件中指纹存储路径为空，如#指纹数据的存储路径data_store_path=需修改为当前DDCache卷路劲后，如#指纹数据的存储路径data_store_path=/sysvol/node/volume_dc重启介质服务，指纹库才能存储到对应的DDCache中。#指纹数据和索引数据占用空间大小，单位为GBdata_store_size=500此修改根据实际配置的DDCache卷大小配置，该大小应与DDCache卷的大小相同，否则将导致备份异常，不建议使用该方法修改。以上操作不允许用户操作，由技术支持人员换包后，在不重建DDCache卷情况下做以上操作。6.客户端指纹缓存路劲下空间已满时，备份重删任务会怎么样？客户端指纹缓存路径下空间已满时，再备份重删任务时，windows客户端环境新增的指纹信息会直接被抛弃不会保留，任务不会抛错，正常执行完成，linux客户端环境会报错执行失败。7.新建DDCache卷后，不等待10分钟就重启介质服务会发生什么？如果新建DDCache卷后，不等待10分钟就重启介质服务，然后发起重删任务的备份，任务很可能会执行失败，报类似这样的错备份任务进行时，出现异常（错误提供者：fileBackup，错误值：e029000d，错误位置：ncFileBackupExec.cpp:254）（附加信息：获取指纹库数据版本超时。（错误提供者：dedupclient，错误值：6，错误位置：il/ncDedupClientExecutor.cpp:70））如果出现此问题，什么都不用操作再备份一次就好了8.当开启重删的环境下执行速度较慢，怎样解决？首先查看存储柜的cached值，如果cached值小于6GB时，可以使用以下方法进行性能调优。1)打开/etc/sysctl.conf文件。#vi/etc/sysctl.conf2)修改如下参数的值为下方参数对应的值，如参数名不存在则新增。vm.min_free_kbytes=0	vm.swappiness=0	vm.vfs_cache_pressure=0	vm.dirty_background_ratio=50	vm.dirty_ratio=80	vm.dirty_writeback_centisecs=100003)保存/etc/sysctl.conf文件，并执行sysctl-p命令。(地址：上海市联航路1188号浦江智谷8号楼2层A座邮编：201112咨询热线：021-54222601服务热线：400-880-1569传真：021-54326441客服邮箱：support@eisoo.com)