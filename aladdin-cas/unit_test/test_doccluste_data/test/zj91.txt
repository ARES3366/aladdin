�信息级别：秘密级IExchangeServer备份恢复最佳实践——爱数备份容灾家族3.5信息级别：秘密级I版权所有版权所有©2003-2013爱数软件有限公司。未经本公司书面许可，任何单位或个人不得以任何形式，复制、传播、摘抄本FAQ内容的部分或全部。本FAQ内容上可能会有增删和修改，爱数软件有限公司会定期将修订后的内容纳入新版本中，如有更改恕不另行通知。信息级别：秘密级II关于爱数作为全球智能数据管理解决方案提供商，爱数围绕客户的需求持续创新，与合作伙伴开放合作，在存储整合、备份容灾、文档管理、安全归档、云计算等多个领域构筑了围绕数据生命周期管理的创新型解决方案。在政府、教育、医疗卫生、企业等诸多领域，爱数为客户提供有竞争力的智能数据管理解决方案和服务，包括备份容灾一体化领域的旗帜——EISOOAnyBackupFamily；安全文档云——EISOOAnyShareFamily；以及面向数据中心和共享灾备中心的备份容灾云解决方案——EISOOTxFamily；同时还提供给用户和合作伙伴高附加值的EISOOAnySupport贴心服务。目前，爱数的产品和解决方案已经成功服务于全球上万用户，并持续改善客户体验，提升业务价值，共同迈向成功。爱数软件有限公司地址：上海市闵行区联航路1188号浦江智谷8号楼2层A座邮编：201112网址：www.eisoo.com客户服务电话：021-54222601客户服务邮箱：support@eisoo.comhttp://www.hanqintech.com/mailto:support@eisoo.com信息级别：秘密级III目录第一章概述..............................................................................................................................11.1目标读者...........................................................................................................................11.2本文档适用范围...............................................................................................................11.3ExchangeServer数据容灾功能模块简介.......................................................................1第二章ExchangeServer基础知识简介...................................................................................32.1关键技术原理...................................................................................................................32.1.1VSS快照技术.........................................................................................................32.1.2Exchange事务日志记录........................................................................................42.1.3备份类型................................................................................................................42.1.4ExchangeServer2007/2010备份方式...............................................................52.1.5ExchangeServer2010DAG的备份恢复..............................................................5第三章ExchangeServer数据容灾最佳实践...........................................................................63.1ExchangeServerforWindows备份最佳实践..................................................................63.1.1部署注意事项（包括客户端安装、环境配置等前期准备工作）....................63.1.2定时备份最佳操作................................................................................................73.2ExchangeServerforWindows恢复最佳实践...............................................................113.2.1恢复注意事项.....................................................................................................113.2.2恢复最佳操作.....................................................................................................123.3FAQ..................................................................................................................................14信息级别：秘密级1第一章概述本文档是爱数备份容灾家族ExchangeServer一体化容灾最佳实践文档，主要描述了如何正确地使用爱数备份容灾家族产品成员进行ExchangeServer数据容灾及应用容灾的方法，包括部署前后的注意事项和典型部署方案。1.1目标读者本技术文档面向爱数备份容灾家族产品成员的用户和相关技术人员，主要介绍数据容灾和应用容灾的基础知识，以及如何正确使用爱数备份容灾家族产品成员部署ExchangeServer数据容灾及应用容灾。旨在通过此文档帮助用户和技术人员快速掌握ExchangeServer数据容灾和应用容灾模块使用方法。1.2本文档适用范围项目范围产品爱数备份存储柜3.5.13爱数备份软件3.5.13ExchangeServer版本ExchangeServer2007(32/64bit)SP2ExchangeServer2010操作系统版本WindowsServer2003(32/64bit)WindowsServer2008(32/64bit)WindowsServer2008R2提示：本文档中的界面截图来自爱数备份存储柜3.5.13，其他版本有类似的界面。1.3ExchangeServer数据容灾功能模块简介功能描述备份类型完全备份和增量备份循环备份完全备份和增量备份相结合的循环支持备份的内容邮箱数据库，公用文件夹数据库，事务日志文件备份粒度单个存储组（ExchangeServer2007）单个数据库（ExchangeServer2010）单任务多客户端备份支持恢复方式浏览恢复恢复位置原位置恢复粒度服务器、单个存储组（ExchangeServer2007）信息级别：秘密级2服务器、单个数据库（ExchangeServer2010）异机恢复不支持恢复后自动装载不支持信息级别：秘密级3第二章ExchangeServer基础知识简介MicrosoftExchangeServer是一个主面的Intranet协作应用服务器，适合有各种协作需求的用户使用。ExchangeServer协作应用的出发点是业界领先的消息交换基础，它提供了业界最强的扩展性、可靠性、安全性和最高的处理性能。ExchangeServer提供了包括从电子邮件、会议安排、团体日程管理、任务管理、文档管理、实时会议和工作流等丰富的协作应用，而所有应用都可以从通过Internet浏览器来访问。ExchangeServer是一个设计完备的邮件服务器产品，提供了通常所需要的全部邮件服务功能。除了常规的SMTP/POP协议服务之外，它还支持IMAP4、LDAP和NNTP协议。ExchangeServer服务器有两种版本，标准版包括ActiveServer、网络新闻服务和一系列与其他邮件系统的接口；企业版除了包括标准版的功能外，还包括与IBMOfficeVision、X.400、VM和SNADS通信的电子邮件网关，ExchangeServer支持基于Web浏览器的邮件访问。ExchangeServer数据库的存储结构由四大部分组成：邮箱存储（MailboxStore）、公用文件夹存储（PublicFolderStore）、事务日志文件（TransactionLog）、域控制服务器的系统状态（SystemState）。邮件的数据、公用数据夹数据与分别存放在MailboxStore与PublicFolderStore中。ExchangeServer的数据库（store）是由两个档案所组成：丰富文本文件（扩展名为.EDB），它存放了每封邮件讯息和MessageApplicationProgrammingInterface（MAPI）的内容。另一个则为原始内容「数据流（Stream）」档案（扩展名为.STM），它保存了所有非MAPI的信息。因此，信箱存放区是由Priv1.edb和Priv1.stm。公用数据夹存放区是由Pub1.edb和Pub1.stm组成。每一个Store里都有这两个档案，且ExchangeServer将这两个档案视为一组。所以每一个存放区（Store）的大小，就是将丰富文本文件、原始内容文件、和事务日志文件组合在一起后的大小。这两种数据都以ExtensibleStorageEngine（ESE）数据库格式存放。2.1关键技术原理2.1.1VSS快照技术卷影拷贝服务（VolumeShadowCopyService，VSS）是Microsoft在WindowsServer2003中开始引入的服务，它能让用户在没有IT专业人员协助的情况下，更轻松地恢复丢失的文件。通过使用VSS，在特定卷上建立数据拷贝时间点，并在将来的某一时刻把数据恢复到任何一个你曾创建的时间点的状态。VSS使用copyonwrite技术进行快照，COW快照需要消耗一些存储空间–建立快照卷。当我们为一个数据卷创建一个快照之后，这些预留的空间用来存放被变化数据更新的旧数据。COW快照在初始化的过程中仅仅创建用来描述源数据块位置的指针信息(元数据)，而不是完整的将源数据块拷贝过来。因此初始化的过程几乎可以在瞬间完成，对系统的影响也很小。COW快照会跟踪数据卷的写操作和数据块变化。当某个数据块发生改变时，在将旧的信息级别：秘密级4数据覆盖之前，首先将该块的旧数据复制到预留的快照卷，该步骤仅在数据卷相应数据块位置发生第一次写操作请求时进行。如果我们需要访问某个时间点的快照数据，对没有改变过的块直接从数据卷读取;对已经改变并被复制的块则从快照空间读取。从快照被创建那一刻开始，每个快照都会跟踪记录描述块改变的元数据信息。COW快照的主要优势在于空间的高效利用，因为快照卷只需要保留发生过变化的数据块，与数据卷相比要小得多。但是我们也知道COW快照有个缺点，它会引起数据卷性能的下降，这是因为创建快照之后，对数据卷的写操作会增加一个等待的过程–即旧数据块复制到快照卷的过程。另外一个关键问题是每个快照卷必须依赖一个完整的数据卷。2.1.2Exchange事务日志记录Microsoft®ExchangeServer事务日志记录是一种强大的灾难恢复机制，设计用于在数据库突然发生停止时，将Exchange数据库可靠地还原到一致的状态。在对Exchange数据库文件进行实际更改之前，Exchange会将更改写入事务日志文件。安全记录一个更改之后，可将其写入数据库文件。通常在将更改安全写入事务日志之后最终用户即可使用这些更改，直到将其写入数据库文件为止。Exchange使用一个复杂的可获得高性能的内部内存管理系统。在正常操作期间，以物理方式向数据库文件写入更改是低优先级的任务。Exchange可以有效管理超过1GB数据库页的缓存。此缓存包括从数据库读取的用于满足客户端请求的页，以及最终将被写回数据库文件的已更改的页。如果数据库突然停止，已缓存的更改将不会仅因为内存缓存受到破坏而丢失。重新启动数据库时，Exchange将扫描日志文件，并重建和应用尚未写入数据库文件的任何更改。此过程称为“重播”日志文件。数据库的构建方式使Exchange能够确定日志文件中的任何操作是否已应用到数据库、需要应用到数据库，或者不属于数据库。与将所有的日志信息写入单个大型文件不同，Exchange使用一系列日志文件，每个日志文件的大小是固定的。如果日志文件已满，Exchange会将其关闭，并使用序号对其重命名。所填充的第一个日志的名称以Enn00001.log结束。nn是指称为基名称或日志前缀的两位数字。检查点文件(Enn.chk)将跟踪Exchange向数据库文件写入记录的信息所执行的进度。通常，在繁忙的数据库上，检查点将比当前打开的日志落后三或四个日志文件。每个日志流都有一个检查点文件，并且每个存储组有一个单独的日志流。在单个存储组中，所有的数据库共享单个日志流。因此，单个日志文件通常包含对多个数据库的操作。2.1.3备份类型Microsoft®ExchangeServer主要包括两种备份方式：完全备份和增量备份。下面简单介绍这两种备份方式。完全备份备份被选中的数据库的数据信息，包括数据库文件、日志文件和检查点文件。与增量备信息级别：秘密级5份相比，完全备份中的每个备份使用的存储空间更多，花费的时间也更多，所以完全备份的创建频率通常比增量备份低。增量备份增量备份是备份自上次完全备份后的所有更改，仅仅备份事务日志文件而不备份当前数据库，并且不截断日志。该次完全备份称为增量备份的“基准”。在还原增量备份时，首先会还原其基准备份，然后依次还原离基准备份最近的增量备份。相比之下，还原增量备份会花费更多的时间。2.1.4ExchangeServer2007/2010备份方式MicrosoftExchangeServer2007包括用于数据备份和恢复的两个不同选项：可扩展存储引擎（ESE）流式备份API，并且支持卷影复制服务（VSS）备份API。ExchangeServer2010不再支持ESE流式API用以备份和还原程序文件或数据。而ExchangeServer2010仅支持基于VSS的备份。ExchangeServer2007用VSS备份，只支持存储组级别的备份，因为VSS是对指定卷做快照，无法区分同一存储组中的日志分别属于哪个数据库。ExchangeServer2010当不同数据库的存储位置不相同时，支持数据库级别的备份。2.1.5ExchangeServer2010DAG的备份恢复因为ExchangeServer2010仅支持基于VSS的备份，而ExchangeDAG是由ExchangeServer2010构成，所以ExchangeDAG只支持VSS备份。对于ExchangeDAG，我们采用的是单机模式去备份，如果需要对ExchangeDAG进行备份，要求将所有Exchange服务器的客户端的相应数据源都选上，然后对承载的主动副本进行备份。对于恢复，ExchangeDAG必须要求恢复到主动副本才会有作用。恢复时，如果主动副本分散在ExchangeDAG的不同服务器上，则需要将备份的数据库分别恢复到其主动副本所在的Exchange服务器。信息级别：秘密级6第三章ExchangeServer数据容灾最佳实践3.1ExchangeServerforWindows备份最佳实践3.1.1部署注意事项（包括客户端安装、环境配置等前期准备工作）1.客户端版本爱数备份存储柜客户端包括32-bit和64-bit两种类型，如果您使用的ExchangeServer为32-bit版本，则您只能使用32-bit的客户端(即使是在64位操作系统上，也只能使用32-bit的客户端)；如果您使用的ExchangeServer为64-bit版本,请使用64-bit的客户端。如果您使用的客户端版本位数和备份的ExchangeServer版本位数不一致，可能会导致展开数据源失败。2.客户端类型爱数备份存储柜客户端类型有三种：普通型、后台型、安全型，如下图。如果你在域用户登陆的服务器上安装安全型客户端，将会导致无法进行身份验证；因此，如果服务器的登陆用户是域用户，请安装普通型或后台型客户端。3.数据库的状态利用爱数备份存储柜进行备份时，请确保服务器上至少有一个数据库的状态为“已装入”，否则备份时会出错。4.数据库文件存放位置信息级别：秘密级7ExchangeServer2007：如果只备份部分存储组，而不是整个服务器的话，您需要确保服务器上的不同存储组下的数据库的数据库文件没有放在同一个文件夹下，否则会导致备份出错。ExchangeServer2010：如果只备份部分数据库，而不是整个服务器的话，您需要确保服务器上的不同数据库的数据库文件没有放在同一个文件夹下，否则会导致备份出错。5.ExchangeDAG选择数据源利用爱数备份存储柜进行备份时，您需要将数据库位于不同服务器上的主、被动副本都勾选上；否则，数据库的主动副本所在的服务器变化时，该数据库可能就不参与备份了。6.ExchangeServer备份内容爱数备份存储柜只备份ExchangeServer数据库的数据信息，其配置信息并不备份；邮箱及其用户信息存放在ActiveDirectory中，也不备份。3.1.2定时备份最佳操作1.配置客户端以管理员身份登录管理控制台，单击左边【系统管理】中的【客户端管理】，进入客户端管理界面。在右边的客户端列表中单击选择需要的客户端，然后单击【配置客户端】菜单，弹出【修改客户端配置】窗口如下所示：勾选ExchangeServer，然后单击【确定】按钮后退出。信息级别：秘密级82.新建定时备份任务步骤一：登录管理控制台，依次点击【备份恢复管理】→【备份管理】→【定时备份管理】，单击右边的【新建任务】菜单，弹出的【新建定时备份任务向导】对话框如下图所示：勾选【备份数据库】，在【请选择】下拉列表中选择ExchangeServer，然后单击【下一步】按钮，进入【任务基本信息】对话框。步骤二：【任务基本信息】对话框如下图所示：信息级别：秘密级9请输入任务名，选择任务组和备份目的地，确定是否勾选“启用源端重复数据删除”，单击【下一步】按钮，进入【选择数据源】对话框。步骤三：进入【选择数据源】对话框后，选择您所需要备份的数据库，单击【下一步】按钮，进入【设置计划及事件】对话框。信息级别：秘密级10步骤四：【设置计划及事件】对话框如下图所示：在设置【开始时间】时，爱数备份存储柜建议您尽量在服务器空闲时进行备份操作；另信息级别：秘密级11外，在设置【备份数据的保留策略】时，可在综合考虑您的存储空间和数据需求等因素后进行合理的设置。提示：在设置“备份数据的保留策略”时，可能会出现这样的错误操作。假设这样一个场景，使用者tom设置“该任务中每个客户端最多保存的完全副本数”为2，备份策略是每隔3个小时进行一次完全备份，上午8：00备份任务开启，下午2：00时，就会出现两个完全备份集。按照备份策略，下午2：00会进行一次完全备份，因为tom设置只保留2个完全备份集，所以下午2：00产生的这个完全备份集就会覆盖上午8：00的完全备份集，造成数据丢失。所以请您在考虑完全备份操作执行的时间间隔因素后，再设置合理的副本数。步骤五：在【设置计划及事件】视图下，打开【选项】，如下图设置完【选项】后，单击【确定】，然后单击【完成】按钮，退出备份任务向导。3.2ExchangeServerforWindows恢复最佳实践3.2.1恢复注意事项1.异机恢复（非ExchangeDAG）爱数备份存储柜不支持将备份数据恢复到其他安装有ExchangeServer的服务器，否则可能导致错误的操作行为。2.ExchangeDAG恢复信息级别：秘密级12如果在备份过程中改变了数据库主动副本所在的服务器，或者恢复前改变了数据库主动副本所在的服务器，恢复时需要将数据库恢复到它的主动副本所在的服务器。如果将数据库恢复到其被动副本所在的服务器，爱数备份存储柜将默认不恢复。3.数据库文件、日志文件的存放路径恢复时数据库文件和日志文件的存放路径，必须和备份时一致，否则会导致错误的操作行为。4.恢复前卸载数据库在恢复ExchangeServer数据库时，爱数备份存储柜会将要恢复的数据库先卸载。因此，在恢复前，请确保要恢复的数据库没有在使用过程中，否则会导致用户无法登陆并访问ExchangeServer数据库中的数据。3.2.2恢复最佳操作步骤一：登录管理控制台，依次点击【备份恢复管理】→【恢复管理】→【浏览恢复】。步骤二：展开介质服务器/介质同步服务器根节点，在任务列表框中单击展开您需要恢复的ExchangeServer定时备份任务，单击选择需要恢复的客户端。信息级别：秘密级13步骤三：单击右边的【时间点】，选择您需要恢复到的时间点。单击展开数据源，如下图所示。在数据源中选择您需要恢复的数据库，然后点击【恢复到客户端】菜单，将弹出【ExchangeServer数据库恢复】对话框。步骤四：单击【恢复到客户端】菜单，弹出的【ExchangeServer数据库恢复】对话框如下图所示。信息级别：秘密级14单击【恢复】按钮，将跳出定时备份数据恢复风险警告，见下图。单击【确认执行】，提交该恢复操作到任务执行队列。恢复完后，恢复的数据库状态为卸载，需要手动装载后才能使用。3.3FAQ问题1：备份失败，提示没有找到匹配的WRITERCOMPONENT问题原因：卷影复制服务管理工具命令行里面没有MicrosoftExchangeWriter，可以在命令提示符里输入命令vssadminlistwriters查看解决方法：重启Exchange信息存储服务。问题2：备份失败，没有找到匹配的COMPONENT问题原因：所备份的服务器的所有数据库均处于卸载状态信息级别：秘密级15解决方法：随便装载一个数据库，或者新建一个数据库问题3：备份失败，提示给定的备份数据源只支持整个服务一起备份问题原因：ExchangeServer2007：不同存储组下的数据库的数据库文件放在同一个文件夹下，备份时数据源不是整个服务器。ExchangeServer2010：不同数据库的数据库文件放在同一个文件夹，备份时数据源不是整个服务器解决方法：修改任务的数据源为整个服务器，或者，修改数据库的存储路径（将不同存储组下的数据库的数据库文件放在不同的位置（ExchangeServer2007），或者将不同数据库的数据库文件放在不同的位置（ExchangeServer2010））问题4：恢复后，手动装载数据库失败错误描述：数据库重建，恢复备份数据，手动装载数据库，装入数据库失败，如下图所示解决方法：装载数据库失败的原因有很多，如果出现图中的错误描述（hr=0x80004005,ec=1011），则是由于数据库的GUID不一致导致。可以在手动装载之前，右击对应数据库的属性，勾选【还原时可以覆盖此数据库】选项。问题5：利用OutlookWebApp访问邮箱，提示无法访问ActiveDirectory资源。错误描述：数据库和邮箱重建后，恢复备份数据，手动装载数据库，然后利用OutlookWebApp访问邮箱，提示无法访问ActiveDirectory资源。解决方法：1.数据恢复成功后，在ActiveDirectory里添加于之前一模一样的用户（先删除刚才重建的邮箱（包含用户））；2.在【收件人配置】里面点击【断开连接的邮箱】，如果没有出现已被删除的邮箱，可在ExchangeManagementShell（或Exchange命令行管理程序）中输入命令：信息级别：秘密级16Clean-MailboxDatabase–Identity“MailboxDatabaseName”（将MailboxDatabaseName替换成恢复的邮箱数据库的名字）；3.刷新【断开连接的邮箱】界面，右击邮箱，点击【连接】，按照提示（选择【匹配用户】）操作即可；如果该数据库中包含多个邮箱，需要对每个邮箱执行上述操作；4.重启ActiveDirectory域控制器和ExchangeServer服务器（注意，应先将服务器关机，然后重启域控，之后再将服务器开机）。注意事项：此种方法只在【保留已删除的邮箱期限】时间内有效，具体设置界面见下图问题6：ExchangeServer2007在发件箱或收件箱中删除邮件，立即恢复备份时间点，删除的邮件没有恢复回来。问题描述：ExchangeServer2007备份完后，用户登陆在发件箱或收件箱中删除邮件，然后立即恢复刚才备份的时间点，恢复后手动装载数据库，发现删除的邮件没有出现发件箱或收件箱中。解决方法：1.等一段时间（取决于机器的性能，一般1~2分钟）再恢复一次；2.从【已删除邮件】邮件里面将邮件直接移到发件箱或者收件箱中。问题7：ExchangeServer2010恢复前删除数据库文件夹及其内容，恢复备份时间点失败。信息级别：秘密级17问题描述：ExchangeServer2010备份数据库xiaoming，卸载数据库xiaoming，然后删除数据库xiaoming的所有数据（包括文件夹xiaoming）；恢复备份数据到原客户端，恢复失败，如下图解决方法：手动在提示中的目录下创建文件夹xiaoming，然后再恢复备份数据。问题8：ExchangeDAG恢复后装载部分数据库失败。问题描述：ExchangeDAG备份数据库，恢复备份数据到主动副本所在的服务器，装载数据库失败，如下图解决方法：装载数据库失败的原因有很多，如果出现图中的错误描述（hr=0x80004005,ec=-515），则可以尝试将日志E0n.log（其中n为0,1,2,……）剪切到另一个位置，然后再装载。信息级别：秘密级18问题9：恢复Exchange增量备份时间点失败，提示获取Exchange数据库失败。问题描述：恢复Exchange增量备份时间点，恢复失败，提示获取Exchange数据库失败，如下图可能原因及解决方法：1.备份的Exchange版本为ExchangeServer2007SP1及以下，并且日志信息中有类似下图的错误如果出现这种问题，请将ExchangeServer2007升级到SP2及以上。2.要恢复的Exchange数据库无法卸载，可以打开Exchange管理控制台，手动卸载对应的数据库。如果出现这种问题，可以查看系统日志，了解Exchange数据库信息级别：秘密级19不能卸载的具体原因，一般可以通过重新启动信息存储服务解决此类问题。信息级别：秘密级20上海爱数软件有限公司Add：上海市闵行区联航路1188号浦江智谷8号楼2层A座Tel：+86-021-54222601Fax：+86-021-54326440	第一章概述	1.1目标读者	1.2本文档适用范围	1.3ExchangeServer数据容灾功能模块简介	第二章ExchangeServer基础知识简介	1	2.1关键技术原理	2.1.1VSS快照技术	2.1.2Exchange事务日志记录	2.1.3备份类型	2.1.4ExchangeServer2007/2010备份方式	2.1.5ExchangeServer2010DAG的备份恢复	第三章ExchangeServer数据容灾最佳实践	3.1ExchangeServerforWindows备份最佳实践	3.1.1部署注意事项（包括客户端安装、环境配置等前期准备工作）	3.1.2定时备份最佳操作	3.2ExchangeServerforWindows恢复最佳实践	3.2.1恢复注意事项	3.2.2恢复最佳操作	3.3FAQ